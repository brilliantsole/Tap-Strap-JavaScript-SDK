/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
function t(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)}function e(t,e,i,s,n){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?n.call(t,i):n?n.value=i:e.set(t,i),i}"function"==typeof SuppressedError&&SuppressedError;const i=!1,s="undefined"!=typeof window&&void 0!==window?.document,n="undefined"!=typeof process&&null!=process?.versions?.node,r=s&&navigator.userAgent||"";let a=!1;s?a=Boolean(navigator.bluetooth):n&&(a=!0);const o=s&&/Bluefy/i.test(r),c=s&&/WebBLE/i.test(r),h=s&&/Android/i.test(r),l=s&&/Safari/i.test(r)&&!/Chrome/i.test(r),u=s&&/iPad|iPhone|iPod/i.test(r),d=s&&/Macintosh/i.test(r),f=!s&&!n&&"undefined"!=typeof global&&"undefined"!=typeof Studio;var g,v,m,p,w=Object.freeze({__proto__:null,isAndroid:h,get isBluetoothSupported(){return a},isIOS:u,isInBluefy:o,isInBrowser:s,isInDev:i,isInLensStudio:f,isInNode:n,isInProduction:!0,isInWebBLE:c,isMac:d,isSafari:l});if(f){const t=function(...t){Studio.log(t.map((t=>new String(t))).join(","))};(p={}).log=t,p.warn=t.bind(p,"WARNING"),p.error=t.bind(p,"ERROR")}else p=console;if(!p.assert){const t=(t,...e)=>{t||p.warn(...e)};p.assert=t}if(!p.table){const t=(...t)=>{p.log(...t)};p.table=t}function y(){}const b=p.log.bind(p),M=p.warn.bind(p),E=p.error.bind(p),D=p.table.bind(p),S=p.assert.bind(p);class C{constructor(e){if(m.set(this,{log:i,warn:i,assert:!0,error:!0,table:!0}),t(g,g,"f",v)[e])throw new Error(`"${e}" console already exists`);t(g,g,"f",v)[e]=this}setLevelFlags(e){Object.assign(t(this,m,"f"),e)}static setLevelFlagsForType(e,i){if(!t(this,g,"f",v)[e])throw new Error(`no console found with type "${e}"`);t(this,g,"f",v)[e].setLevelFlags(i)}static setAllLevelFlags(e){for(const i in t(this,g,"f",v))t(this,g,"f",v)[i].setLevelFlags(e)}static create(e,i){return t(this,g,"f",v)[e]||new g(e)}get log(){return t(this,m,"f").log?b:y}get warn(){return t(this,m,"f").warn?M:y}get error(){return t(this,m,"f").error?E:y}get assert(){return t(this,m,"f").assert?S:y}get table(){return t(this,m,"f").table?D:y}assertWithError(t,e){if(!Boolean(t))throw new Error(e)}assertTypeWithError(t,e){this.assertWithError(typeof t==e,`value ${t} of type "${typeof t}" not of type "${e}"`)}assertEnumWithError(t,e){this.assertWithError(e.includes(t),`invalid enum "${t}"`)}}function k(t,e){return C.create(t,e)}function W(t,e){C.setLevelFlagsForType(t,e)}function x(t){C.setAllLevelFlags(t)}g=C,m=new WeakMap,v={value:{}};const A=k("EventDispatcher",{log:!1});class I{constructor(t,e){this.target=t,this.validEventTypes=e,this.listeners={},this.addEventListener=this.addEventListener.bind(this),this.removeEventListener=this.removeEventListener.bind(this),this.removeEventListeners=this.removeEventListeners.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.dispatchEvent=this.dispatchEvent.bind(this),this.waitForEvent=this.waitForEvent.bind(this)}isValidEventType(t){return this.validEventTypes.includes(t)}updateEventListeners(t){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter((e=>(e.shouldRemove&&A.log(`removing "${t}" eventListener`,e),!e.shouldRemove))))}addEventListener(t,e,i={once:!1}){if(!this.isValidEventType(t))throw new Error(`Invalid event type: ${t}`);this.listeners[t]||(this.listeners[t]=[],A.log(`creating "${t}" listeners array`,this.listeners[t]));this.listeners[t].find((t=>t.listener==e&&t.once==i.once))?A.log("already added listener"):(A.log(`adding "${t}" listener`,e,i),this.listeners[t].push({listener:e,once:i.once}),A.log(`currently have ${this.listeners[t].length} "${t}" listeners`))}removeEventListener(t,e){if(!this.isValidEventType(t))throw new Error(`Invalid event type: ${t}`);this.listeners[t]&&(A.log(`removing "${t}" listener...`,e),this.listeners[t].forEach((i=>{i.listener===e&&(A.log(`flagging "${t}" listener`,e),i.shouldRemove=!0)})),this.updateEventListeners(t))}removeEventListeners(t){if(!this.isValidEventType(t))throw new Error(`Invalid event type: ${t}`);this.listeners[t]&&(A.log(`removing "${t}" listeners...`),this.listeners[t]=[])}removeAllEventListeners(){A.log("removing listeners..."),this.listeners={}}dispatchEvent(t,e){if(!this.isValidEventType(t))throw new Error(`Invalid event type: ${t}`);this.listeners[t]&&(this.listeners[t].forEach((i=>{i.shouldRemove||(A.log(`dispatching "${t}" listener`,i),i.listener({type:t,target:this.target,message:e}),i.once&&(A.log(`flagging "${t}" listener`,i),i.shouldRemove=!0))})),this.updateEventListeners(t))}waitForEvent(t){return new Promise((e=>{this.addEventListener(t,(t=>{e(t)}),{once:!0})}))}}var R,L,T;const $=k("Timer",{log:!1});class O{get callback(){return t(this,R,"f")}set callback(t){$.assertTypeWithError(t,"function"),$.log({newCallback:t}),e(this,R,t,"f"),this.isRunning&&this.restart()}get interval(){return t(this,L,"f")}set interval(t){$.assertTypeWithError(t,"number"),$.assertWithError(t>0,"interval must be above 0"),$.log({newInterval:t}),e(this,L,t,"f"),this.isRunning&&this.restart()}constructor(t,e){R.set(this,void 0),L.set(this,void 0),T.set(this,void 0),this.interval=e,this.callback=t}get isRunning(){return null!=t(this,T,"f")}start(i=!1){this.isRunning?$.log("interval already running"):($.log("starting interval"),e(this,T,setInterval(t(this,R,"f"),t(this,L,"f")),"f"),i&&t(this,R,"f").call(this))}stop(){this.isRunning?($.log("stopping interval"),clearInterval(t(this,T,"f")),e(this,T,void 0,"f")):$.log("interval already not running")}restart(t=!1){this.stop(),this.start(t)}}var U,G;R=new WeakMap,L=new WeakMap,T=new WeakMap,U="undefined"==typeof TextEncoder?class{encode(t){const e=Array.from(t).map((t=>t.charCodeAt(0)));return Uint8Array.from(e)}}:TextEncoder,G="undefined"==typeof TextDecoder?class{decode(t){return Array.from(new Uint8Array(t)).map((t=>String.fromCharCode(t))).join("")}}:TextDecoder;const B=new U,z=new G;var F,N,j,V,_;const P=k("DeviceInformationManager",{log:!0}),q=["manufacturerName","modelNumber","softwareRevision","hardwareRevision","firmwareRevision","pnpId","serialNumber"],Q=[...q,"deviceInformation"];class J{constructor(){F.add(this),j.set(this,{})}get information(){return t(this,j,"f")}clear(){e(this,j,{},"f")}parseMessage(e,i){switch(P.log({messageType:e}),e){case"manufacturerName":const s=z.decode(i.buffer);P.log({manufacturerName:s}),t(this,F,"m",_).call(this,{manufacturerName:s});break;case"modelNumber":const n=z.decode(i.buffer);P.log({modelNumber:n}),t(this,F,"m",_).call(this,{modelNumber:n});break;case"softwareRevision":const r=z.decode(i.buffer);P.log({softwareRevision:r}),t(this,F,"m",_).call(this,{softwareRevision:r});break;case"hardwareRevision":const a=z.decode(i.buffer);P.log({hardwareRevision:a}),t(this,F,"m",_).call(this,{hardwareRevision:a});break;case"firmwareRevision":const o=z.decode(i.buffer);P.log({firmwareRevision:o}),t(this,F,"m",_).call(this,{firmwareRevision:o});break;case"pnpId":const c={source:1===i.getUint8(0)?"Bluetooth":"USB",productId:i.getUint16(3,!0),productVersion:i.getUint16(5,!0),vendorId:0};"Bluetooth"==c.source&&(c.vendorId=i.getUint16(1,!0)),P.log({pnpId:c}),t(this,F,"m",_).call(this,{pnpId:c});break;case"serialNumber":const h=z.decode(i.buffer);P.log({serialNumber:h});break;default:throw Error(`uncaught messageType ${e}`)}}}j=new WeakMap,F=new WeakSet,N=function(){return this.eventDispatcher.dispatchEvent},V=function(){return q.every((e=>{switch(e){case"modelNumber":case"serialNumber":return!0;default:return e in t(this,j,"f")}}))},_=function(e){P.log({partialDeviceInformation:e});Object.keys(e).forEach((i=>{t(this,F,"a",N).call(this,i,{[i]:e[i]})})),Object.assign(t(this,j,"f"),e),P.log({deviceInformation:t(this,j,"f")}),t(this,F,"a",V)&&(P.log("completed deviceInformation"),t(this,F,"a",N).call(this,"deviceInformation",{deviceInformation:this.information}))};function K(t,{include:e,exclude:i}={}){const s=t=>{const s=e=>"string"==typeof e?t===e:e.test(t);return e?e.some(s):!i||!i.some(s)};for(const[e,i]of(t=>{const e=new Set;do{for(const i of Reflect.ownKeys(t))e.add([t,i])}while((t=Reflect.getPrototypeOf(t))&&t!==Object.prototype);return e})(t.constructor.prototype)){if("constructor"===i||!s(i))continue;const n=Reflect.getOwnPropertyDescriptor(e,i);n&&"function"==typeof n.value&&(t[i]=t[i].bind(t))}return t}const X={oneFingerUp:2,twoFingersUp:3,oneFingerDown:4,twoFingersDown:5,oneFingerLeft:6,twoFingersLeft:7,oneFingerRight:8,twoFingersRight:9,indexToThumbTouch:10,middleToThumbTouch:11,xrAirGestureNone:100,xrAirGestureThumbIndex:101,xrAirGestureThumbMiddle:102},H={};Object.keys(X).forEach((t=>{H[X[t]]=t}));const Y={clickIndex:1,clickMiddle:2,dragIndex:3,dragMiddle:4,drop:5,potentialDragOrClickIndex:6,potentialDragOrClickMiddle:7},Z={};var tt,et,it;Object.keys(Y).forEach((t=>{Z[Y[t]]=t}));const st=k("TapDataManager"),nt=["tapData"],rt=[...nt,"tapAirGesture"],at=["thumb","index","middle","ring","pinky"];class ot{constructor(){tt.add(this),this.isInAirGestureState=!1,K(this)}parseMessage(e,i){if(st.log({messageType:e}),"tapData"!==e)throw Error(`uncaught messageType ${e}`);t(this,tt,"m",it).call(this,i)}}var ct,ht,lt;tt=new WeakSet,et=function(){return this.eventDispatcher.dispatchEvent},it=function(e){st.log("parsing tap data",e);const i=e.getUint8(0);if(this.isInAirGestureState){const e=function(t){switch(t){case 2:return"indexToThumbTouch";case 4:return"middleToThumbTouch"}}(i);st.log({tapAirGesture:e}),e&&t(this,tt,"a",et).call(this,"tapAirGesture",{tapAirGesture:e})}else{let s;if(e.byteLength>=4){const t=e.getUint8(3);s={shiftState:3&t,switchState:t>>2&3,multitap:Math.min(1+(t>>4&3),3)}}const n={},r=[];st.log("fingerBits",i.toString(2)),at.forEach(((t,e)=>{n[t]=!!(i&1<<e),n[t]&&r.push(t)})),st.log("fingers",n),t(this,tt,"a",et).call(this,"tapData",{fingers:n,keyboardState:s,fingerArray:r})}};const ut=k("MouseDataManager"),dt=["mouseData"],ft=[...dt];class gt{constructor(){ct.add(this),K(this)}parseMessage(e,i){if(ut.log({messageType:e}),"mouseData"!==e)throw Error(`uncaught messageType ${e}`);t(this,ct,"m",lt).call(this,i)}}var vt,mt,pt,wt,yt,bt;ct=new WeakSet,ht=function(){return this.eventDispatcher.dispatchEvent},lt=function(e){ut.log("parsing mouse data",e);if(0!=e.getUint8(0))return;const i={x:e.getInt16(1,!0),y:-e.getInt16(3,!0)},s=1==e.getUint8(9);t(this,ct,"a",ht).call(this,"mouseData",{velocity:i,isMouse:s})};const Mt=k("AirGestureManager"),Et=["airGesture"],Dt=[...Et,"isInAirGestureState","xrAirGesture"];class St{constructor(){vt.add(this),pt.set(this,!1),yt.set(this,void 0),this.xrAirGestureCount=0,this.xrAirGestureMinCount=1,K(this)}get isInState(){return t(this,pt,"f")}parseMessage(e,i){if(Mt.log({messageType:e}),"airGesture"!==e)throw Error(`uncaught messageType ${e}`);t(this,vt,"m",bt).call(this,i)}}pt=new WeakMap,yt=new WeakMap,vt=new WeakSet,mt=function(){return this.eventDispatcher.dispatchEvent},wt=function(i){e(this,pt,i,"f"),Mt.log("isInAirGestureState",t(this,pt,"f")),t(this,vt,"a",mt).call(this,"isInAirGestureState",{isInAirGestureState:t(this,pt,"f")})},bt=function(i){Mt.log("parsing air gesture",i);const s=i.getUint8(0);if(20==s){const e=i.getUint8(1);t(this,vt,"m",wt).call(this,1==e)}else{let i=H[s];if(Mt.log({airGesture:i}),i)i.startsWith("xrAirGesture")?(i==t(this,yt,"f")?this.xrAirGestureCount++:(this.xrAirGestureCount=1,e(this,yt,i,"f")),this.xrAirGestureCount>=this.xrAirGestureMinCount&&t(this,vt,"a",mt).call(this,"airGesture",{airGesture:i})):t(this,vt,"a",mt).call(this,"airGesture",{airGesture:i});else{const e=Z[s];Mt.log({xrAirGesture:e}),e&&t(this,vt,"a",mt).call(this,"xrAirGesture",{xrAirGesture:e})}}};const Ct=k("RawSensorUtils"),kt=["deviceAccelerometer","imuGyroscope","imuAccelerometer"],Wt={deviceAccelerometer:[31.25,3.90625,7.8125,15.625,31.25],imuGyroscope:[17.5,4.375,8.75,17.5,35,70],imuAccelerometer:[.122,.061,.122,.244,.488]},xt={deviceAccelerometer:0,imuGyroscope:0,imuAccelerometer:0},At={imu:12,device:30};function It(t,e){const i=Wt[t][e];Ct.assertWithError(null!=i,`invalid RawSensorSensitivity index ${e} for sensor "${t}" (got value ${i})`)}const Rt=["gyroscope","accelerometer"],Lt=["thumb","index","middle","ring","pinky"],Tt=k("ArrayBufferUtils",{log:!1});function $t(...t){const e=(t=(t=(t=t.filter((t=>null!=t||null!=t))).map((t=>{if("number"==typeof t){const e=t;return Uint8Array.from([Math.floor(e)])}if("boolean"==typeof t){const e=t;return Uint8Array.from([e?1:0])}if("string"==typeof t){return Ot(t)}if(t instanceof Array){return $t(...t)}if(t instanceof ArrayBuffer)return t;if("buffer"in t&&t.buffer instanceof ArrayBuffer){return t.buffer}if(t instanceof DataView){return t.buffer}if("object"==typeof t){return function(t){return Ot(JSON.stringify(t))}(t)}return t}))).filter((t=>t&&"byteLength"in t))).reduce(((t,e)=>t+e.byteLength),0),i=new Uint8Array(e);let s=0;return t.forEach((t=>{i.set(new Uint8Array(t),s),s+=t.byteLength})),i.buffer}function Ot(t){const e=B.encode(t);return $t(e.byteLength,e)}function Ut(t,e,i){let s;return null!=i&&(s=t.byteOffset+e+i),Tt.log({dataView:t,begin:e,end:s,length:i}),new DataView(t.buffer.slice(t.byteOffset+e,s))}var Gt,Bt,zt,Ft;function Nt(){return Bt?Gt:(Bt=1,Gt=function(t,e){const i=(e=e||{}).kp||1,s=e.ki||0;let n=1/(1e3/t),r=!0!==e.doInitialisation,a=2*i;const o=2*s;let c=1,h=0,l=0,u=0,d=0,f=0,g=0;function v(t,e,i,s,n,r){return{x:e*r-i*n,y:i*s-t*r,z:t*n-e*s}}function m(t,e,i,s,n,a){const o=function(t,e,i,s,n,r){const a=-Math.atan2(t,Math.sqrt(e*e+i*i)),o=v(t,e,i,1,0,0),c=v(1,0,0,o.x,o.y,o.z),h=Math.atan2(c.y,c.z),l=Math.cos(h),u=Math.sin(a),d=Math.sin(h),f=n*l-r*d,g=s*Math.cos(a)+n*d*u+r*l*u;return{heading:-Math.atan2(f,g),pitch:a,roll:h}}(t,e,i,s,n,a),d=function(t){const e=Math.cos(.5*t.heading),i=Math.sin(.5*t.heading),s=Math.cos(.5*t.pitch),n=Math.sin(.5*t.pitch),r=Math.cos(.5*t.roll),a=Math.sin(.5*t.roll);return{w:r*s*e+a*n*i,x:a*s*e-r*n*i,y:r*n*e+a*s*i,z:r*s*i-a*n*e}}(o),f=(d.w*d.w+d.x*d.x+d.y*d.y+d.z*d.z)**-.5;c=d.w*f,h=d.x*f,l=d.y*f,u=d.z*f,r=!0}return{update:function(t,e,i,s,v,p,w,y,b,M){let E,D,S,C,k,W,x,A,I,R,L,T,$,O,U,G,B,z,F,N,j,V,_,P;if(n=M||n,r||m(s,v,p,w,y,b),void 0===w||void 0===y||void 0===b||0===w&&0===y&&0===b)return void function(t,e,i,s,r,v){let m,p,w,y,b,M,E;0!==s&&0!==r&&0!==v&&(m=(s*s+r*r+v*v)**-.5,p=h*u-c*l,w=c*h+l*u,y=c*c-.5+u*u,b=(r*=m)*y-(v*=m)*w,M=v*p-(s*=m)*y,E=s*w-r*p,o>0?(d+=o*b*n,f+=o*M*n,g+=o*E*n,t+=d,e+=f,i+=g):(d=0,f=0,g=0),t+=a*b,e+=a*M,i+=a*E);const D=c,S=h,C=l;c+=-S*(t*=.5*n)-C*(e*=.5*n)-u*(i*=.5*n),h+=D*t+C*i-u*e,l+=D*e-S*i+u*t,u+=D*i+S*e-C*t,m=(c*c+h*h+l*l+u*u)**-.5,c*=m,h*=m,l*=m,u*=m}(t,e,i,s,v,p);0!==s&&0!==v&&0!==p&&(E=(s*s+v*v+p*p)**-.5,s*=E,v*=E,p*=E,E=(w*w+y*y+b*b)**-.5,D=c*c,S=c*h,C=c*l,k=c*u,W=h*h,x=h*l,A=h*u,I=l*l,R=l*u,L=u*u,T=2*((w*=E)*(.5-I-L)+(y*=E)*(x-k)+(b*=E)*(A+C)),$=2*(w*(x+k)+y*(.5-W-L)+b*(R-S)),O=Math.sqrt(T*T+$*$),U=2*(w*(A-C)+y*(R+S)+b*(.5-W-I)),G=A-C,B=S+R,z=D-.5+L,F=O*(.5-I-L)+U*(A-C),N=O*(x-k)+U*(S+R),j=O*(C+A)+U*(.5-W-I),V=v*z-p*B+(y*j-b*N),_=p*G-s*z+(b*F-w*j),P=s*B-v*G+(w*N-y*F),o>0?(d+=o*V*n,f+=o*_*n,g+=o*P*n,t+=d,e+=f,i+=g):(d=0,f=0,g=0),t+=a*V,e+=a*_,i+=a*P);const q=c,Q=h,J=l;c+=-Q*(t*=.5*n)-J*(e*=.5*n)-u*(i*=.5*n),h+=q*t+J*i-u*e,l+=q*e-Q*i+u*t,u+=q*i+Q*e-J*t,E=(c*c+h*h+l*l+u*u)**-.5,c*=E,h*=E,l*=E,u*=E},init:m,getQuaternion:()=>({w:c,x:h,y:l,z:u})}})}function jt(){return Ft?zt:(Ft=1,zt=function(t,e){const i=1e3/t;let s=(e=e||{}).beta||.4,n=!0!==e.doInitialisation,r=1,a=0,o=0,c=0,h=1/i;function l(t,e,i,s,n,r){return{x:e*r-i*n,y:i*s-t*r,z:t*n-e*s}}function u(t,e,i,s,h,u){const d=function(t,e,i,s,n,r){const a=-Math.atan2(t,Math.sqrt(e*e+i*i)),o=l(t,e,i,1,0,0),c=l(1,0,0,o.x,o.y,o.z),h=Math.atan2(c.y,c.z),u=Math.cos(h),d=Math.sin(a),f=Math.sin(h),g=n*u-r*f,v=s*Math.cos(a)+n*f*d+r*u*d;return{heading:-Math.atan2(g,v),pitch:a,roll:h}}(t,e,i,s,h,u),f=function(t){const e=Math.cos(.5*t.heading),i=Math.sin(.5*t.heading),s=Math.cos(.5*t.pitch),n=Math.sin(.5*t.pitch),r=Math.cos(.5*t.roll),a=Math.sin(.5*t.roll);return{w:r*s*e+a*n*i,x:a*s*e-r*n*i,y:r*n*e+a*s*i,z:r*s*i-a*n*e}}(d),g=(f.w*f.w+f.x*f.x+f.y*f.y+f.z*f.z)**-.5;r=f.w*g,a=f.x*g,o=f.y*g,c=f.z*g,n=!0}return{update:function(t,e,i,l,d,f,g,v,m,p){let w,y,b,M,E,D,S,C,k,W,x,A,I,R,L,T,$,O,U,G,B,z,F,N,j,V,_,P,q,Q,J,K,X,H,Y;h=p||h,n||u(l,d,f,g,v,m),void 0===g||void 0===v||void 0===m||0===g&&0===v&&0===m?function(t,e,i,n,l,u){let d,f,g,v,m,p,w,y,b,M,E,D,S,C,k,W,x,A,I,R,L,T;p=.5*(-a*t-o*e-c*i),w=.5*(r*t+o*i-c*e),y=.5*(r*e-a*i+c*t),b=.5*(r*i+a*e-o*t),0===n&&0===l&&0===u||(d=(n*n+l*l+u*u)**-.5,M=2*r,E=2*a,D=2*o,S=2*c,C=4*r,k=4*a,W=4*o,x=8*a,A=8*o,I=r*r,R=a*a,L=o*o,T=c*c,f=C*L+D*(n*=d)+C*R-E*(l*=d),g=k*T-S*n+4*I*a-M*l-k+x*R+x*L+k*(u*=d),v=4*I*o+M*n+W*T-S*l-W+A*R+A*L+W*u,m=4*R*c-E*n+4*L*c-D*l,d=(f*f+g*g+v*v+m*m)**-.5,f*=d,g*=d,v*=d,m*=d,p-=s*f,w-=s*g,y-=s*v,b-=s*m),r+=p*h,a+=w*h,o+=y*h,c+=b*h,d=(r*r+a*a+o*o+c*c)**-.5,r*=d,a*=d,o*=d,c*=d}(t,e,i,l,d,f):(D=.5*(-a*t-o*e-c*i),S=.5*(r*t+o*i-c*e),C=.5*(r*e-a*i+c*t),k=.5*(r*i+a*e-o*t),0===l&&0===d&&0===f||(w=(l*l+d*d+f*f)**-.5,l*=w,d*=w,f*=w,w=(g*g+v*v+m*m)**-.5,A=2*r*(g*=w),I=2*r*(v*=w),R=2*r*(m*=w),L=2*a*g,G=2*r,B=2*a,z=2*o,F=2*c,N=2*r*o,j=2*o*c,V=r*r,_=r*a,P=r*o,q=r*c,Q=a*a,J=a*o,K=a*c,X=o*o,H=o*c,Y=c*c,W=g*V-I*c+R*o+g*Q+B*v*o+B*m*c-g*X-g*Y,x=A*c+v*V-R*a+L*o-v*Q+v*X+z*m*c-v*Y,T=Math.sqrt(W*W+x*x),$=-A*o+I*a+m*V+L*c-m*Q+z*v*c-m*X+m*Y,O=2*T,U=2*$,y=-z*(2*K-N-l)+B*(2*_+j-d)-$*o*(T*(.5-X-Y)+$*(K-P)-g)+(-T*c+$*a)*(T*(J-q)+$*(_+H)-v)+T*o*(T*(P+K)+$*(.5-Q-X)-m),b=F*(2*K-N-l)+G*(2*_+j-d)-4*a*(1-2*Q-2*X-f)+$*c*(T*(.5-X-Y)+$*(K-P)-g)+(T*o+$*r)*(T*(J-q)+$*(_+H)-v)+(T*c-U*a)*(T*(P+K)+$*(.5-Q-X)-m),M=-G*(2*K-N-l)+F*(2*_+j-d)-4*o*(1-2*Q-2*X-f)+(-O*o-$*r)*(T*(.5-X-Y)+$*(K-P)-g)+(T*a+$*c)*(T*(J-q)+$*(_+H)-v)+(T*r-U*o)*(T*(P+K)+$*(.5-Q-X)-m),E=B*(2*K-N-l)+z*(2*_+j-d)+(-O*c+$*a)*(T*(.5-X-Y)+$*(K-P)-g)+(-T*r+$*o)*(T*(J-q)+$*(_+H)-v)+T*a*(T*(P+K)+$*(.5-Q-X)-m),w=(y*y+b*b+M*M+E*E)**-.5,y*=w,b*=w,M*=w,E*=w,D-=s*y,S-=s*b,C-=s*M,k-=s*E),r+=D*h,a+=S*h,o+=C*h,c+=k*h,w=(r*r+a*a+o*o+c*c)**-.5,r*=w,a*=w,o*=w,c*=w)},init:u,getQuaternion:()=>({w:r,x:a,y:o,z:c})}})}const Vt=180/Math.PI;function _t(t){const e=(t=t||{}).sampleInterval||20,i=t.algorithm||"Madgwick";let s;if("Mahony"===i)s=Nt();else{if("Madgwick"!==i)throw new Error(`AHRS(): Algorithm not valid: ${i}`);s=jt()}const n=s(e,t),r=this;Object.keys(n).forEach((t=>r[t]=n[t]))}_t.prototype.toVector=function(){const t=this.getQuaternion(),e=2*Math.acos(t.w),i=Math.sin(e/2);return{angle:e,x:t.x/i,y:t.y/i,z:t.z/i}},_t.prototype.getEulerAngles=function(){const t=this.getQuaternion(),e=t.w*t.w,i=t.x*t.x,s=t.y*t.y,n=t.z*t.z;return{heading:Math.atan2(2*(t.x*t.y+t.z*t.w),i-s-n+e),pitch:-Math.asin(2*(t.x*t.z-t.y*t.w)),roll:Math.atan2(2*(t.y*t.z+t.x*t.w),-i-s+n+e)}},_t.prototype.getEulerAnglesDegrees=function(){const t=this.getEulerAngles();return{heading:t.heading*Vt,pitch:t.pitch*Vt,roll:t.roll*Vt}};var Pt,qt=(Pt=_t)&&Pt.__esModule&&Object.prototype.hasOwnProperty.call(Pt,"default")?Pt.default:Pt;const Qt=Math.PI/180;function Jt(t){return t*Qt}var Kt,Xt,Ht,Yt,Zt,te,ee;const ie=k("RawSensorManager"),se=["rawSensor"],ne=[...se,"imu","device","orientation"];class re{constructor(){Kt.add(this),Ht.set(this,new qt({sampleInterval:18,algorithm:"Madgwick"})),Yt.set(this,0),this.calculateOrientation=!1,K(this)}parseMessage(e,i){if(ie.log({messageType:e}),"rawSensor"!==e)throw Error(`uncaught messageType ${e}`);t(this,Kt,"m",Zt).call(this,i)}clear(){e(this,Yt,0,"f")}}var ae,oe,ce;Ht=new WeakMap,Yt=new WeakMap,Kt=new WeakSet,Xt=function(){return this.eventDispatcher.dispatchEvent},Zt=function(e){ie.log("parsing whole",e);let i=0;for(;i+4<e.byteLength;){const s=e.getUint32(0,!0);i+=4,ie.log({rawValue:s});const n=(2147483648&s)>>31,r=2147483647&s;if(ie.log({firstBit:n,timestamp:r}),0==r)break;const a=0==n?"imu":"device";ie.log({sensorDataType:a});const o=At[a];if(ie.log({sensorDataLength:o}),0==o)break;const c=Ut(e,i,o);c.byteLength==o&&t(this,Kt,"m",te).call(this,a,r,c),i+=o}},te=function(i,s,n){ie.log(`parsing ${i} ${s}ms`,n);let r="device"==i?"deviceAccelerometer":"imuGyroscope";const a=[];for(let t=0;t<n.byteLength;t+=6){const e=this.sensitivity[r],s=Wt[r][e],[o,c,h]=[-n.getInt16(t+0,!0),n.getInt16(t+2,!0),n.getInt16(t+4,!0)].map((t=>t*s*.001));ie.log({x:h,y:c,z:o});const l={x:h,y:c,z:o};ie.log("vector",l),a.push(l),"imu"==i&&(r="imuAccelerometer")}let o=0;switch(i){case"imu":o=2;break;case"device":o=5}if(a.length!=o)return void ie.log(`invalid number of ${i} vectors (expected ${o}, get ${a.length})`);const c={sensorDataType:i,timestamp:s};switch(c.sensorDataType){case"imu":if(c.accelerometer=a[Rt.indexOf("accelerometer")],c.gyroscope=a[Rt.indexOf("gyroscope")],this.calculateOrientation&&t(this,Yt,"f")!=s){e(this,Yt,s,"f");const i=0==t(this,Yt,"f")?55:s-t(this,Yt,"f");t(this,Kt,"m",ee).call(this,c.accelerometer,c.gyroscope,i);const n=t(this,Ht,"f").getQuaternion(),r=t(this,Ht,"f").getEulerAngles();t(this,Kt,"a",Xt).call(this,"orientation",{quaternion:n,euler:r,timestamp:s})}break;case"device":c.fingers={},Lt.forEach(((t,e)=>{c.fingers[t]=a[e]}))}t(this,Kt,"a",Xt).call(this,i,c),t(this,Kt,"a",Xt).call(this,"rawSensor",c)},ee=function(e,i,s){ie.log("updating ahrs..."),t(this,Ht,"f").update(Jt(i.x),Jt(i.y),Jt(i.z),e.x,e.y,e.z,void 0,void 0,void 0,s/1e3)};const he=k("TxManager"),le=["tx",...se],ue=[...ne];class de{get eventDispatcher(){return t(this,oe,"f")}set eventDispatcher(i){e(this,oe,i,"f"),t(this,ce,"f").eventDispatcher=i}set rawSensorSensitivity(e){t(this,ce,"f").sensitivity=e}constructor(){ae.add(this),oe.set(this,void 0),ce.set(this,new re),K(this)}parseMessage(e,i){if(he.log({messageType:e}),"tx"!==e)throw Error(`uncaught messageType ${e}`);t(this,ce,"f").parseMessage("rawSensor",i)}get calculateOrientation(){return t(this,ce,"f").calculateOrientation}set calculateOrientation(e){t(this,ce,"f").calculateOrientation=e}clear(){t(this,ce,"f").clear()}}var fe,ge,ve,me,pe,we,ye,be,Me;oe=new WeakMap,ce=new WeakMap,ae=new WeakSet;const Ee=k("BaseConnectionManager",{log:!0}),De=["notConnected","connecting","connected","disconnecting"],Se=[...De,"connectionStatus","isConnected"];class Ce{get baseConstructor(){return this.constructor}static get isSupported(){return!1}get isSupported(){return this.baseConstructor.isSupported}get type(){return this.baseConstructor.type}constructor(){fe.add(this),ve.set(this,"notConnected"),be.set(this,new O(t(this,fe,"m",Me).bind(this),5e3)),t(this,fe,"m",ge).call(this)}get status(){return t(this,ve,"f")}set status(i){Ee.assertEnumWithError(i,De),t(this,ve,"f")!=i?(Ee.log(`new connection status "${i}"`),e(this,ve,i,"f"),this.onStatusUpdated(this.status),this.isConnected?t(this,be,"f").start():t(this,be,"f").stop()):Ee.log(`tried to assign same connection status "${i}"`)}get isConnected(){return"connected"==this.status}async connect(){t(this,fe,"m",me).call(this),t(this,fe,"m",pe).call(this),this.status="connecting"}get canReconnect(){return!1}async reconnect(){t(this,fe,"m",me).call(this),t(this,fe,"m",pe).call(this),Ee.assert(this.canReconnect,"unable to reconnect")}async disconnect(){t(this,fe,"m",we).call(this),t(this,fe,"m",ye).call(this),this.status="disconnecting",Ee.log("disconnecting from device...")}async sendUICommandsData(t){Ee.log("sendUICommandsData",t)}async sendRxData(t){Ee.log("sendRxData",t)}}ve=new WeakMap,be=new WeakMap,fe=new WeakSet,ge=function(){Ee.assertWithError(this.isSupported,`${this.constructor.name} is not supported`)},me=function(){Ee.assertWithError(!this.isConnected,"device is already connected")},pe=function(){Ee.assertWithError("connecting"!=this.status,"device is already connecting")},we=function(){Ee.assertWithError(this.isConnected,"device is not connected")},ye=function(){Ee.assertWithError("disconnecting"!=this.status,"device is already disconnecting")},Me=function(){this.isConnected||(Ee.log("timer detected disconnection"),this.status="notConnected")};const ke=k("EventUtils",{log:!1});function We(t,e){let i=t.addEventListener||t.addListener||t.on||t.AddEventListener;ke.assertWithError(i,"no add listener function found for target"),i=i.bind(t),Object.entries(e).forEach((([t,e])=>{i(t,e)}))}function xe(t,e){let i=t.removeEventListener||t.removeListener||t.RemoveEventListener;ke.assertWithError(i,"no remove listener function found for target"),i=i.bind(t),Object.entries(e).forEach((([t,e])=>{i(t,e)}))}const Ae=k("bluetoothUUIDs",{log:!1});if(s)var Ie=window.BluetoothUUID;function Re(t){return Ae.assertTypeWithError(t,"string"),Ae.assertWithError(1==t.length,"value must be 1 character long"),`C3FF000${t}-1D8B-40FD-A56F-C7BD5D0F3370`.toLowerCase()}function Le(t){return Ae.assertTypeWithError(t,"string"),Ae.assertWithError(1==t.length,"value must be 1 character long"),`6E40000${t}-B5A3-F393-E0A9-E50E24DCCA9E`.toLowerCase()}function Te(t){return Ie?.getCharacteristic?.(t)}function $e(t){return Ie?.getService?.(t)}const Oe=Object.freeze({services:{deviceInformation:{uuid:$e("device_information"),characteristics:{manufacturerName:{uuid:Te("manufacturer_name_string")},modelNumber:{uuid:Te("model_number_string")},hardwareRevision:{uuid:Te("hardware_revision_string")},firmwareRevision:{uuid:Te("firmware_revision_string")},softwareRevision:{uuid:Te("software_revision_string")},pnpId:{uuid:Te("pnp_id")},serialNumber:{uuid:Te("serial_number_string")}}},battery:{uuid:$e("battery_service"),characteristics:{batteryLevel:{uuid:Te("battery_level")}}},tap:{uuid:Re("1"),characteristics:{tapData:{uuid:Re("5")},mouseData:{uuid:Re("6")},airGesture:{uuid:Re("A")},uiCommands:{uuid:Re("9")},settings:{uuid:Re("2")},unknown3:{uuid:Re("3")},unknown7:{uuid:Re("7")},unknown8:{uuid:Re("8")},unknownB:{uuid:Re("B")},unknownC:{uuid:Re("C")},unknownD:{uuid:Re("D")}}},nus:{uuid:Le("1"),characteristics:{rx:{uuid:Le("2")},tx:{uuid:Le("3")}}}}}),Ue=[Oe.services.tap.uuid],Ge=[Oe.services.deviceInformation.uuid,Oe.services.battery.uuid,Oe.services.nus.uuid];function Be(t){t=t.toString().toLowerCase();return Object.keys(Oe.services).find((e=>{let i=Oe.services[e].uuid.toString();return 4==t.length&&(i=i.slice(4,8)),t.includes("-")||(i=i.replaceAll("-","")),t==i}))}const ze=[],Fe=[];function Ne(t){var e;return t=t.toString().toLowerCase(),Object.values(Oe.services).some((i=>{const s=Object.keys(i.characteristics);return e=s.find((e=>{let s=i.characteristics[e].uuid.toString();return 4==t.length&&(s=s.slice(4,8)),t.includes("-")||(s=s.replaceAll("-","")),t==s}))})),e}function je(t){const e={broadcast:!1,read:!0,writeWithoutResponse:!1,write:!1,notify:!1,indicate:!1,authenticatedSignedWrites:!1,reliableWrite:!1,writableAuxiliaries:!1};switch(t){case"settings":case"tapData":case"mouseData":case"unknown7":case"unknown8":e.read=!1}switch(t){case"batteryLevel":case"tapData":case"mouseData":case"airGesture":case"unknown8":case"unknownB":case"unknownC":case"unknownD":case"tx":e.notify=!0}switch(t){case"airGesture":case"uiCommands":case"unknown7":case"unknownB":e.writeWithoutResponse=!0}switch(t){case"settings":case"unknown3":case"unknown7":case"rx":e.write=!0}return e}Object.values(Oe.services).forEach((t=>{if(!t.characteristics)return;const e=Object.keys(t.characteristics);e.forEach((i=>{const s=t.characteristics[i];Ue.includes(t.uuid)&&(ze.push(s.uuid),e.push(i)),Fe.push(s.uuid)}))}),[]),Ae.log({serviceUUIDs:Ue,optionalServiceUUIDs:Ge,characteristicUUIDs:ze,allCharacteristicUUIDs:Fe});const Ve=k("BluetoothConnectionManager",{log:!0});class _e extends Ce{constructor(){super(...arguments),this.isInRange=!0}onCharacteristicValueChanged(t,e){switch(t){case"batteryLevel":case"firmwareRevision":case"hardwareRevision":case"manufacturerName":case"modelNumber":case"pnpId":case"serialNumber":case"softwareRevision":case"tapData":case"mouseData":case"airGesture":case"tx":this.onMessageReceived?.(t,e)}}async writeCharacteristic(t,e){Ve.log("writeCharacteristic",...arguments)}async sendUICommandsData(t){super.sendUICommandsData(t),await this.writeCharacteristic("uiCommands",t)}async sendRxData(t){super.sendRxData(t),await this.writeCharacteristic("rx",t)}}var Pe,qe,Qe,Je,Ke,Xe,He,Ye,Ze,ti,ei;const ii=k("WebBluetoothConnectionManager",{log:!0});var si,ni,ri;s&&(si=window.navigator.bluetooth);class ai extends _e{constructor(){super(...arguments),Pe.add(this),qe.set(this,{characteristicvaluechanged:t(this,Pe,"m",Ze).bind(this)}),Qe.set(this,{gattserverdisconnected:t(this,Pe,"m",ei).bind(this)}),Je.set(this,void 0),Ke.set(this,new Map),Xe.set(this,new Map)}get bluetoothId(){return this.device?.id||""}get name(){return this.device?.name||""}static get isSupported(){return Boolean(si)}static get type(){return"webBluetooth"}get device(){return t(this,Je,"f")}set device(i){t(this,Je,"f")!=i?(t(this,Je,"f")&&xe(t(this,Je,"f"),t(this,Qe,"f")),i&&We(i,t(this,Qe,"f")),e(this,Je,i,"f")):ii.log("tried to assign the same BluetoothDevice")}get server(){return t(this,Je,"f")?.gatt}get isConnected(){return this.server?.connected||!1}async connect(){await super.connect();try{const e=await si.requestDevice({filters:[{services:Ue}],optionalServices:s?Ge:[]});ii.log("got BluetoothDevice"),this.device=e,ii.log("connecting to device...");const i=await this.server.connect();ii.log(`connected to device? ${i.connected}`),await t(this,Pe,"m",He).call(this),ii.log("fully connected"),this.status="connected"}catch(e){ii.error(e),this.status="notConnected",this.server?.disconnect(),t(this,Pe,"m",Ye).call(this)}}async disconnect(){await t(this,Pe,"m",Ye).call(this),await super.disconnect(),this.server?.disconnect(),this.status="notConnected"}async writeCharacteristic(e,i){super.writeCharacteristic(e,i);const s=t(this,Xe,"f").get(e);ii.assertWithError(s,`${e} characteristic not found`),ii.log("writing characteristic",s,i);const n=s.properties||je(e);n.writeWithoutResponse?(ii.log("writing without response"),await s.writeValueWithoutResponse(i)):(ii.log("writing with response"),await s.writeValueWithResponse(i)),ii.log("wrote characteristic"),n.read&&!n.notify&&(ii.log("reading value after write..."),await s.readValue(),(o||c)&&t(this,Pe,"m",ti).call(this,s))}get canReconnect(){return Boolean(this.server&&!this.server.connected&&this.isInRange)}async reconnect(){await super.reconnect(),ii.log("attempting to reconnect..."),this.status="connecting";try{await this.server.connect()}catch(t){ii.error(t),this.isInRange=!1}this.isConnected?(ii.log("successfully reconnected!"),await t(this,Pe,"m",He).call(this),this.status="connected"):(ii.log("unable to reconnect"),this.status="notConnected")}}function oi(t,e=0,i=1){return Math.max(e,Math.min(i,t))}qe=new WeakMap,Qe=new WeakMap,Je=new WeakMap,Ke=new WeakMap,Xe=new WeakMap,Pe=new WeakSet,He=async function(){t(this,Pe,"m",Ye).call(this),ii.log("getting services...");const e=await this.server.getPrimaryServices();ii.log("got services",e);const i=await this.server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");ii.log("got nus service",i),ii.log("getting characteristics...");for(const i in e){const s=e[i];ii.log({service:s});const n=Be(s.uuid);ii.assertWithError(n,`no name found for service uuid "${s.uuid}"`),ii.log(`got "${n}" service`),s.name=n,t(this,Ke,"f").set(n,s),ii.log(`getting characteristics for "${n}" service`);const r=await s.getCharacteristics();ii.log(`got characteristics for "${n}" service`);for(const e in r){const i=r[e];ii.log({characteristic:i});const s=Ne(i.uuid);ii.assertWithError(Boolean(s),`no name found for characteristic uuid "${i.uuid}" in "${n}" service`),ii.log(`got "${s}" characteristic in "${n}" service`),i.name=s,t(this,Xe,"f").set(s,i),We(i,t(this,qe,"f"));const a=i.properties||je(s);a.notify&&(ii.log(`starting notifications for "${s}" characteristic`),await i.startNotifications()),a.read&&(ii.log(`reading "${s}" characteristic...`),await i.readValue(),(o||c)&&t(this,Pe,"m",ti).call(this,i))}}},Ye=async function(){this.device&&xe(this.device,t(this,Qe,"f"));const e=Array.from(t(this,Xe,"f").keys()).map((e=>{const i=t(this,Xe,"f").get(e);xe(i,t(this,qe,"f"));if((i.properties||je(e)).notify)return ii.log(`stopping notifications for "${e}" characteristic`),i.stopNotifications()}));return Promise.allSettled(e)},Ze=function(e){ii.log("oncharacteristicvaluechanged");const i=e.target;t(this,Pe,"m",ti).call(this,i)},ti=function(t){ii.log("onCharacteristicValue");const e=t.name;ii.assertWithError(Boolean(e),`no name found for characteristic with uuid "${t.uuid}"`),ii.log(`oncharacteristicvaluechanged for "${e}" characteristic`);const i=t.value;ii.assertWithError(i,`no data found for "${e}" characteristic`),ii.log(`data for "${e}" characteristic`,Array.from(new Uint8Array(i.buffer)));try{this.onCharacteristicValueChanged(e,i)}catch(t){ii.error(t)}},ei=function(){ii.log("gattserverdisconnected"),this.status="notConnected"},k("MathUtils",{log:!0});const ci=k("VibrationManager"),hi=9,li=18;class ui{constructor(){ni.add(this),K(this)}async vibrate(e){ci.log("triggering vibration segments",e);const i=t(this,ni,"m",ri).call(this,e);await this.sendUICommandsData(i?.buffer)}}var di,fi,gi,vi,mi,pi,wi,yi,bi,Mi,Ei,Di,Si,Ci,ki,Wi;ni=new WeakSet,ri=function(t){const e=new DataView(new ArrayBuffer(20));let i=0;e.setUint8(i++,0),e.setUint8(i++,2);for(let i=0;i<t.length&&i<18;i++){let s=t[i];s/=10,s=oi(s,0,255),ci.log(`vibration segment #${i}: ${s}`),e.setUint8(2+i,s)}return e};const xi=k("DeviceManager",{log:!0}),Ai=["deviceConnected","deviceDisconnected","deviceIsConnected","availableDevices","connectedDevices"];class Ii{constructor(){if(di.add(this),fi.set(this,{isConnected:t(this,di,"m",Ci).bind(this)}),gi.set(this,[]),vi.set(this,!1),mi.set(this,{devices:[]}),pi.set(this,void 0),yi.set(this,"TS.Device"),Ei.set(this,[]),Di.set(this,new I(this,Ai)),Ii.shared&&this!=Ii.shared)throw Error("DeviceManager is a singleton - use DeviceManager.shared");this.CanUseLocalStorage&&(this.UseLocalStorage=!0)}onDevice(e){We(e,t(this,fi,"f"))}OnDeviceConnectionStatusUpdated(e,i){if("notConnected"==i&&!e.canReconnect&&t(this,Ei,"f").includes(e)){const i=t(this,Ei,"f").indexOf(e);this.AvailableDevices.splice(i,1),t(this,di,"m",ki).call(this)}}get ConnectedDevices(){return t(this,gi,"f")}get UseLocalStorage(){return t(this,vi,"f")}set UseLocalStorage(i){t(this,di,"m",wi).call(this),xi.assertTypeWithError(i,"boolean"),e(this,vi,i,"f"),t(this,vi,"f")&&!t(this,pi,"f")&&t(this,di,"m",Mi).call(this)}get CanUseLocalStorage(){return s&&window.localStorage}get AvailableDevices(){return t(this,Ei,"f")}get CanGetDevices(){return s&&navigator.bluetooth?.getDevices}async GetDevices(){if(!s)return void xi.warn("GetDevices is only available in the browser");if(!navigator.bluetooth)return void xi.warn("bluetooth is not available in this browser");if(o)return void xi.warn("bluefy lists too many devices...");if(!navigator.bluetooth.getDevices)return void xi.warn("bluetooth.getDevices() is not available in this browser");if(!this.CanGetDevices)return void xi.log("CanGetDevices is false");t(this,pi,"f")||t(this,di,"m",Mi).call(this);const e=t(this,pi,"f");if(!e.devices||0==e.devices.length)return void xi.log("no devices found in configuration");const i=await navigator.bluetooth.getDevices();return xi.log({bluetoothDevices:i}),i.forEach((i=>{if(!i.gatt)return;if(!e.devices.find((t=>i.id==t.bluetoothId)))return;let s=this.ConnectedDevices.filter((t=>"webBluetooth"==t.connectionType)).find((t=>t.bluetoothId==i.id));const n=this.AvailableDevices.filter((t=>"webBluetooth"==t.connectionType)).find((t=>t.bluetoothId==i.id));if(n)return void(s&&s?.bluetoothId==n.bluetoothId&&s!=n&&(this.AvailableDevices[t(this,Ei,"f").indexOf(n)]=s));if(s)return void this.AvailableDevices.push(s);const r=new Ls,a=new ai;a.device=i,i.name,r.connectionManager=a,this.AvailableDevices.push(r)})),t(this,di,"m",ki).call(this),this.AvailableDevices}get AddEventListener(){return t(this,Di,"f").addEventListener}get RemoveEventListener(){return t(this,Di,"f").removeEventListener}get RemoveEventListeners(){return t(this,Di,"f").removeEventListeners}get RemoveAllEventListeners(){return t(this,Di,"f").removeAllEventListeners}}fi=new WeakMap,gi=new WeakMap,vi=new WeakMap,mi=new WeakMap,pi=new WeakMap,yi=new WeakMap,Ei=new WeakMap,Di=new WeakMap,di=new WeakSet,wi=function(){xi.assertWithError(s,"localStorage is only available in the browser"),xi.assertWithError(window.localStorage,"localStorage not found")},bi=function(){t(this,di,"m",wi).call(this),localStorage.setItem(t(this,yi,"f"),JSON.stringify(t(this,pi,"f")))},Mi=async function(){t(this,di,"m",wi).call(this);let i=localStorage.getItem(t(this,yi,"f"));if("string"!=typeof i)return xi.log("no info found in localStorage"),e(this,pi,Object.assign({},t(this,mi,"f")),"f"),void t(this,di,"m",bi).call(this);try{const t=JSON.parse(i);xi.log({configuration:t}),e(this,pi,t,"f"),this.CanGetDevices&&await this.GetDevices()}catch(t){xi.error(t)}},Si=function(){return t(this,Di,"f").dispatchEvent},Ci=function(e){const{target:i}=e;if(i.isConnected)if(t(this,gi,"f").includes(i))xi.log("device already included");else{if(xi.log("adding device",i),t(this,gi,"f").push(i),this.UseLocalStorage&&"webBluetooth"==i.connectionType){const e={bluetoothId:i.bluetoothId},s=t(this,pi,"f").devices.findIndex((t=>t.bluetoothId==e.bluetoothId));-1==s?t(this,pi,"f").devices.push(e):t(this,pi,"f").devices[s]=e,t(this,di,"m",bi).call(this)}t(this,di,"a",Si).call(this,"deviceConnected",{device:i}),t(this,di,"a",Si).call(this,"deviceIsConnected",{device:i}),t(this,di,"m",Wi).call(this)}else t(this,gi,"f").includes(i)?(xi.log("removing device",i),t(this,gi,"f").splice(t(this,gi,"f").indexOf(i),1),t(this,di,"a",Si).call(this,"deviceDisconnected",{device:i}),t(this,di,"a",Si).call(this,"deviceIsConnected",{device:i}),t(this,di,"m",Wi).call(this)):xi.log("device already not included");if(this.CanGetDevices&&this.GetDevices(),i.isConnected&&!this.AvailableDevices.includes(i)){const e=this.AvailableDevices.find((t=>t.bluetoothId==i.bluetoothId));xi.log({existingAvailableDevice:e}),e?this.AvailableDevices[this.AvailableDevices.indexOf(e)]=i:this.AvailableDevices.push(i),t(this,di,"m",ki).call(this)}},ki=function(){xi.log({AvailableDevices:this.AvailableDevices}),t(this,di,"a",Si).call(this,"availableDevices",{availableDevices:this.AvailableDevices})},Wi=function(){xi.log({ConnectedDevices:this.ConnectedDevices}),t(this,di,"a",Si).call(this,"connectedDevices",{connectedDevices:this.ConnectedDevices})},Ii.shared=new Ii;var Ri,Li,Ti,$i,Oi,Ui,Gi,Bi=Ii.shared;const zi=k("InputManager"),Fi=["controller","text","rawSensor","controllerWithMouse","controllerWithMouseAndKeyboard"],Ni={controller:1,text:0,rawSensor:10,controllerWithMouse:3,controllerWithMouseAndKeyboard:5};class ji{constructor(){Ri.add(this),Li.set(this,Object.assign({},xt)),Ti.set(this,"controller"),Ui.set(this,new O(t(this,Ri,"m",Gi).bind(this),1e4)),K(this)}get sensitivity(){return t(this,Li,"f")}set sensitivity(e){Object.assign(t(this,Li,"f"),e)}setSensitivityForType(e,i){It(e,i),zi.log(`setting ${e} sensitivity index to ${i}`),t(this,Li,"f")[e]=i,t(this,Ui,"f").restart(!0)}get mode(){return t(this,Ti,"f")}set mode(i){t(this,Ri,"m",$i).call(this,i),this.mode!=i?(e(this,Ti,i,"f"),t(this,Ui,"f").isRunning&&t(this,Ui,"f").restart(!0)):zi.log(`redundant mode assignment "${i}"`)}setMode(t){this.mode=t}start(){t(this,Ui,"f").start(!0)}stop(){t(this,Ui,"f").stop()}}var Vi,_i,Pi,qi,Qi,Ji;Li=new WeakMap,Ti=new WeakMap,Ui=new WeakMap,Ri=new WeakSet,$i=function(t){zi.assertEnumWithError(t,Fi)},Oi=function(){const t=Ni[this.mode];let e=[];var i;"rawSensor"==this.mode&&(zi.assertWithError(this.sensitivity,"no sensitivity defined for rawSensor input mode"),i=this.sensitivity,kt.forEach((t=>{It(t,i[t])})),kt.forEach((t=>{e.push(this.sensitivity[t])})));return $t(3,12,0,t,...e)},Gi=function(){zi.log("sending mode data...");const e=t(this,Ri,"m",Oi).call(this);this.sendRxData(e)};const Ki=k("XRStateManager"),Xi=["user","airMouse","tapping","dontSend"],Hi={user:3,airMouse:1,tapping:2};class Yi{constructor(){Vi.add(this),_i.set(this,"user"),Qi.set(this,new O(t(this,Vi,"m",Ji).bind(this),1e4)),K(this)}get state(){return t(this,_i,"f")}set state(i){t(this,Vi,"m",Pi).call(this,i),this.state!=i?(e(this,_i,i,"f"),t(this,Qi,"f").isRunning&&t(this,Qi,"f").restart(!0)):Ki.log(`redundant state assignment "${i}"`)}setState(t){this.state=t}start(){t(this,Qi,"f").start(!0)}stop(){t(this,Qi,"f").stop()}}var Zi,ts,es,is,ss,ns,rs,as,os,cs,hs,ls,us,ds,fs,gs,vs,ms,ps,ws,ys,bs,Ms,Es,Ds,Ss,Cs,ks,Ws,xs,As;_i=new WeakMap,Qi=new WeakMap,Vi=new WeakSet,Pi=function(t){Ki.assertEnumWithError(t,Xi)},qi=function(){const t=Hi[this.state];Ki.assert(null!=t,`no stateByte found for state "${this.state}"`);return $t(3,13,0,t)},Ji=function(){if("dontSend"==this.state)return;Ki.log("sending state data...");const e=t(this,Vi,"m",qi).call(this);this.sendRxData(e)};const Is=k("Device",{log:!0}),Rs=["connectionMessage",...Se,"batteryLevel",...Q,...rt,...ft,...Dt,...ue];class Ls{get bluetoothId(){return t(this,ns,"f")?.bluetoothId}get name(){return t(this,ns,"f")?.name}constructor(){Zi.add(this),is.set(this,new I(this,Rs)),ns.set(this,void 0),this.sendUICommandsData=t(this,Zi,"m",rs).bind(this),this.sendRxData=t(this,Zi,"m",as).bind(this),os.set(this,!1),us.set(this,ts.ReconnectOnDisconnection),ds.set(this,void 0),this.latestConnectionMessage=new Map,ys.set(this,new J),bs.set(this,0),Es.set(this,new ji),Ds.set(this,new Yi),Ss.set(this,new ot),Cs.set(this,new gt),ks.set(this,new St),Ws.set(this,new de),xs.set(this,new ui),As.set(this,!1),t(this,ys,"f").eventDispatcher=t(this,is,"f"),t(this,Es,"f").sendRxData=this.sendRxData,t(this,Ds,"f").sendRxData=this.sendRxData,t(this,Ss,"f").eventDispatcher=t(this,is,"f"),t(this,Cs,"f").eventDispatcher=t(this,is,"f"),t(this,ks,"f").eventDispatcher=t(this,is,"f"),t(this,Ws,"f").eventDispatcher=t(this,is,"f"),t(this,xs,"f").sendUICommandsData=this.sendUICommandsData,t(this,Ws,"f").rawSensorSensitivity=t(this,Es,"f").sensitivity,this.addEventListener("hardwareRevision",(()=>{})),this.addEventListener("isInAirGestureState",(e=>{t(this,Ss,"f").isInAirGestureState=e.message.isInAirGestureState})),this.addEventListener("isConnected",(()=>{this.isConnected?(setTimeout((()=>{t(this,Es,"f").start()}),0),setTimeout((()=>{}),20)):(t(this,Es,"f").stop(),t(this,Ds,"f").stop())})),Bi.onDevice(this),s&&window.addEventListener("beforeunload",(()=>{this.isConnected})),n&&process.on("exit",(()=>{this.isConnected}))}get addEventListener(){return t(this,is,"f").addEventListener}get removeEventListener(){return t(this,is,"f").removeEventListener}get waitForEvent(){return t(this,is,"f").waitForEvent}get removeEventListeners(){return t(this,is,"f").removeEventListeners}get removeAllEventListeners(){return t(this,is,"f").removeAllEventListeners}get connectionManager(){return t(this,ns,"f")}set connectionManager(i){this.connectionManager!=i?(this.connectionManager&&(this.connectionManager.onStatusUpdated=void 0,this.connectionManager.onMessageReceived=void 0,this.connectionManager.onMessagesReceived=void 0),i&&(i.onStatusUpdated=t(this,Zi,"m",fs).bind(this),i.onMessageReceived=t(this,Zi,"m",ps).bind(this),i.onMessagesReceived=t(this,Zi,"m",ws).bind(this)),e(this,ns,i,"f"),Is.log("assigned new connectionManager",t(this,ns,"f"))):Is.log("same connectionManager is already assigned")}async connect(){return this.connectionManager||(this.connectionManager=t(ts,ts,"m",es).call(ts)),t(this,Zi,"m",ms).call(this),this.connectionManager.connect()}get isConnected(){return t(this,os,"f")}get canReconnect(){return this.connectionManager?.canReconnect}async reconnect(){return t(this,Zi,"m",hs).call(this),t(this,Zi,"m",ms).call(this),this.connectionManager?.reconnect()}static async Connect(){const t=new ts;return await t.connect(),t}static get ReconnectOnDisconnection(){return t(this,ts,"f",ls)}static set ReconnectOnDisconnection(t){Is.assertTypeWithError(t,"boolean"),e(this,ts,t,"f",ls)}get reconnectOnDisconnection(){return t(this,us,"f")}set reconnectOnDisconnection(t){Is.assertTypeWithError(t,"boolean"),e(this,us,t,"f")}get connectionType(){return this.connectionManager?.type}async disconnect(){return t(this,Zi,"m",cs).call(this),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.addEventListener("isConnected",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this.connectionManager.disconnect()}toggleConnection(){this.isConnected?this.disconnect():this.canReconnect?this.reconnect():this.connect()}get connectionStatus(){switch(t(this,ns,"f")?.status){case"connected":return this.isConnected?"connected":"connecting";case"notConnected":case"connecting":case"disconnecting":return t(this,ns,"f").status;default:return"notConnected"}}get isConnectionBusy(){return"connecting"==this.connectionStatus||"disconnecting"==this.connectionStatus}get deviceInformation(){return t(this,ys,"f").information}get batteryLevel(){return t(this,bs,"f")}get inputMode(){return t(this,Es,"f").mode}set inputMode(t){this.setInputMode(t)}get setInputMode(){return t(this,Es,"f").setMode}get setSensitivityForType(){return t(this,Es,"f").setSensitivityForType}get xrState(){return t(this,Ds,"f").state}set xrState(t){this.setXRState(t)}get setXRState(){return t(this,Ds,"f").setState}get xrAirGestureMinCount(){return t(this,ks,"f").xrAirGestureMinCount}set xrAirGestureMinCount(e){t(this,ks,"f").xrAirGestureMinCount=e}get calculateOrientation(){return t(this,Ws,"f").calculateOrientation}set calculateOrientation(e){t(this,Ws,"f").calculateOrientation=e}get vibrate(){return t(this,xs,"f").vibrate}get isServerSide(){return t(this,As,"f")}set isServerSide(i){t(this,As,"f")!=i?(Is.log({newIsServerSide:i}),e(this,As,i,"f")):Is.log("redundant isServerSide assignment")}}var Ts,$s,Os;ts=Ls,is=new WeakMap,ns=new WeakMap,os=new WeakMap,us=new WeakMap,ds=new WeakMap,ys=new WeakMap,bs=new WeakMap,Es=new WeakMap,Ds=new WeakMap,Ss=new WeakMap,Cs=new WeakMap,ks=new WeakMap,Ws=new WeakMap,xs=new WeakMap,As=new WeakMap,Zi=new WeakSet,es=function(){return new ai},ss=function(){return t(this,is,"f").dispatchEvent},rs=async function(e){await(t(this,ns,"f")?.sendUICommandsData(e))},as=async function(e){await(t(this,ns,"f")?.sendRxData(e))},cs=function(){Is.assertWithError(this.isConnected,"notConnected")},hs=function(){Is.assertWithError(this.canReconnect,"cannot reconnect to device")},fs=function(i){Is.log({connectionStatus:i}),"notConnected"==i?this.canReconnect&&this.reconnectOnDisconnection&&(Is.log("starting reconnect interval..."),e(this,ds,setInterval((()=>{Is.log("attempting reconnect..."),this.reconnect()}),1e3),"f")):null!=t(this,ds,"f")&&(Is.log("clearing reconnect interval"),clearInterval(t(this,ds,"f")),e(this,ds,void 0,"f")),t(this,Zi,"m",vs).call(this),"connected"==i&&t(this,os,"f"),Bi.OnDeviceConnectionStatusUpdated(this,i)},gs=function(e=!1){t(this,Zi,"a",ss).call(this,"connectionStatus",{connectionStatus:this.connectionStatus}),t(this,Zi,"a",ss).call(this,this.connectionStatus,{}),e&&t(this,Zi,"a",ss).call(this,"isConnected",{isConnected:this.isConnected})},vs=function(){switch(e(this,os,Boolean(this.connectionManager?.isConnected),"f"),this.connectionStatus){case"connected":t(this,os,"f")&&t(this,Zi,"m",gs).call(this,!0);break;case"notConnected":t(this,Zi,"m",gs).call(this,!0);break;default:t(this,Zi,"m",gs).call(this,!1)}},ms=function(){this.latestConnectionMessage.clear(),t(this,ys,"f").clear(),t(this,Ws,"f").clear()},ps=function(e,i){if(Is.log({messageType:e,dataView:i}),"batteryLevel"===e){const e=i.getUint8(0);Is.log("received battery level",{batteryLevel:e}),t(this,Zi,"m",Ms).call(this,e)}else if(q.includes(e))t(this,ys,"f").parseMessage(e,i);else if(nt.includes(e))t(this,Ss,"f").parseMessage(e,i);else if(dt.includes(e))t(this,Cs,"f").parseMessage(e,i);else if(Et.includes(e))t(this,ks,"f").parseMessage(e,i);else{if(!le.includes(e))throw Error(`uncaught messageType "${e}"`);t(this,Ws,"f").parseMessage(e,i)}this.latestConnectionMessage.set(e,i),t(this,Zi,"a",ss).call(this,"connectionMessage",{messageType:e,dataView:i})},ws=function(){this.isConnected||t(this,Zi,"m",vs).call(this)},Ms=function(i){Is.assertTypeWithError(i,"number"),t(this,bs,"f")!=i?(e(this,bs,i,"f"),Is.log({updatedBatteryLevel:t(this,bs,"f")}),t(this,Zi,"a",ss).call(this,"batteryLevel",{batteryLevel:t(this,bs,"f")})):Is.log(`duplicate batteryLevel assignment ${i}`)},ls={value:!1};const Us={min:1/0,max:-1/0,span:0};class Gs{constructor(){Ts.add(this),$s.set(this,Object.assign({},Us))}get min(){return t(this,$s,"f").min}get max(){return t(this,$s,"f").max}set min(e){t(this,$s,"f").min=e,t(this,$s,"f").max=Math.max(e,t(this,$s,"f").max),t(this,Ts,"m",Os).call(this)}set max(e){t(this,$s,"f").max=e,t(this,$s,"f").min=Math.min(e,t(this,$s,"f").min),t(this,Ts,"m",Os).call(this)}reset(){Object.assign(t(this,$s,"f"),Us)}update(e){t(this,$s,"f").min=Math.min(e,t(this,$s,"f").min),t(this,$s,"f").max=Math.max(e,t(this,$s,"f").max),t(this,Ts,"m",Os).call(this)}getNormalization(e,i){let s=function(t,e,i,s){return null==s&&(s=i-e),(t-e)/s}(e,t(this,$s,"f").min,t(this,$s,"f").max,t(this,$s,"f").span);return i&&(s*=t(this,$s,"f").span),s||0}updateAndGetNormalization(t,e){return this.update(t),this.getNormalization(t,e)}}$s=new WeakMap,Ts=new WeakSet,Os=function(){t(this,$s,"f").span=t(this,$s,"f").max-t(this,$s,"f").min};export{Ls as Device,Bi as DeviceManager,w as Environment,Fi as InputModes,li as MaxNumberOfVibrationSegments,hi as MaxNumberOfVibrations,Gs as RangeHelper,Wt as RawSensorSensitivityFactors,kt as RawSensorTypes,Xi as XRStates,x as setAllConsoleLevelFlags,W as setConsoleLevelFlagsForType};
//# sourceMappingURL=tapstrap.module.min.js.map
