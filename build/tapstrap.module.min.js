/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
function e(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)}function t(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s}"function"==typeof SuppressedError&&SuppressedError;const s=!1,i="undefined"!=typeof window&&void 0!==window?.document,n="undefined"!=typeof process&&null!=process?.versions?.node,r=i&&navigator.userAgent||"";let a=!1;i?a=Boolean(navigator.bluetooth):n&&(a=!0);const o=i&&/Bluefy/i.test(r),c=i&&/WebBLE/i.test(r),h=i&&/Android/i.test(r),l=i&&/Safari/i.test(r)&&!/Chrome/i.test(r),u=i&&/iPad|iPhone|iPod/i.test(r),d=i&&/Macintosh/i.test(r),f=!i&&!n&&"undefined"!=typeof global&&"undefined"!=typeof Studio;var g,v,m,p,w=Object.freeze({__proto__:null,isAndroid:h,get isBluetoothSupported(){return a},isIOS:u,isInBluefy:o,isInBrowser:i,isInDev:s,isInLensStudio:f,isInNode:n,isInProduction:!0,isInWebBLE:c,isMac:d,isSafari:l});if(f){const e=function(...e){Studio.log(e.map((e=>new String(e))).join(","))};(p={}).log=e,p.warn=e.bind(p,"WARNING"),p.error=e.bind(p,"ERROR")}else p=console;if(!p.assert){const e=(e,...t)=>{e||p.warn(...t)};p.assert=e}if(!p.table){const e=(...e)=>{p.log(...e)};p.table=e}function y(){}const b=p.log.bind(p),M=p.warn.bind(p),E=p.error.bind(p),D=p.table.bind(p),S=p.assert.bind(p);class C{constructor(t){if(m.set(this,{log:s,warn:s,assert:!0,error:!0,table:!0}),e(g,g,"f",v)[t])throw new Error(`"${t}" console already exists`);e(g,g,"f",v)[t]=this}setLevelFlags(t){Object.assign(e(this,m,"f"),t)}static setLevelFlagsForType(t,s){if(!e(this,g,"f",v)[t])throw new Error(`no console found with type "${t}"`);e(this,g,"f",v)[t].setLevelFlags(s)}static setAllLevelFlags(t){for(const s in e(this,g,"f",v))e(this,g,"f",v)[s].setLevelFlags(t)}static create(t,s){return e(this,g,"f",v)[t]||new g(t)}get log(){return e(this,m,"f").log?b:y}get warn(){return e(this,m,"f").warn?M:y}get error(){return e(this,m,"f").error?E:y}get assert(){return e(this,m,"f").assert?S:y}get table(){return e(this,m,"f").table?D:y}assertWithError(e,t){if(!Boolean(e))throw new Error(t)}assertTypeWithError(e,t){this.assertWithError(typeof e==t,`value ${e} of type "${typeof e}" not of type "${t}"`)}assertEnumWithError(e,t){this.assertWithError(t.includes(e),`invalid enum "${e}"`)}}function k(e,t){return C.create(e,t)}function W(e,t){C.setLevelFlagsForType(e,t)}function I(e){C.setAllLevelFlags(e)}g=C,m=new WeakMap,v={value:{}};const x=k("EventDispatcher",{log:!1});class A{constructor(e,t){this.target=e,this.validEventTypes=t,this.listeners={},this.addEventListener=this.addEventListener.bind(this),this.removeEventListener=this.removeEventListener.bind(this),this.removeEventListeners=this.removeEventListeners.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.dispatchEvent=this.dispatchEvent.bind(this),this.waitForEvent=this.waitForEvent.bind(this)}isValidEventType(e){return this.validEventTypes.includes(e)}updateEventListeners(e){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((t=>(t.shouldRemove&&x.log(`removing "${e}" eventListener`,t),!t.shouldRemove))))}addEventListener(e,t,s={once:!1}){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]||(this.listeners[e]=[],x.log(`creating "${e}" listeners array`,this.listeners[e]));this.listeners[e].find((e=>e.listener==t&&e.once==s.once))?x.log("already added listener"):(x.log(`adding "${e}" listener`,t,s),this.listeners[e].push({listener:t,once:s.once}),x.log(`currently have ${this.listeners[e].length} "${e}" listeners`))}removeEventListener(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(x.log(`removing "${e}" listener...`,t),this.listeners[e].forEach((s=>{s.listener===t&&(x.log(`flagging "${e}" listener`,t),s.shouldRemove=!0)})),this.updateEventListeners(e))}removeEventListeners(e){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(x.log(`removing "${e}" listeners...`),this.listeners[e]=[])}removeAllEventListeners(){x.log("removing listeners..."),this.listeners={}}dispatchEvent(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(this.listeners[e].forEach((s=>{s.shouldRemove||(x.log(`dispatching "${e}" listener`,s),s.listener({type:e,target:this.target,message:t}),s.once&&(x.log(`flagging "${e}" listener`,s),s.shouldRemove=!0))})),this.updateEventListeners(e))}waitForEvent(e){return new Promise((t=>{this.addEventListener(e,(e=>{t(e)}),{once:!0})}))}}var R,L,T;const $=k("Timer",{log:!1});class U{get callback(){return e(this,R,"f")}set callback(e){$.assertTypeWithError(e,"function"),$.log({newCallback:e}),t(this,R,e,"f"),this.isRunning&&this.restart()}get interval(){return e(this,L,"f")}set interval(e){$.assertTypeWithError(e,"number"),$.assertWithError(e>0,"interval must be above 0"),$.log({newInterval:e}),t(this,L,e,"f"),this.isRunning&&this.restart()}constructor(e,t){R.set(this,void 0),L.set(this,void 0),T.set(this,void 0),this.interval=t,this.callback=e}get isRunning(){return null!=e(this,T,"f")}start(s=!1){this.isRunning?$.log("interval already running"):($.log("starting interval"),t(this,T,setInterval(e(this,R,"f"),e(this,L,"f")),"f"),s&&e(this,R,"f").call(this))}stop(){this.isRunning?($.log("stopping interval"),clearInterval(e(this,T,"f")),t(this,T,void 0,"f")):$.log("interval already not running")}restart(e=!1){this.stop(),this.start(e)}}var O,G;R=new WeakMap,L=new WeakMap,T=new WeakMap,O="undefined"==typeof TextEncoder?class{encode(e){const t=Array.from(e).map((e=>e.charCodeAt(0)));return Uint8Array.from(t)}}:TextEncoder,G="undefined"==typeof TextDecoder?class{decode(e){return Array.from(new Uint8Array(e)).map((e=>String.fromCharCode(e))).join("")}}:TextDecoder;const B=new O,z=new G;var F,N,j,V,_;const P=k("DeviceInformationManager",{log:!0}),q=["manufacturerName","modelNumber","softwareRevision","hardwareRevision","firmwareRevision","pnpId","serialNumber"],Q=[...q,"deviceInformation"];class J{constructor(){F.add(this),j.set(this,{})}get information(){return e(this,j,"f")}clear(){t(this,j,{},"f")}parseMessage(t,s){switch(P.log({messageType:t}),t){case"manufacturerName":const i=z.decode(s.buffer);P.log({manufacturerName:i}),e(this,F,"m",_).call(this,{manufacturerName:i});break;case"modelNumber":const n=z.decode(s.buffer);P.log({modelNumber:n}),e(this,F,"m",_).call(this,{modelNumber:n});break;case"softwareRevision":const r=z.decode(s.buffer);P.log({softwareRevision:r}),e(this,F,"m",_).call(this,{softwareRevision:r});break;case"hardwareRevision":const a=z.decode(s.buffer);P.log({hardwareRevision:a}),e(this,F,"m",_).call(this,{hardwareRevision:a});break;case"firmwareRevision":const o=z.decode(s.buffer);P.log({firmwareRevision:o}),e(this,F,"m",_).call(this,{firmwareRevision:o});break;case"pnpId":const c={source:1===s.getUint8(0)?"Bluetooth":"USB",productId:s.getUint16(3,!0),productVersion:s.getUint16(5,!0),vendorId:0};"Bluetooth"==c.source&&(c.vendorId=s.getUint16(1,!0)),P.log({pnpId:c}),e(this,F,"m",_).call(this,{pnpId:c});break;case"serialNumber":const h=z.decode(s.buffer);P.log({serialNumber:h});break;default:throw Error(`uncaught messageType ${t}`)}}}j=new WeakMap,F=new WeakSet,N=function(){return this.eventDispatcher.dispatchEvent},V=function(){return q.every((t=>{switch(t){case"modelNumber":case"serialNumber":return!0;default:return t in e(this,j,"f")}}))},_=function(t){P.log({partialDeviceInformation:t});Object.keys(t).forEach((s=>{e(this,F,"a",N).call(this,s,{[s]:t[s]})})),Object.assign(e(this,j,"f"),t),P.log({deviceInformation:e(this,j,"f")}),e(this,F,"a",V)&&(P.log("completed deviceInformation"),e(this,F,"a",N).call(this,"deviceInformation",{deviceInformation:this.information}))};function K(e,{include:t,exclude:s}={}){const i=e=>{const i=t=>"string"==typeof t?e===t:t.test(e);return t?t.some(i):!s||!s.some(i)};for(const[t,s]of(e=>{const t=new Set;do{for(const s of Reflect.ownKeys(e))t.add([e,s])}while((e=Reflect.getPrototypeOf(e))&&e!==Object.prototype);return t})(e.constructor.prototype)){if("constructor"===s||!i(s))continue;const n=Reflect.getOwnPropertyDescriptor(t,s);n&&"function"==typeof n.value&&(e[s]=e[s].bind(e))}return e}const X={oneFingerUp:2,twoFingersUp:3,oneFingerDown:4,twoFingersDown:5,oneFingerLeft:6,twoFingersLeft:7,oneFingerRight:8,twoFingersRight:9,indexToThumbTouch:10,middleToThumbTouch:11,xrAirGestureNone:100,xrAirGestureThumbIndex:101,xrAirGestureThumbMiddle:102},H={};Object.keys(X).forEach((e=>{H[X[e]]=e}));const Y={clickIndex:1,clickMiddle:2,dragIndex:3,dragMiddle:4,drop:5,potentialDragOrClickIndex:6,potentialDragOrClickMiddle:7},Z={};var ee,te,se;Object.keys(Y).forEach((e=>{Z[Y[e]]=e}));const ie=k("TapDataManager"),ne=["tapData"],re=[...ne,"tapAirGesture"],ae=["thumb","index","middle","ring","pinky"];class oe{constructor(){ee.add(this),this.isInAirGestureState=!1,K(this)}parseMessage(t,s){if(ie.log({messageType:t}),"tapData"!==t)throw Error(`uncaught messageType ${t}`);e(this,ee,"m",se).call(this,s)}}var ce,he,le;ee=new WeakSet,te=function(){return this.eventDispatcher.dispatchEvent},se=function(t){ie.log("parsing tap data",t);const s=t.getUint8(0);if(this.isInAirGestureState){const t=function(e){switch(e){case 2:return"indexToThumbTouch";case 4:return"middleToThumbTouch"}}(s);ie.log({tapAirGesture:t}),t&&e(this,ee,"a",te).call(this,"tapAirGesture",{tapAirGesture:t})}else{let i;if(t.byteLength>=4){const e=t.getUint8(3);i={shiftState:3&e,switchState:e>>2&3,multitap:Math.min(1+(e>>4&3),3)}}const n={};ie.log("fingerBits",s.toString(2)),ae.forEach(((e,t)=>{n[e]=!!(s&1<<t)})),ie.log("fingers",n),e(this,ee,"a",te).call(this,"tapData",{fingers:n,keyboardState:i})}};const ue=k("MouseDataManager"),de=["mouseData"],fe=[...de];class ge{constructor(){ce.add(this),K(this)}parseMessage(t,s){if(ue.log({messageType:t}),"mouseData"!==t)throw Error(`uncaught messageType ${t}`);e(this,ce,"m",le).call(this,s)}}var ve,me,pe,we,ye;ce=new WeakSet,he=function(){return this.eventDispatcher.dispatchEvent},le=function(t){ue.log("parsing mouse data",t);if(0!=t.getUint8(0))return;const s={x:t.getInt16(1,!0),y:-t.getInt16(3,!0)},i=1==t.getUint8(9);e(this,ce,"a",he).call(this,"mouseData",{velocity:s,isMouse:i})};const be=k("AirGestureManager"),Me=["airGesture"],Ee=[...Me,"isInAirGestureState","xrAirGesture"];class De{constructor(){ve.add(this),pe.set(this,!1),K(this)}get isInState(){return e(this,pe,"f")}parseMessage(t,s){if(be.log({messageType:t}),"airGesture"!==t)throw Error(`uncaught messageType ${t}`);e(this,ve,"m",ye).call(this,s)}}pe=new WeakMap,ve=new WeakSet,me=function(){return this.eventDispatcher.dispatchEvent},we=function(s){t(this,pe,s,"f"),be.log("isInAirGestureState",e(this,pe,"f")),e(this,ve,"a",me).call(this,"isInAirGestureState",{isInAirGestureState:e(this,pe,"f")})},ye=function(t){be.log("parsing air gesture",t);const s=t.getUint8(0);if(20==s){const s=t.getUint8(1);e(this,ve,"m",we).call(this,1==s)}else{let t=H[s];if(be.log({airGesture:t}),t)e(this,ve,"a",me).call(this,"airGesture",{airGesture:t});else{const t=Z[s];be.log({xrAirGesture:t}),t&&e(this,ve,"a",me).call(this,"xrAirGesture",{xrAirGesture:t})}}};const Se=k("RawSensorUtils"),Ce=["deviceAccelerometer","imuGyroscope","imuAccelerometer"],ke={deviceAccelerometer:[31.25,3.90625,7.8125,15.625,31.25],imuGyroscope:[17.5,4.375,8.75,17.5,35,70],imuAccelerometer:[.122,.061,.122,.244,.488]},We={deviceAccelerometer:0,imuGyroscope:0,imuAccelerometer:0},Ie={imu:12,device:30};function xe(e,t){const s=ke[e][t];Se.assertWithError(null!=s,`invalid RawSensorSensitivity index ${t} for sensor "${e}" (got value ${s})`)}const Ae=["gyroscope","accelerometer"],Re=["thumb","index","middle","ring","pinky"],Le=k("ArrayBufferUtils",{log:!1});function Te(...e){const t=(e=(e=(e=e.filter((e=>null!=e||null!=e))).map((e=>{if("number"==typeof e){const t=e;return Uint8Array.from([Math.floor(t)])}if("boolean"==typeof e){const t=e;return Uint8Array.from([t?1:0])}if("string"==typeof e){return $e(e)}if(e instanceof Array){return Te(...e)}if(e instanceof ArrayBuffer)return e;if("buffer"in e&&e.buffer instanceof ArrayBuffer){return e.buffer}if(e instanceof DataView){return e.buffer}if("object"==typeof e){return function(e){return $e(JSON.stringify(e))}(e)}return e}))).filter((e=>e&&"byteLength"in e))).reduce(((e,t)=>e+t.byteLength),0),s=new Uint8Array(t);let i=0;return e.forEach((e=>{s.set(new Uint8Array(e),i),i+=e.byteLength})),s.buffer}function $e(e){const t=B.encode(e);return Te(t.byteLength,t)}function Ue(e,t,s){let i;return null!=s&&(i=e.byteOffset+t+s),Le.log({dataView:e,begin:t,end:i,length:s}),new DataView(e.buffer.slice(e.byteOffset+t,i))}var Oe,Ge,Be,ze;function Fe(){return Ge?Oe:(Ge=1,Oe=function(e,t){const s=(t=t||{}).kp||1,i=t.ki||0;let n=1/(1e3/e),r=!0!==t.doInitialisation,a=2*s;const o=2*i;let c=1,h=0,l=0,u=0,d=0,f=0,g=0;function v(e,t,s,i,n,r){return{x:t*r-s*n,y:s*i-e*r,z:e*n-t*i}}function m(e,t,s,i,n,a){const o=function(e,t,s,i,n,r){const a=-Math.atan2(e,Math.sqrt(t*t+s*s)),o=v(e,t,s,1,0,0),c=v(1,0,0,o.x,o.y,o.z),h=Math.atan2(c.y,c.z),l=Math.cos(h),u=Math.sin(a),d=Math.sin(h),f=n*l-r*d,g=i*Math.cos(a)+n*d*u+r*l*u;return{heading:-Math.atan2(f,g),pitch:a,roll:h}}(e,t,s,i,n,a),d=function(e){const t=Math.cos(.5*e.heading),s=Math.sin(.5*e.heading),i=Math.cos(.5*e.pitch),n=Math.sin(.5*e.pitch),r=Math.cos(.5*e.roll),a=Math.sin(.5*e.roll);return{w:r*i*t+a*n*s,x:a*i*t-r*n*s,y:r*n*t+a*i*s,z:r*i*s-a*n*t}}(o),f=(d.w*d.w+d.x*d.x+d.y*d.y+d.z*d.z)**-.5;c=d.w*f,h=d.x*f,l=d.y*f,u=d.z*f,r=!0}return{update:function(e,t,s,i,v,p,w,y,b,M){let E,D,S,C,k,W,I,x,A,R,L,T,$,U,O,G,B,z,F,N,j,V,_,P;if(n=M||n,r||m(i,v,p,w,y,b),void 0===w||void 0===y||void 0===b||0===w&&0===y&&0===b)return void function(e,t,s,i,r,v){let m,p,w,y,b,M,E;0!==i&&0!==r&&0!==v&&(m=(i*i+r*r+v*v)**-.5,p=h*u-c*l,w=c*h+l*u,y=c*c-.5+u*u,b=(r*=m)*y-(v*=m)*w,M=v*p-(i*=m)*y,E=i*w-r*p,o>0?(d+=o*b*n,f+=o*M*n,g+=o*E*n,e+=d,t+=f,s+=g):(d=0,f=0,g=0),e+=a*b,t+=a*M,s+=a*E);const D=c,S=h,C=l;c+=-S*(e*=.5*n)-C*(t*=.5*n)-u*(s*=.5*n),h+=D*e+C*s-u*t,l+=D*t-S*s+u*e,u+=D*s+S*t-C*e,m=(c*c+h*h+l*l+u*u)**-.5,c*=m,h*=m,l*=m,u*=m}(e,t,s,i,v,p);0!==i&&0!==v&&0!==p&&(E=(i*i+v*v+p*p)**-.5,i*=E,v*=E,p*=E,E=(w*w+y*y+b*b)**-.5,D=c*c,S=c*h,C=c*l,k=c*u,W=h*h,I=h*l,x=h*u,A=l*l,R=l*u,L=u*u,T=2*((w*=E)*(.5-A-L)+(y*=E)*(I-k)+(b*=E)*(x+C)),$=2*(w*(I+k)+y*(.5-W-L)+b*(R-S)),U=Math.sqrt(T*T+$*$),O=2*(w*(x-C)+y*(R+S)+b*(.5-W-A)),G=x-C,B=S+R,z=D-.5+L,F=U*(.5-A-L)+O*(x-C),N=U*(I-k)+O*(S+R),j=U*(C+x)+O*(.5-W-A),V=v*z-p*B+(y*j-b*N),_=p*G-i*z+(b*F-w*j),P=i*B-v*G+(w*N-y*F),o>0?(d+=o*V*n,f+=o*_*n,g+=o*P*n,e+=d,t+=f,s+=g):(d=0,f=0,g=0),e+=a*V,t+=a*_,s+=a*P);const q=c,Q=h,J=l;c+=-Q*(e*=.5*n)-J*(t*=.5*n)-u*(s*=.5*n),h+=q*e+J*s-u*t,l+=q*t-Q*s+u*e,u+=q*s+Q*t-J*e,E=(c*c+h*h+l*l+u*u)**-.5,c*=E,h*=E,l*=E,u*=E},init:m,getQuaternion:()=>({w:c,x:h,y:l,z:u})}})}function Ne(){return ze?Be:(ze=1,Be=function(e,t){const s=1e3/e;let i=(t=t||{}).beta||.4,n=!0!==t.doInitialisation,r=1,a=0,o=0,c=0,h=1/s;function l(e,t,s,i,n,r){return{x:t*r-s*n,y:s*i-e*r,z:e*n-t*i}}function u(e,t,s,i,h,u){const d=function(e,t,s,i,n,r){const a=-Math.atan2(e,Math.sqrt(t*t+s*s)),o=l(e,t,s,1,0,0),c=l(1,0,0,o.x,o.y,o.z),h=Math.atan2(c.y,c.z),u=Math.cos(h),d=Math.sin(a),f=Math.sin(h),g=n*u-r*f,v=i*Math.cos(a)+n*f*d+r*u*d;return{heading:-Math.atan2(g,v),pitch:a,roll:h}}(e,t,s,i,h,u),f=function(e){const t=Math.cos(.5*e.heading),s=Math.sin(.5*e.heading),i=Math.cos(.5*e.pitch),n=Math.sin(.5*e.pitch),r=Math.cos(.5*e.roll),a=Math.sin(.5*e.roll);return{w:r*i*t+a*n*s,x:a*i*t-r*n*s,y:r*n*t+a*i*s,z:r*i*s-a*n*t}}(d),g=(f.w*f.w+f.x*f.x+f.y*f.y+f.z*f.z)**-.5;r=f.w*g,a=f.x*g,o=f.y*g,c=f.z*g,n=!0}return{update:function(e,t,s,l,d,f,g,v,m,p){let w,y,b,M,E,D,S,C,k,W,I,x,A,R,L,T,$,U,O,G,B,z,F,N,j,V,_,P,q,Q,J,K,X,H,Y;h=p||h,n||u(l,d,f,g,v,m),void 0===g||void 0===v||void 0===m||0===g&&0===v&&0===m?function(e,t,s,n,l,u){let d,f,g,v,m,p,w,y,b,M,E,D,S,C,k,W,I,x,A,R,L,T;p=.5*(-a*e-o*t-c*s),w=.5*(r*e+o*s-c*t),y=.5*(r*t-a*s+c*e),b=.5*(r*s+a*t-o*e),0===n&&0===l&&0===u||(d=(n*n+l*l+u*u)**-.5,M=2*r,E=2*a,D=2*o,S=2*c,C=4*r,k=4*a,W=4*o,I=8*a,x=8*o,A=r*r,R=a*a,L=o*o,T=c*c,f=C*L+D*(n*=d)+C*R-E*(l*=d),g=k*T-S*n+4*A*a-M*l-k+I*R+I*L+k*(u*=d),v=4*A*o+M*n+W*T-S*l-W+x*R+x*L+W*u,m=4*R*c-E*n+4*L*c-D*l,d=(f*f+g*g+v*v+m*m)**-.5,f*=d,g*=d,v*=d,m*=d,p-=i*f,w-=i*g,y-=i*v,b-=i*m),r+=p*h,a+=w*h,o+=y*h,c+=b*h,d=(r*r+a*a+o*o+c*c)**-.5,r*=d,a*=d,o*=d,c*=d}(e,t,s,l,d,f):(D=.5*(-a*e-o*t-c*s),S=.5*(r*e+o*s-c*t),C=.5*(r*t-a*s+c*e),k=.5*(r*s+a*t-o*e),0===l&&0===d&&0===f||(w=(l*l+d*d+f*f)**-.5,l*=w,d*=w,f*=w,w=(g*g+v*v+m*m)**-.5,x=2*r*(g*=w),A=2*r*(v*=w),R=2*r*(m*=w),L=2*a*g,G=2*r,B=2*a,z=2*o,F=2*c,N=2*r*o,j=2*o*c,V=r*r,_=r*a,P=r*o,q=r*c,Q=a*a,J=a*o,K=a*c,X=o*o,H=o*c,Y=c*c,W=g*V-A*c+R*o+g*Q+B*v*o+B*m*c-g*X-g*Y,I=x*c+v*V-R*a+L*o-v*Q+v*X+z*m*c-v*Y,T=Math.sqrt(W*W+I*I),$=-x*o+A*a+m*V+L*c-m*Q+z*v*c-m*X+m*Y,U=2*T,O=2*$,y=-z*(2*K-N-l)+B*(2*_+j-d)-$*o*(T*(.5-X-Y)+$*(K-P)-g)+(-T*c+$*a)*(T*(J-q)+$*(_+H)-v)+T*o*(T*(P+K)+$*(.5-Q-X)-m),b=F*(2*K-N-l)+G*(2*_+j-d)-4*a*(1-2*Q-2*X-f)+$*c*(T*(.5-X-Y)+$*(K-P)-g)+(T*o+$*r)*(T*(J-q)+$*(_+H)-v)+(T*c-O*a)*(T*(P+K)+$*(.5-Q-X)-m),M=-G*(2*K-N-l)+F*(2*_+j-d)-4*o*(1-2*Q-2*X-f)+(-U*o-$*r)*(T*(.5-X-Y)+$*(K-P)-g)+(T*a+$*c)*(T*(J-q)+$*(_+H)-v)+(T*r-O*o)*(T*(P+K)+$*(.5-Q-X)-m),E=B*(2*K-N-l)+z*(2*_+j-d)+(-U*c+$*a)*(T*(.5-X-Y)+$*(K-P)-g)+(-T*r+$*o)*(T*(J-q)+$*(_+H)-v)+T*a*(T*(P+K)+$*(.5-Q-X)-m),w=(y*y+b*b+M*M+E*E)**-.5,y*=w,b*=w,M*=w,E*=w,D-=i*y,S-=i*b,C-=i*M,k-=i*E),r+=D*h,a+=S*h,o+=C*h,c+=k*h,w=(r*r+a*a+o*o+c*c)**-.5,r*=w,a*=w,o*=w,c*=w)},init:u,getQuaternion:()=>({w:r,x:a,y:o,z:c})}})}const je=180/Math.PI;function Ve(e){const t=(e=e||{}).sampleInterval||20,s=e.algorithm||"Madgwick";let i;if("Mahony"===s)i=Fe();else{if("Madgwick"!==s)throw new Error(`AHRS(): Algorithm not valid: ${s}`);i=Ne()}const n=i(t,e),r=this;Object.keys(n).forEach((e=>r[e]=n[e]))}Ve.prototype.toVector=function(){const e=this.getQuaternion(),t=2*Math.acos(e.w),s=Math.sin(t/2);return{angle:t,x:e.x/s,y:e.y/s,z:e.z/s}},Ve.prototype.getEulerAngles=function(){const e=this.getQuaternion(),t=e.w*e.w,s=e.x*e.x,i=e.y*e.y,n=e.z*e.z;return{heading:Math.atan2(2*(e.x*e.y+e.z*e.w),s-i-n+t),pitch:-Math.asin(2*(e.x*e.z-e.y*e.w)),roll:Math.atan2(2*(e.y*e.z+e.x*e.w),-s-i+n+t)}},Ve.prototype.getEulerAnglesDegrees=function(){const e=this.getEulerAngles();return{heading:e.heading*je,pitch:e.pitch*je,roll:e.roll*je}};var _e,Pe=(_e=Ve)&&_e.__esModule&&Object.prototype.hasOwnProperty.call(_e,"default")?_e.default:_e;const qe=Math.PI/180;function Qe(e){return e*qe}var Je,Ke,Xe,He,Ye,Ze,et;const tt=k("RawSensorManager"),st=["rawSensor"],it=[...st,"imu","device","orientation"];class nt{constructor(){Je.add(this),Xe.set(this,new Pe({sampleInterval:18,algorithm:"Madgwick"})),He.set(this,0),K(this)}parseMessage(t,s){if(tt.log({messageType:t}),"rawSensor"!==t)throw Error(`uncaught messageType ${t}`);e(this,Je,"m",Ye).call(this,s)}clear(){t(this,He,0,"f")}}var rt,at,ot;Xe=new WeakMap,He=new WeakMap,Je=new WeakSet,Ke=function(){return this.eventDispatcher.dispatchEvent},Ye=function(t){tt.log("parsing whole",t);let s=0;for(;s+4<t.byteLength;){const i=t.getUint32(0,!0);s+=4,tt.log({rawValue:i});const n=(2147483648&i)>>31,r=2147483647&i;if(tt.log({firstBit:n,timestamp:r}),0==r)break;const a=0==n?"imu":"device";tt.log({sensorDataType:a});const o=Ie[a];if(tt.log({sensorDataLength:o}),0==o)break;const c=Ue(t,s,o);c.byteLength==o&&e(this,Je,"m",Ze).call(this,a,r,c),s+=o}},Ze=function(s,i,n){tt.log(`parsing ${s} ${i}ms`,n);let r="device"==s?"deviceAccelerometer":"imuGyroscope";const a=[];for(let e=0;e<n.byteLength;e+=6){const t=this.sensitivity[r],i=ke[r][t],[o,c,h]=[-n.getInt16(e+0,!0),n.getInt16(e+2,!0),n.getInt16(e+4,!0)].map((e=>e*i*.001));tt.log({x:h,y:c,z:o});const l={x:h,y:c,z:o};tt.log("vector",l),a.push(l),"imu"==s&&(r="imuAccelerometer")}let o=0;switch(s){case"imu":o=2;break;case"device":o=5}if(a.length!=o)return void tt.log(`invalid number of ${s} vectors (expected ${o}, get ${a.length})`);const c={sensorDataType:s,timestamp:i};switch(c.sensorDataType){case"imu":if(c.accelerometer=a[Ae.indexOf("accelerometer")],c.gyroscope=a[Ae.indexOf("gyroscope")],e(this,He,"f")!=i){t(this,He,i,"f");const s=0==e(this,He,"f")?55:i-e(this,He,"f");e(this,Je,"m",et).call(this,c.accelerometer,c.gyroscope,s);const n=e(this,Xe,"f").getQuaternion(),r=e(this,Xe,"f").getEulerAngles();e(this,Je,"a",Ke).call(this,"orientation",{quaternion:n,euler:r,timestamp:i})}break;case"device":c.fingers={},Re.forEach(((e,t)=>{c.fingers[e]=a[t]}))}e(this,Je,"a",Ke).call(this,s,c),e(this,Je,"a",Ke).call(this,"rawSensor",c)},et=function(t,s,i){tt.log("updating ahrs..."),e(this,Xe,"f").update(Qe(s.x),Qe(s.y),Qe(s.z),t.x,t.y,t.z,void 0,void 0,void 0,i/1e3)};const ct=k("TxManager"),ht=["tx",...st],lt=[...it];class ut{get eventDispatcher(){return e(this,at,"f")}set eventDispatcher(s){t(this,at,s,"f"),e(this,ot,"f").eventDispatcher=s}set rawSensorSensitivity(t){e(this,ot,"f").sensitivity=t}constructor(){rt.add(this),at.set(this,void 0),ot.set(this,new nt),K(this)}parseMessage(t,s){if(ct.log({messageType:t}),"tx"!==t)throw Error(`uncaught messageType ${t}`);e(this,ot,"f").parseMessage("rawSensor",s)}clear(){e(this,ot,"f").clear()}}var dt,ft,gt,vt,mt,pt,wt,yt,bt;at=new WeakMap,ot=new WeakMap,rt=new WeakSet;const Mt=k("BaseConnectionManager",{log:!0}),Et=["notConnected","connecting","connected","disconnecting"],Dt=[...Et,"connectionStatus","isConnected"];class St{get baseConstructor(){return this.constructor}static get isSupported(){return!1}get isSupported(){return this.baseConstructor.isSupported}get type(){return this.baseConstructor.type}constructor(){dt.add(this),gt.set(this,"notConnected"),yt.set(this,new U(e(this,dt,"m",bt).bind(this),5e3)),e(this,dt,"m",ft).call(this)}get status(){return e(this,gt,"f")}set status(s){Mt.assertEnumWithError(s,Et),e(this,gt,"f")!=s?(Mt.log(`new connection status "${s}"`),t(this,gt,s,"f"),this.onStatusUpdated(this.status),this.isConnected?e(this,yt,"f").start():e(this,yt,"f").stop()):Mt.log(`tried to assign same connection status "${s}"`)}get isConnected(){return"connected"==this.status}async connect(){e(this,dt,"m",vt).call(this),e(this,dt,"m",mt).call(this),this.status="connecting"}get canReconnect(){return!1}async reconnect(){e(this,dt,"m",vt).call(this),e(this,dt,"m",mt).call(this),Mt.assert(this.canReconnect,"unable to reconnect")}async disconnect(){e(this,dt,"m",pt).call(this),e(this,dt,"m",wt).call(this),this.status="disconnecting",Mt.log("disconnecting from device...")}async sendUICommandsData(e){Mt.log("sendUICommandsData",e)}async sendRxData(e){Mt.log("sendRxData",e)}}gt=new WeakMap,yt=new WeakMap,dt=new WeakSet,ft=function(){Mt.assertWithError(this.isSupported,`${this.constructor.name} is not supported`)},vt=function(){Mt.assertWithError(!this.isConnected,"device is already connected")},mt=function(){Mt.assertWithError("connecting"!=this.status,"device is already connecting")},pt=function(){Mt.assertWithError(this.isConnected,"device is not connected")},wt=function(){Mt.assertWithError("disconnecting"!=this.status,"device is already disconnecting")},bt=function(){this.isConnected||(Mt.log("timer detected disconnection"),this.status="notConnected")};const Ct=k("EventUtils",{log:!1});function kt(e,t){let s=e.addEventListener||e.addListener||e.on||e.AddEventListener;Ct.assertWithError(s,"no add listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}function Wt(e,t){let s=e.removeEventListener||e.removeListener||e.RemoveEventListener;Ct.assertWithError(s,"no remove listener function found for target"),s=s.bind(e),Object.entries(t).forEach((([e,t])=>{s(e,t)}))}const It=k("bluetoothUUIDs",{log:!1});if(i)var xt=window.BluetoothUUID;function At(e){return It.assertTypeWithError(e,"string"),It.assertWithError(1==e.length,"value must be 1 character long"),`C3FF000${e}-1D8B-40FD-A56F-C7BD5D0F3370`.toLowerCase()}function Rt(e){return It.assertTypeWithError(e,"string"),It.assertWithError(1==e.length,"value must be 1 character long"),`6E40000${e}-B5A3-F393-E0A9-E50E24DCCA9E`.toLowerCase()}function Lt(e){return xt?.getCharacteristic?.(e)}function Tt(e){return xt?.getService?.(e)}const $t=Object.freeze({services:{deviceInformation:{uuid:Tt("device_information"),characteristics:{manufacturerName:{uuid:Lt("manufacturer_name_string")},modelNumber:{uuid:Lt("model_number_string")},hardwareRevision:{uuid:Lt("hardware_revision_string")},firmwareRevision:{uuid:Lt("firmware_revision_string")},softwareRevision:{uuid:Lt("software_revision_string")},pnpId:{uuid:Lt("pnp_id")},serialNumber:{uuid:Lt("serial_number_string")}}},battery:{uuid:Tt("battery_service"),characteristics:{batteryLevel:{uuid:Lt("battery_level")}}},tap:{uuid:At("1"),characteristics:{tapData:{uuid:At("5")},mouseData:{uuid:At("6")},airGesture:{uuid:At("A")},uiCommands:{uuid:At("9")},settings:{uuid:At("2")},unknown3:{uuid:At("3")},unknown7:{uuid:At("7")},unknown8:{uuid:At("8")},unknownB:{uuid:At("B")},unknownC:{uuid:At("C")},unknownD:{uuid:At("D")}}},nus:{uuid:Rt("1"),characteristics:{rx:{uuid:Rt("2")},tx:{uuid:Rt("3")}}}}}),Ut=[$t.services.tap.uuid],Ot=[$t.services.deviceInformation.uuid,$t.services.battery.uuid,$t.services.nus.uuid];function Gt(e){e=e.toString().toLowerCase();return Object.keys($t.services).find((t=>{let s=$t.services[t].uuid.toString();return 4==e.length&&(s=s.slice(4,8)),e.includes("-")||(s=s.replaceAll("-","")),e==s}))}const Bt=[],zt=[];function Ft(e){var t;return e=e.toString().toLowerCase(),Object.values($t.services).some((s=>{const i=Object.keys(s.characteristics);return t=i.find((t=>{let i=s.characteristics[t].uuid.toString();return 4==e.length&&(i=i.slice(4,8)),e.includes("-")||(i=i.replaceAll("-","")),e==i}))})),t}function Nt(e){const t={broadcast:!1,read:!0,writeWithoutResponse:!1,write:!1,notify:!1,indicate:!1,authenticatedSignedWrites:!1,reliableWrite:!1,writableAuxiliaries:!1};switch(e){case"settings":case"tapData":case"mouseData":case"unknown7":case"unknown8":t.read=!1}switch(e){case"batteryLevel":case"tapData":case"mouseData":case"airGesture":case"unknown8":case"unknownB":case"unknownC":case"unknownD":case"tx":t.notify=!0}switch(e){case"airGesture":case"uiCommands":case"unknown7":case"unknownB":t.writeWithoutResponse=!0}switch(e){case"settings":case"unknown3":case"unknown7":case"rx":t.write=!0}return t}Object.values($t.services).forEach((e=>{if(!e.characteristics)return;const t=Object.keys(e.characteristics);t.forEach((s=>{const i=e.characteristics[s];Ut.includes(e.uuid)&&(Bt.push(i.uuid),t.push(s)),zt.push(i.uuid)}))}),[]),It.log({serviceUUIDs:Ut,optionalServiceUUIDs:Ot,characteristicUUIDs:Bt,allCharacteristicUUIDs:zt});const jt=k("BluetoothConnectionManager",{log:!0});class Vt extends St{constructor(){super(...arguments),this.isInRange=!0}onCharacteristicValueChanged(e,t){switch(e){case"batteryLevel":case"firmwareRevision":case"hardwareRevision":case"manufacturerName":case"modelNumber":case"pnpId":case"serialNumber":case"softwareRevision":case"tapData":case"mouseData":case"airGesture":case"tx":this.onMessageReceived?.(e,t)}}async writeCharacteristic(e,t){jt.log("writeCharacteristic",...arguments)}async sendUICommandsData(e){super.sendUICommandsData(e),await this.writeCharacteristic("uiCommands",e)}async sendRxData(e){super.sendRxData(e),await this.writeCharacteristic("rx",e)}}var _t,Pt,qt,Qt,Jt,Kt,Xt,Ht,Yt,Zt,es;const ts=k("WebBluetoothConnectionManager",{log:!0});var ss,is,ns;i&&(ss=window.navigator.bluetooth);class rs extends Vt{constructor(){super(...arguments),_t.add(this),Pt.set(this,{characteristicvaluechanged:e(this,_t,"m",Yt).bind(this)}),qt.set(this,{gattserverdisconnected:e(this,_t,"m",es).bind(this)}),Qt.set(this,void 0),Jt.set(this,new Map),Kt.set(this,new Map)}get bluetoothId(){return this.device?.id||""}get name(){return this.device?.name||""}static get isSupported(){return Boolean(ss)}static get type(){return"webBluetooth"}get device(){return e(this,Qt,"f")}set device(s){e(this,Qt,"f")!=s?(e(this,Qt,"f")&&Wt(e(this,Qt,"f"),e(this,qt,"f")),s&&kt(s,e(this,qt,"f")),t(this,Qt,s,"f")):ts.log("tried to assign the same BluetoothDevice")}get server(){return e(this,Qt,"f")?.gatt}get isConnected(){return this.server?.connected||!1}async connect(){await super.connect();try{const t=await ss.requestDevice({filters:[{services:Ut}],optionalServices:i?Ot:[]});ts.log("got BluetoothDevice"),this.device=t,ts.log("connecting to device...");const s=await this.server.connect();ts.log(`connected to device? ${s.connected}`),await e(this,_t,"m",Xt).call(this),ts.log("fully connected"),this.status="connected"}catch(t){ts.error(t),this.status="notConnected",this.server?.disconnect(),e(this,_t,"m",Ht).call(this)}}async disconnect(){await e(this,_t,"m",Ht).call(this),await super.disconnect(),this.server?.disconnect(),this.status="notConnected"}async writeCharacteristic(t,s){super.writeCharacteristic(t,s);const i=e(this,Kt,"f").get(t);ts.assertWithError(i,`${t} characteristic not found`),ts.log("writing characteristic",i,s);const n=i.properties||Nt(t);n.writeWithoutResponse?(ts.log("writing without response"),await i.writeValueWithoutResponse(s)):(ts.log("writing with response"),await i.writeValueWithResponse(s)),ts.log("wrote characteristic"),n.read&&!n.notify&&(ts.log("reading value after write..."),await i.readValue(),(o||c)&&e(this,_t,"m",Zt).call(this,i))}get canReconnect(){return Boolean(this.server&&!this.server.connected&&this.isInRange)}async reconnect(){await super.reconnect(),ts.log("attempting to reconnect..."),this.status="connecting";try{await this.server.connect()}catch(e){ts.error(e),this.isInRange=!1}this.isConnected?(ts.log("successfully reconnected!"),await e(this,_t,"m",Xt).call(this),this.status="connected"):(ts.log("unable to reconnect"),this.status="notConnected")}}function as(e,t=0,s=1){return Math.max(t,Math.min(s,e))}Pt=new WeakMap,qt=new WeakMap,Qt=new WeakMap,Jt=new WeakMap,Kt=new WeakMap,_t=new WeakSet,Xt=async function(){e(this,_t,"m",Ht).call(this),ts.log("getting services...");const t=await this.server.getPrimaryServices();ts.log("got services",t);const s=await this.server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");ts.log("got nus service",s),ts.log("getting characteristics...");for(const s in t){const i=t[s];ts.log({service:i});const n=Gt(i.uuid);ts.assertWithError(n,`no name found for service uuid "${i.uuid}"`),ts.log(`got "${n}" service`),i.name=n,e(this,Jt,"f").set(n,i),ts.log(`getting characteristics for "${n}" service`);const r=await i.getCharacteristics();ts.log(`got characteristics for "${n}" service`);for(const t in r){const s=r[t];ts.log({characteristic:s});const i=Ft(s.uuid);ts.assertWithError(Boolean(i),`no name found for characteristic uuid "${s.uuid}" in "${n}" service`),ts.log(`got "${i}" characteristic in "${n}" service`),s.name=i,e(this,Kt,"f").set(i,s),kt(s,e(this,Pt,"f"));const a=s.properties||Nt(i);a.notify&&(ts.log(`starting notifications for "${i}" characteristic`),await s.startNotifications()),a.read&&(ts.log(`reading "${i}" characteristic...`),await s.readValue(),(o||c)&&e(this,_t,"m",Zt).call(this,s))}}},Ht=async function(){this.device&&Wt(this.device,e(this,qt,"f"));const t=Array.from(e(this,Kt,"f").keys()).map((t=>{const s=e(this,Kt,"f").get(t);Wt(s,e(this,Pt,"f"));if((s.properties||Nt(t)).notify)return ts.log(`stopping notifications for "${t}" characteristic`),s.stopNotifications()}));return Promise.allSettled(t)},Yt=function(t){ts.log("oncharacteristicvaluechanged");const s=t.target;e(this,_t,"m",Zt).call(this,s)},Zt=function(e){ts.log("onCharacteristicValue");const t=e.name;ts.assertWithError(Boolean(t),`no name found for characteristic with uuid "${e.uuid}"`),ts.log(`oncharacteristicvaluechanged for "${t}" characteristic`);const s=e.value;ts.assertWithError(s,`no data found for "${t}" characteristic`),ts.log(`data for "${t}" characteristic`,Array.from(new Uint8Array(s.buffer)));try{this.onCharacteristicValueChanged(t,s)}catch(e){ts.error(e)}},es=function(){ts.log("gattserverdisconnected"),this.status="notConnected"},k("MathUtils",{log:!0});const os=k("VibrationManager"),cs=9,hs=18;class ls{constructor(){is.add(this),K(this)}async vibrate(t){os.log("triggering vibration segments",t);const s=e(this,is,"m",ns).call(this,t);await this.sendUICommandsData(s?.buffer)}}var us,ds,fs,gs,vs,ms,ps,ws,ys,bs,Ms,Es,Ds,Ss,Cs,ks;is=new WeakSet,ns=function(e){const t=new DataView(new ArrayBuffer(20));let s=0;t.setUint8(s++,0),t.setUint8(s++,2);for(let s=0;s<e.length&&s<18;s++){let i=e[s];i/=10,i=as(i,0,255),os.log(`vibration segment #${s}: ${i}`),t.setUint8(2+s,i)}return t};const Ws=k("DeviceManager",{log:!0}),Is=["deviceConnected","deviceDisconnected","deviceIsConnected","availableDevices","connectedDevices"];class xs{constructor(){if(us.add(this),ds.set(this,{isConnected:e(this,us,"m",Ss).bind(this)}),fs.set(this,[]),gs.set(this,!1),vs.set(this,{devices:[]}),ms.set(this,void 0),ws.set(this,"TS.Device"),Ms.set(this,[]),Es.set(this,new A(this,Is)),xs.shared&&this!=xs.shared)throw Error("DeviceManager is a singleton - use DeviceManager.shared");this.CanUseLocalStorage&&(this.UseLocalStorage=!0)}onDevice(t){kt(t,e(this,ds,"f"))}OnDeviceConnectionStatusUpdated(t,s){if("notConnected"==s&&!t.canReconnect&&e(this,Ms,"f").includes(t)){const s=e(this,Ms,"f").indexOf(t);this.AvailableDevices.splice(s,1),e(this,us,"m",Cs).call(this)}}get ConnectedDevices(){return e(this,fs,"f")}get UseLocalStorage(){return e(this,gs,"f")}set UseLocalStorage(s){e(this,us,"m",ps).call(this),Ws.assertTypeWithError(s,"boolean"),t(this,gs,s,"f"),e(this,gs,"f")&&!e(this,ms,"f")&&e(this,us,"m",bs).call(this)}get CanUseLocalStorage(){return i&&window.localStorage}get AvailableDevices(){return e(this,Ms,"f")}get CanGetDevices(){return i&&navigator.bluetooth?.getDevices}async GetDevices(){if(!i)return void Ws.warn("GetDevices is only available in the browser");if(!navigator.bluetooth)return void Ws.warn("bluetooth is not available in this browser");if(o)return void Ws.warn("bluefy lists too many devices...");if(!navigator.bluetooth.getDevices)return void Ws.warn("bluetooth.getDevices() is not available in this browser");if(!this.CanGetDevices)return void Ws.log("CanGetDevices is false");e(this,ms,"f")||e(this,us,"m",bs).call(this);const t=e(this,ms,"f");if(!t.devices||0==t.devices.length)return void Ws.log("no devices found in configuration");const s=await navigator.bluetooth.getDevices();return Ws.log({bluetoothDevices:s}),s.forEach((s=>{if(!s.gatt)return;if(!t.devices.find((e=>s.id==e.bluetoothId)))return;let i=this.ConnectedDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));const n=this.AvailableDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==s.id));if(n)return void(i&&i?.bluetoothId==n.bluetoothId&&i!=n&&(this.AvailableDevices[e(this,Ms,"f").indexOf(n)]=i));if(i)return void this.AvailableDevices.push(i);const r=new Ri,a=new rs;a.device=s,s.name,r.connectionManager=a,this.AvailableDevices.push(r)})),e(this,us,"m",Cs).call(this),this.AvailableDevices}get AddEventListener(){return e(this,Es,"f").addEventListener}get RemoveEventListener(){return e(this,Es,"f").removeEventListener}get RemoveEventListeners(){return e(this,Es,"f").removeEventListeners}get RemoveAllEventListeners(){return e(this,Es,"f").removeAllEventListeners}}ds=new WeakMap,fs=new WeakMap,gs=new WeakMap,vs=new WeakMap,ms=new WeakMap,ws=new WeakMap,Ms=new WeakMap,Es=new WeakMap,us=new WeakSet,ps=function(){Ws.assertWithError(i,"localStorage is only available in the browser"),Ws.assertWithError(window.localStorage,"localStorage not found")},ys=function(){e(this,us,"m",ps).call(this),localStorage.setItem(e(this,ws,"f"),JSON.stringify(e(this,ms,"f")))},bs=async function(){e(this,us,"m",ps).call(this);let s=localStorage.getItem(e(this,ws,"f"));if("string"!=typeof s)return Ws.log("no info found in localStorage"),t(this,ms,Object.assign({},e(this,vs,"f")),"f"),void e(this,us,"m",ys).call(this);try{const e=JSON.parse(s);Ws.log({configuration:e}),t(this,ms,e,"f"),this.CanGetDevices&&await this.GetDevices()}catch(e){Ws.error(e)}},Ds=function(){return e(this,Es,"f").dispatchEvent},Ss=function(t){const{target:s}=t;if(s.isConnected)if(e(this,fs,"f").includes(s))Ws.log("device already included");else{if(Ws.log("adding device",s),e(this,fs,"f").push(s),this.UseLocalStorage&&"webBluetooth"==s.connectionType){const t={bluetoothId:s.bluetoothId},i=e(this,ms,"f").devices.findIndex((e=>e.bluetoothId==t.bluetoothId));-1==i?e(this,ms,"f").devices.push(t):e(this,ms,"f").devices[i]=t,e(this,us,"m",ys).call(this)}e(this,us,"a",Ds).call(this,"deviceConnected",{device:s}),e(this,us,"a",Ds).call(this,"deviceIsConnected",{device:s}),e(this,us,"m",ks).call(this)}else e(this,fs,"f").includes(s)?(Ws.log("removing device",s),e(this,fs,"f").splice(e(this,fs,"f").indexOf(s),1),e(this,us,"a",Ds).call(this,"deviceDisconnected",{device:s}),e(this,us,"a",Ds).call(this,"deviceIsConnected",{device:s}),e(this,us,"m",ks).call(this)):Ws.log("device already not included");if(this.CanGetDevices&&this.GetDevices(),s.isConnected&&!this.AvailableDevices.includes(s)){const t=this.AvailableDevices.find((e=>e.bluetoothId==s.bluetoothId));Ws.log({existingAvailableDevice:t}),t?this.AvailableDevices[this.AvailableDevices.indexOf(t)]=s:this.AvailableDevices.push(s),e(this,us,"m",Cs).call(this)}},Cs=function(){Ws.log({AvailableDevices:this.AvailableDevices}),e(this,us,"a",Ds).call(this,"availableDevices",{availableDevices:this.AvailableDevices})},ks=function(){Ws.log({ConnectedDevices:this.ConnectedDevices}),e(this,us,"a",Ds).call(this,"connectedDevices",{connectedDevices:this.ConnectedDevices})},xs.shared=new xs;var As,Rs,Ls,Ts,$s,Us,Os,Gs=xs.shared;const Bs=k("InputManager"),zs=["controller","text","rawSensor","controllerWithMouse","controllerWithMouseAndKeyboard"],Fs={controller:1,text:0,rawSensor:10,controllerWithMouse:3,controllerWithMouseAndKeyboard:5};class Ns{constructor(){As.add(this),Rs.set(this,Object.assign({},We)),Ls.set(this,"controller"),Us.set(this,new U(e(this,As,"m",Os).bind(this),1e4)),K(this)}get sensitivity(){return e(this,Rs,"f")}set sensitivity(t){Object.assign(e(this,Rs,"f"),t)}setSensitivityForType(t,s){xe(t,s),Bs.log(`setting ${t} sensitivity index to ${s}`),e(this,Rs,"f")[t]=s,e(this,Us,"f").restart(!0)}get mode(){return e(this,Ls,"f")}set mode(s){e(this,As,"m",Ts).call(this,s),this.mode!=s?(t(this,Ls,s,"f"),e(this,Us,"f").isRunning&&e(this,Us,"f").restart(!0)):Bs.log(`redundant mode assignment "${s}"`)}setMode(e){this.mode=e}start(){e(this,Us,"f").start(!0)}stop(){e(this,Us,"f").stop()}}var js,Vs,_s,Ps,qs,Qs;Rs=new WeakMap,Ls=new WeakMap,Us=new WeakMap,As=new WeakSet,Ts=function(e){Bs.assertEnumWithError(e,zs)},$s=function(){const e=Fs[this.mode];let t=[];var s;"rawSensor"==this.mode&&(Bs.assertWithError(this.sensitivity,"no sensitivity defined for rawSensor input mode"),s=this.sensitivity,Ce.forEach((e=>{xe(e,s[e])})),Ce.forEach((e=>{t.push(this.sensitivity[e])})));return Te(3,12,0,e,...t)},Os=function(){Bs.log("sending mode data...");const t=e(this,As,"m",$s).call(this);this.sendRxData(t)};const Js=k("XRStateManager"),Ks=["user","airMouse","tapping","dontSend"],Xs={user:3,airMouse:1,tapping:2};class Hs{constructor(){js.add(this),Vs.set(this,"user"),qs.set(this,new U(e(this,js,"m",Qs).bind(this),1e4)),K(this)}get state(){return e(this,Vs,"f")}set state(s){e(this,js,"m",_s).call(this,s),this.state!=s?(t(this,Vs,s,"f"),e(this,qs,"f").isRunning&&e(this,qs,"f").restart(!0)):Js.log(`redundant state assignment "${s}"`)}setState(e){this.state=e}start(){e(this,qs,"f").start(!0)}stop(){e(this,qs,"f").stop()}}var Ys,Zs,ei,ti,si,ii,ni,ri,ai,oi,ci,hi,li,ui,di,fi,gi,vi,mi,pi,wi,yi,bi,Mi,Ei,Di,Si,Ci,ki,Wi,Ii;Vs=new WeakMap,qs=new WeakMap,js=new WeakSet,_s=function(e){Js.assertEnumWithError(e,Ks)},Ps=function(){const e=Xs[this.state];Js.assert(null!=e,`no stateByte found for state "${this.state}"`);return Te(3,13,0,e)},Qs=function(){if("dontSend"==this.state)return;Js.log("sending state data...");const t=e(this,js,"m",Ps).call(this);this.sendRxData(t)};const xi=k("Device",{log:!0}),Ai=["connectionMessage",...Dt,"batteryLevel",...Q,...re,...fe,...Ee,...lt];class Ri{get bluetoothId(){return e(this,ii,"f")?.bluetoothId}get name(){return e(this,ii,"f")?.name}constructor(){Ys.add(this),ti.set(this,new A(this,Ai)),ii.set(this,void 0),this.sendUICommandsData=e(this,Ys,"m",ni).bind(this),this.sendRxData=e(this,Ys,"m",ri).bind(this),ai.set(this,!1),li.set(this,Zs.ReconnectOnDisconnection),ui.set(this,void 0),this.latestConnectionMessage=new Map,wi.set(this,new J),yi.set(this,0),Mi.set(this,new Ns),Ei.set(this,new Hs),Di.set(this,new oe),Si.set(this,new ge),Ci.set(this,new De),ki.set(this,new ut),Wi.set(this,new ls),Ii.set(this,!1),e(this,wi,"f").eventDispatcher=e(this,ti,"f"),e(this,Mi,"f").sendRxData=this.sendRxData,e(this,Ei,"f").sendRxData=this.sendRxData,e(this,Di,"f").eventDispatcher=e(this,ti,"f"),e(this,Si,"f").eventDispatcher=e(this,ti,"f"),e(this,Ci,"f").eventDispatcher=e(this,ti,"f"),e(this,ki,"f").eventDispatcher=e(this,ti,"f"),e(this,Wi,"f").sendUICommandsData=this.sendUICommandsData,e(this,ki,"f").rawSensorSensitivity=e(this,Mi,"f").sensitivity,this.addEventListener("hardwareRevision",(()=>{})),this.addEventListener("isInAirGestureState",(t=>{e(this,Di,"f").isInAirGestureState=t.message.isInAirGestureState})),this.addEventListener("isConnected",(()=>{this.isConnected?(setTimeout((()=>{e(this,Mi,"f").start()}),0),setTimeout((()=>{}),20)):(e(this,Mi,"f").stop(),e(this,Ei,"f").stop())})),Gs.onDevice(this),i&&window.addEventListener("beforeunload",(()=>{this.isConnected})),n&&process.on("exit",(()=>{this.isConnected}))}get addEventListener(){return e(this,ti,"f").addEventListener}get removeEventListener(){return e(this,ti,"f").removeEventListener}get waitForEvent(){return e(this,ti,"f").waitForEvent}get removeEventListeners(){return e(this,ti,"f").removeEventListeners}get removeAllEventListeners(){return e(this,ti,"f").removeAllEventListeners}get connectionManager(){return e(this,ii,"f")}set connectionManager(s){this.connectionManager!=s?(this.connectionManager&&(this.connectionManager.onStatusUpdated=void 0,this.connectionManager.onMessageReceived=void 0,this.connectionManager.onMessagesReceived=void 0),s&&(s.onStatusUpdated=e(this,Ys,"m",di).bind(this),s.onMessageReceived=e(this,Ys,"m",mi).bind(this),s.onMessagesReceived=e(this,Ys,"m",pi).bind(this)),t(this,ii,s,"f"),xi.log("assigned new connectionManager",e(this,ii,"f"))):xi.log("same connectionManager is already assigned")}async connect(){return this.connectionManager||(this.connectionManager=e(Zs,Zs,"m",ei).call(Zs)),e(this,Ys,"m",vi).call(this),this.connectionManager.connect()}get isConnected(){return e(this,ai,"f")}get canReconnect(){return this.connectionManager?.canReconnect}async reconnect(){return e(this,Ys,"m",ci).call(this),e(this,Ys,"m",vi).call(this),this.connectionManager?.reconnect()}static async Connect(){const e=new Zs;return await e.connect(),e}static get ReconnectOnDisconnection(){return e(this,Zs,"f",hi)}static set ReconnectOnDisconnection(e){xi.assertTypeWithError(e,"boolean"),t(this,Zs,e,"f",hi)}get reconnectOnDisconnection(){return e(this,li,"f")}set reconnectOnDisconnection(e){xi.assertTypeWithError(e,"boolean"),t(this,li,e,"f")}get connectionType(){return this.connectionManager?.type}async disconnect(){return e(this,Ys,"m",oi).call(this),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.addEventListener("isConnected",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this.connectionManager.disconnect()}toggleConnection(){this.isConnected?this.disconnect():this.canReconnect?this.reconnect():this.connect()}get connectionStatus(){switch(e(this,ii,"f")?.status){case"connected":return this.isConnected?"connected":"connecting";case"notConnected":case"connecting":case"disconnecting":return e(this,ii,"f").status;default:return"notConnected"}}get isConnectionBusy(){return"connecting"==this.connectionStatus||"disconnecting"==this.connectionStatus}get deviceInformation(){return e(this,wi,"f").information}get batteryLevel(){return e(this,yi,"f")}get inputMode(){return e(this,Mi,"f").mode}set inputMode(e){this.setInputMode(e)}get setInputMode(){return e(this,Mi,"f").setMode}get setSensitivityForType(){return e(this,Mi,"f").setSensitivityForType}get xrState(){return e(this,Ei,"f").state}set xrState(e){this.setXRState(e)}get setXRState(){return e(this,Ei,"f").setState}get vibrate(){return e(this,Wi,"f").vibrate}get isServerSide(){return e(this,Ii,"f")}set isServerSide(s){e(this,Ii,"f")!=s?(xi.log({newIsServerSide:s}),t(this,Ii,s,"f")):xi.log("redundant isServerSide assignment")}}var Li,Ti,$i;Zs=Ri,ti=new WeakMap,ii=new WeakMap,ai=new WeakMap,li=new WeakMap,ui=new WeakMap,wi=new WeakMap,yi=new WeakMap,Mi=new WeakMap,Ei=new WeakMap,Di=new WeakMap,Si=new WeakMap,Ci=new WeakMap,ki=new WeakMap,Wi=new WeakMap,Ii=new WeakMap,Ys=new WeakSet,ei=function(){return new rs},si=function(){return e(this,ti,"f").dispatchEvent},ni=async function(t){await(e(this,ii,"f")?.sendUICommandsData(t))},ri=async function(t){await(e(this,ii,"f")?.sendRxData(t))},oi=function(){xi.assertWithError(this.isConnected,"notConnected")},ci=function(){xi.assertWithError(this.canReconnect,"cannot reconnect to device")},di=function(s){xi.log({connectionStatus:s}),"notConnected"==s?this.canReconnect&&this.reconnectOnDisconnection&&(xi.log("starting reconnect interval..."),t(this,ui,setInterval((()=>{xi.log("attempting reconnect..."),this.reconnect()}),1e3),"f")):null!=e(this,ui,"f")&&(xi.log("clearing reconnect interval"),clearInterval(e(this,ui,"f")),t(this,ui,void 0,"f")),e(this,Ys,"m",gi).call(this),"connected"==s&&e(this,ai,"f"),Gs.OnDeviceConnectionStatusUpdated(this,s)},fi=function(t=!1){e(this,Ys,"a",si).call(this,"connectionStatus",{connectionStatus:this.connectionStatus}),e(this,Ys,"a",si).call(this,this.connectionStatus,{}),t&&e(this,Ys,"a",si).call(this,"isConnected",{isConnected:this.isConnected})},gi=function(){switch(t(this,ai,Boolean(this.connectionManager?.isConnected),"f"),this.connectionStatus){case"connected":e(this,ai,"f")&&e(this,Ys,"m",fi).call(this,!0);break;case"notConnected":e(this,Ys,"m",fi).call(this,!0);break;default:e(this,Ys,"m",fi).call(this,!1)}},vi=function(){this.latestConnectionMessage.clear(),e(this,wi,"f").clear(),e(this,ki,"f").clear()},mi=function(t,s){if(xi.log({messageType:t,dataView:s}),"batteryLevel"===t){const t=s.getUint8(0);xi.log("received battery level",{batteryLevel:t}),e(this,Ys,"m",bi).call(this,t)}else if(q.includes(t))e(this,wi,"f").parseMessage(t,s);else if(ne.includes(t))e(this,Di,"f").parseMessage(t,s);else if(de.includes(t))e(this,Si,"f").parseMessage(t,s);else if(Me.includes(t))e(this,Ci,"f").parseMessage(t,s);else{if(!ht.includes(t))throw Error(`uncaught messageType "${t}"`);e(this,ki,"f").parseMessage(t,s)}this.latestConnectionMessage.set(t,s),e(this,Ys,"a",si).call(this,"connectionMessage",{messageType:t,dataView:s})},pi=function(){this.isConnected||e(this,Ys,"m",gi).call(this)},bi=function(s){xi.assertTypeWithError(s,"number"),e(this,yi,"f")!=s?(t(this,yi,s,"f"),xi.log({updatedBatteryLevel:e(this,yi,"f")}),e(this,Ys,"a",si).call(this,"batteryLevel",{batteryLevel:e(this,yi,"f")})):xi.log(`duplicate batteryLevel assignment ${s}`)},hi={value:!1};const Ui={min:1/0,max:-1/0,span:0};class Oi{constructor(){Li.add(this),Ti.set(this,Object.assign({},Ui))}get min(){return e(this,Ti,"f").min}get max(){return e(this,Ti,"f").max}set min(t){e(this,Ti,"f").min=t,e(this,Ti,"f").max=Math.max(t,e(this,Ti,"f").max),e(this,Li,"m",$i).call(this)}set max(t){e(this,Ti,"f").max=t,e(this,Ti,"f").min=Math.min(t,e(this,Ti,"f").min),e(this,Li,"m",$i).call(this)}reset(){Object.assign(e(this,Ti,"f"),Ui)}update(t){e(this,Ti,"f").min=Math.min(t,e(this,Ti,"f").min),e(this,Ti,"f").max=Math.max(t,e(this,Ti,"f").max),e(this,Li,"m",$i).call(this)}getNormalization(t,s){let i=function(e,t,s,i){return null==i&&(i=s-t),(e-t)/i}(t,e(this,Ti,"f").min,e(this,Ti,"f").max,e(this,Ti,"f").span);return s&&(i*=e(this,Ti,"f").span),i||0}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}}Ti=new WeakMap,Li=new WeakSet,$i=function(){e(this,Ti,"f").span=e(this,Ti,"f").max-e(this,Ti,"f").min};export{Ri as Device,Gs as DeviceManager,w as Environment,zs as InputModes,hs as MaxNumberOfVibrationSegments,cs as MaxNumberOfVibrations,Oi as RangeHelper,ke as RawSensorSensitivityFactors,Ce as RawSensorTypes,Ks as XRStates,I as setAllConsoleLevelFlags,W as setConsoleLevelFlagsForType};
//# sourceMappingURL=tapstrap.module.min.js.map
