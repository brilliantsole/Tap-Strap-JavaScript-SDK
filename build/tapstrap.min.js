/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TS={})}(this,(function(e){"use strict";function t(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)}function i(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i}"function"==typeof SuppressedError&&SuppressedError;const n=!1,s="undefined"!=typeof window&&void 0!==window?.document,r="undefined"!=typeof process&&null!=process?.versions?.node,o=s&&navigator.userAgent||"";let a=!1;s?a=Boolean(navigator.bluetooth):r&&(a=!0);const c=s&&/Bluefy/i.test(o),h=s&&/WebBLE/i.test(o),l=s&&/Android/i.test(o),d=s&&/Safari/i.test(o)&&!/Chrome/i.test(o),u=s&&/iPad|iPhone|iPod/i.test(o),f=s&&/Macintosh/i.test(o),g=!s&&!r&&"undefined"!=typeof global&&"undefined"!=typeof Studio;var v,m,p,w,b=Object.freeze({__proto__:null,isAndroid:l,get isBluetoothSupported(){return a},isIOS:u,isInBluefy:c,isInBrowser:s,isInDev:n,isInLensStudio:g,isInNode:r,isInProduction:!0,isInWebBLE:h,isMac:f,isSafari:d});if(g){const e=function(...e){Studio.log(e.map((e=>new String(e))).join(","))};(w={}).log=e,w.warn=e.bind(w,"WARNING"),w.error=e.bind(w,"ERROR")}else w=console;if(!w.assert){const e=(e,...t)=>{e||w.warn(...t)};w.assert=e}if(!w.table){const e=(...e)=>{w.log(...e)};w.table=e}function y(){}const E=w.log.bind(w),M=w.warn.bind(w),C=w.error.bind(w),D=w.table.bind(w),W=w.assert.bind(w);class L{constructor(e){if(p.set(this,{log:n,warn:n,assert:!0,error:!0,table:!0}),t(v,v,"f",m)[e])throw new Error(`"${e}" console already exists`);t(v,v,"f",m)[e]=this}setLevelFlags(e){Object.assign(t(this,p,"f"),e)}static setLevelFlagsForType(e,i){if(!t(this,v,"f",m)[e])throw new Error(`no console found with type "${e}"`);t(this,v,"f",m)[e].setLevelFlags(i)}static setAllLevelFlags(e){for(const i in t(this,v,"f",m))t(this,v,"f",m)[i].setLevelFlags(e)}static create(e,i){return t(this,v,"f",m)[e]||new v(e)}get log(){return t(this,p,"f").log?E:y}get warn(){return t(this,p,"f").warn?M:y}get error(){return t(this,p,"f").error?C:y}get assert(){return t(this,p,"f").assert?W:y}get table(){return t(this,p,"f").table?D:y}assertWithError(e,t){if(!Boolean(e))throw new Error(t)}assertTypeWithError(e,t){this.assertWithError(typeof e==t,`value ${e} of type "${typeof e}" not of type "${t}"`)}assertEnumWithError(e,t){this.assertWithError(t.includes(e),`invalid enum "${e}"`)}}function S(e,t){return L.create(e,t)}v=L,p=new WeakMap,m={value:{}};const R=S("EventDispatcher",{log:!1});class I{constructor(e,t){this.target=e,this.validEventTypes=t,this.listeners={},this.addEventListener=this.addEventListener.bind(this),this.removeEventListener=this.removeEventListener.bind(this),this.removeEventListeners=this.removeEventListeners.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.dispatchEvent=this.dispatchEvent.bind(this),this.waitForEvent=this.waitForEvent.bind(this)}isValidEventType(e){return this.validEventTypes.includes(e)}updateEventListeners(e){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((t=>(t.shouldRemove&&R.log(`removing "${e}" eventListener`,t),!t.shouldRemove))))}addEventListener(e,t,i={once:!1}){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]||(this.listeners[e]=[],R.log(`creating "${e}" listeners array`,this.listeners[e]));this.listeners[e].find((e=>e.listener==t&&e.once==i.once))?R.log("already added listener"):(R.log(`adding "${e}" listener`,t,i),this.listeners[e].push({listener:t,once:i.once}),R.log(`currently have ${this.listeners[e].length} "${e}" listeners`))}removeEventListener(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(R.log(`removing "${e}" listener...`,t),this.listeners[e].forEach((i=>{i.listener===t&&(R.log(`flagging "${e}" listener`,t),i.shouldRemove=!0)})),this.updateEventListeners(e))}removeEventListeners(e){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(R.log(`removing "${e}" listeners...`),this.listeners[e]=[])}removeAllEventListeners(){R.log("removing listeners..."),this.listeners={}}dispatchEvent(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(this.listeners[e].forEach((i=>{i.shouldRemove||(R.log(`dispatching "${e}" listener`,i),i.listener({type:e,target:this.target,message:t}),i.once&&(R.log(`flagging "${e}" listener`,i),i.shouldRemove=!0))})),this.updateEventListeners(e))}waitForEvent(e){return new Promise((t=>{this.addEventListener(e,(e=>{t(e)}),{once:!0})}))}}var x,k,T;const A=S("Timer",{log:!1});class ${get callback(){return t(this,x,"f")}set callback(e){A.assertTypeWithError(e,"function"),A.log({newCallback:e}),i(this,x,e,"f"),this.isRunning&&this.restart()}get interval(){return t(this,k,"f")}set interval(e){A.assertTypeWithError(e,"number"),A.assertWithError(e>0,"interval must be above 0"),A.log({newInterval:e}),i(this,k,e,"f"),this.isRunning&&this.restart()}constructor(e,t){x.set(this,void 0),k.set(this,void 0),T.set(this,void 0),this.interval=t,this.callback=e}get isRunning(){return null!=t(this,T,"f")}start(){this.isRunning?A.log("interval already running"):(A.log("starting interval"),i(this,T,setInterval(t(this,x,"f"),t(this,k,"f")),"f"))}stop(){this.isRunning?(A.log("stopping interval"),clearInterval(t(this,T,"f")),i(this,T,void 0,"f")):A.log("interval already not running")}restart(){this.stop(),this.start()}}var O,B;x=new WeakMap,k=new WeakMap,T=new WeakMap,O="undefined"==typeof TextEncoder?class{encode(e){const t=Array.from(e).map((e=>e.charCodeAt(0)));return Uint8Array.from(t)}}:TextEncoder,B="undefined"==typeof TextDecoder?class{decode(e){return Array.from(new Uint8Array(e)).map((e=>String.fromCharCode(e))).join("")}}:TextDecoder;const U=new O,V=new B,N=S("ArrayBufferUtils",{log:!1});function j(...e){const t=(e=(e=(e=e.filter((e=>null!=e||null!=e))).map((e=>{if("number"==typeof e){const t=e;return Uint8Array.from([Math.floor(t)])}if("boolean"==typeof e){const t=e;return Uint8Array.from([t?1:0])}if("string"==typeof e){return _(e)}if(e instanceof Array){return j(...e)}if(e instanceof ArrayBuffer)return e;if("buffer"in e&&e.buffer instanceof ArrayBuffer){return e.buffer}if(e instanceof DataView){return e.buffer}if("object"==typeof e){return function(e){return _(JSON.stringify(e))}(e)}return e}))).filter((e=>e&&"byteLength"in e))).reduce(((e,t)=>e+t.byteLength),0),i=new Uint8Array(t);let n=0;return e.forEach((e=>{i.set(new Uint8Array(e),n),n+=e.byteLength})),i.buffer}function _(e){const t=U.encode(e);return j(t.byteLength,t)}function F(e,t,i){let n;return null!=i&&(n=e.byteOffset+t+i),N.log({dataView:e,begin:t,end:n,length:i}),new DataView(e.buffer.slice(e.byteOffset+t,n))}const P=S("ParseUtils",{log:!0});var G,z,J,q,H;const K=S("DeviceInformationManager",{log:!0}),Q=["manufacturerName","modelNumber","softwareRevision","hardwareRevision","firmwareRevision","pnpId","serialNumber"],X=[...Q,"deviceInformation"];class Y{constructor(){G.add(this),J.set(this,{})}get information(){return t(this,J,"f")}clear(){i(this,J,{},"f")}parseMessage(e,i){switch(K.log({messageType:e}),e){case"manufacturerName":const n=V.decode(i.buffer);K.log({manufacturerName:n}),t(this,G,"m",H).call(this,{manufacturerName:n});break;case"modelNumber":const s=V.decode(i.buffer);K.log({modelNumber:s}),t(this,G,"m",H).call(this,{modelNumber:s});break;case"softwareRevision":const r=V.decode(i.buffer);K.log({softwareRevision:r}),t(this,G,"m",H).call(this,{softwareRevision:r});break;case"hardwareRevision":const o=V.decode(i.buffer);K.log({hardwareRevision:o}),t(this,G,"m",H).call(this,{hardwareRevision:o});break;case"firmwareRevision":const a=V.decode(i.buffer);K.log({firmwareRevision:a}),t(this,G,"m",H).call(this,{firmwareRevision:a});break;case"pnpId":const c={source:1===i.getUint8(0)?"Bluetooth":"USB",productId:i.getUint16(3,!0),productVersion:i.getUint16(5,!0),vendorId:0};"Bluetooth"==c.source&&(c.vendorId=i.getUint16(1,!0)),K.log({pnpId:c}),t(this,G,"m",H).call(this,{pnpId:c});break;case"serialNumber":const h=V.decode(i.buffer);K.log({serialNumber:h});break;default:throw Error(`uncaught messageType ${e}`)}}}J=new WeakMap,G=new WeakSet,z=function(){return this.eventDispatcher.dispatchEvent},q=function(){return Q.every((e=>e in t(this,J,"f")))},H=function(e){K.log({partialDeviceInformation:e});Object.keys(e).forEach((i=>{t(this,G,"a",z).call(this,i,{[i]:e[i]})})),Object.assign(t(this,J,"f"),e),K.log({deviceInformation:t(this,J,"f")}),t(this,G,"a",q)&&(K.log("completed deviceInformation"),t(this,G,"a",z).call(this,"deviceInformation",{deviceInformation:this.information}))};function Z(e,{include:t,exclude:i}={}){const n=e=>{const n=t=>"string"==typeof t?e===t:t.test(e);return t?t.some(n):!i||!i.some(n)};for(const[t,i]of(e=>{const t=new Set;do{for(const i of Reflect.ownKeys(e))t.add([e,i])}while((e=Reflect.getPrototypeOf(e))&&e!==Object.prototype);return t})(e.constructor.prototype)){if("constructor"===i||!n(i))continue;const s=Reflect.getOwnPropertyDescriptor(t,i);s&&"function"==typeof s.value&&(e[i]=e[i].bind(e))}return e}S("VibrationManager");class ee{constructor(){Z(this)}async triggerVibration(e){}}var te,ie,ne,se,re,oe,ae,ce,he,le,de,ue,fe,ge,ve;const me=S("BaseConnectionManager",{log:!0}),pe=["notConnected","connecting","connected","disconnecting"],we=[...pe,"connectionStatus","isConnected"],be=["triggerVibration"],ye=["batteryLevel"],Ee=["rx","tx"];class Me{get baseConstructor(){return this.constructor}static get isSupported(){return!1}get isSupported(){return this.baseConstructor.isSupported}get type(){return this.baseConstructor.type}constructor(){te.add(this),re.set(this,"notConnected"),de.set(this,[]),ue.set(this,!1),ge.set(this,new $(t(this,te,"m",ve).bind(this),5e3)),t(this,te,"m",se).call(this)}get status(){return t(this,re,"f")}set status(e){me.assertEnumWithError(e,pe),t(this,re,"f")!=e?(me.log(`new connection status "${e}"`),i(this,re,e,"f"),this.onStatusUpdated(this.status),this.isConnected?t(this,ge,"f").start():t(this,ge,"f").stop(),"notConnected"==t(this,re,"f")&&(this.mtu=void 0)):me.log(`tried to assign same connection status "${e}"`)}get isConnected(){return"connected"==this.status}async connect(){t(this,te,"m",oe).call(this),t(this,te,"m",ae).call(this),this.status="connecting"}get canReconnect(){return!1}async reconnect(){t(this,te,"m",oe).call(this),t(this,te,"m",ae).call(this),me.assert(this.canReconnect,"unable to reconnect")}async disconnect(){t(this,te,"m",ce).call(this),t(this,te,"m",he).call(this),this.status="disconnecting",me.log("disconnecting from device...")}async sendSmpMessage(e){t(this,te,"m",le).call(this),me.log("sending smp message",e)}async sendTxMessages(e,n=!0){if(t(this,te,"m",le).call(this),e&&t(this,de,"f").push(...e),!n)return;if(t(this,ue,"f"))return;i(this,ue,!0,"f"),me.log("sendTxMessages",t(this,de,"f").slice());const s=t(this,de,"f").map((e=>{t(ie,ie,"m",ne).call(ie,e.type);const i=be.indexOf(e.type),n=new DataView(new ArrayBuffer(2));return n.setUint16(0,e.data?.byteLength||0,!0),j(i,n,e.data)}));if(this.mtu)for(;s.length>0;){let e=0,t=0;s.some((i=>{if(e+i.byteLength>this.mtu-3)return!0;t++,e+=i.byteLength}));const i=s.splice(0,t);me.log({arrayBufferCount:t,arrayBuffersToSend:i});const n=j(...i);me.log("sending arrayBuffer",n),await this.sendTxData(n)}else{const e=j(...s);me.log("sending arrayBuffer",e),await this.sendTxData(e)}t(this,de,"f").length=0,i(this,ue,!1,"f")}async sendTxData(e){me.log("sendTxData",e)}parseRxMessage(e){!function(e,t,i,n,s=!1){let r=0;for(;r<e.byteLength;){const o=e.getUint8(r++);P.assertWithError(o in t,`invalid messageTypeEnum ${o}`);const a=t[o];let c;s?(c=e.getUint16(r,!0),r+=2):c=e.getUint8(r++),P.log({messageTypeEnum:o,messageType:a,messageLength:c,dataView:e,byteOffset:r});const h=F(e,r,c);P.log({_dataView:h}),i(a,h,n),r+=c}}(e,be,t(this,te,"m",fe).bind(this),null,!0),this.onMessagesReceived()}}ie=Me,re=new WeakMap,de=new WeakMap,ue=new WeakMap,ge=new WeakMap,te=new WeakSet,ne=function(e){me.assertEnumWithError(e,be)},se=function(){me.assertWithError(this.isSupported,`${this.constructor.name} is not supported`)},oe=function(){me.assertWithError(!this.isConnected,"device is already connected")},ae=function(){me.assertWithError("connecting"!=this.status,"device is already connecting")},ce=function(){me.assertWithError(this.isConnected,"device is not connected")},he=function(){me.assertWithError("disconnecting"!=this.status,"device is already disconnecting")},le=function(){t(this,te,"m",ce).call(this),t(this,te,"m",he).call(this)},fe=function(e,t){me.log({messageType:e,dataView:t}),this.onMessageReceived(e,t)},ve=function(){this.isConnected||(me.log("timer detected disconnection"),this.status="notConnected")};const Ce=S("EventUtils",{log:!1});function De(e,t){let i=e.addEventListener||e.addListener||e.on||e.AddEventListener;Ce.assertWithError(i,"no add listener function found for target"),i=i.bind(e),Object.entries(t).forEach((([e,t])=>{i(e,t)}))}function We(e,t){let i=e.removeEventListener||e.removeListener||e.RemoveEventListener;Ce.assertWithError(i,"no remove listener function found for target"),i=i.bind(e),Object.entries(t).forEach((([e,t])=>{i(e,t)}))}const Le=S("bluetoothUUIDs",{log:!1});if(s)var Se=window.BluetoothUUID;function Re(e){return Le.assertTypeWithError(e,"string"),Le.assertWithError(4==e.length,"value must be 4 characters long"),`ea6da725-${e}-4f9b-893d-c3913e33b39f`}function Ie(e){return Se?.getCharacteristic?.(e)}function xe(e){return Se?.getService?.(e)}const ke=Object.freeze({services:{deviceInformation:{uuid:xe("device_information"),characteristics:{manufacturerName:{uuid:Ie("manufacturer_name_string")},modelNumber:{uuid:Ie("model_number_string")},hardwareRevision:{uuid:Ie("hardware_revision_string")},firmwareRevision:{uuid:Ie("firmware_revision_string")},softwareRevision:{uuid:Ie("software_revision_string")},pnpId:{uuid:Ie("pnp_id")},serialNumber:{uuid:Ie("serial_number_string")}}},battery:{uuid:xe("battery_service"),characteristics:{batteryLevel:{uuid:Ie("battery_level")}}},main:{uuid:Re("0000"),characteristics:{rx:{uuid:Re("1000")},tx:{uuid:Re("1001")}}},smp:{uuid:"8d53dc1d-1db7-4cd3-868b-8a527460aa84",characteristics:{smp:{uuid:"da2e7828-fbce-4e01-ae9e-261174997c48"}}}}}),Te=[ke.services.main.uuid],Ae=[ke.services.deviceInformation.uuid,ke.services.battery.uuid,ke.services.smp.uuid];function $e(e){e=e.toString().toLowerCase();return Object.keys(ke.services).find((t=>{let i=ke.services[t].uuid.toString();return 4==e.length&&(i=i.slice(4,8)),e.includes("-")||(i=i.replaceAll("-","")),e==i}))}const Oe=[],Be=[];function Ue(e){var t;return e=e.toString().toLowerCase(),Object.values(ke.services).some((i=>{const n=Object.keys(i.characteristics);return t=n.find((t=>{let n=i.characteristics[t].uuid.toString();return 4==e.length&&(n=n.slice(4,8)),e.includes("-")||(n=n.replaceAll("-","")),e==n}))})),t}function Ve(e){const t={broadcast:!1,read:!0,writeWithoutResponse:!1,write:!1,notify:!1,indicate:!1,authenticatedSignedWrites:!1,reliableWrite:!1,writableAuxiliaries:!1};switch(e){case"rx":case"tx":case"smp":t.read=!1}switch(e){case"batteryLevel":case"rx":case"smp":t.notify=!0}if("smp"===e)t.writeWithoutResponse=!0;if("tx"===e)t.write=!0;return t}Object.values(ke.services).forEach((e=>{if(!e.characteristics)return;const t=Object.keys(e.characteristics);t.forEach((i=>{const n=e.characteristics[i];Te.includes(e.uuid)&&(Oe.push(n.uuid),t.push(i)),Be.push(n.uuid)}))}),[]);const Ne=S("BluetoothConnectionManager",{log:!0});class je extends Me{constructor(){super(...arguments),this.isInRange=!0}onCharacteristicValueChanged(e,t){"rx"==e?this.parseRxMessage(t):this.onMessageReceived?.(e,t)}async writeCharacteristic(e,t){Ne.log("writeCharacteristic",...arguments)}async sendSmpMessage(e){super.sendSmpMessage(e),await this.writeCharacteristic("smp",e)}async sendTxData(e){super.sendTxData(e),await this.writeCharacteristic("tx",e)}}var _e,Fe,Pe,Ge,ze,Je,qe,He,Ke,Qe,Xe;const Ye=S("WebBluetoothConnectionManager",{log:!0});var Ze,et,tt,it,nt,st,rt,ot,at,ct,ht,lt,dt,ut,ft,gt,vt;s&&(Ze=window.navigator.bluetooth);class mt extends je{constructor(){super(...arguments),_e.add(this),Fe.set(this,{characteristicvaluechanged:t(this,_e,"m",Ke).bind(this)}),Pe.set(this,{gattserverdisconnected:t(this,_e,"m",Xe).bind(this)}),Ge.set(this,void 0),ze.set(this,new Map),Je.set(this,new Map)}get bluetoothId(){return this.device.id}static get isSupported(){return Boolean(Ze)}static get type(){return"webBluetooth"}get device(){return t(this,Ge,"f")}set device(e){t(this,Ge,"f")!=e?(t(this,Ge,"f")&&We(t(this,Ge,"f"),t(this,Pe,"f")),e&&De(e,t(this,Pe,"f")),i(this,Ge,e,"f")):Ye.log("tried to assign the same BluetoothDevice")}get server(){return t(this,Ge,"f")?.gatt}get isConnected(){return this.server?.connected||!1}async connect(){await super.connect();try{const e=await Ze.requestDevice({filters:[{services:Te}],optionalServices:s?Ae:[]});Ye.log("got BluetoothDevice"),this.device=e,Ye.log("connecting to device...");const i=await this.server.connect();Ye.log(`connected to device? ${i.connected}`),await t(this,_e,"m",qe).call(this),Ye.log("fully connected"),this.status="connected"}catch(e){Ye.error(e),this.status="notConnected",this.server?.disconnect(),t(this,_e,"m",He).call(this)}}async disconnect(){await t(this,_e,"m",He).call(this),await super.disconnect(),this.server?.disconnect(),this.status="notConnected"}async writeCharacteristic(e,i){super.writeCharacteristic(e,i);const n=t(this,Je,"f").get(e);Ye.assertWithError(n,`${e} characteristic not found`),Ye.log("writing characteristic",n,i);const s=n.properties||Ve(e);s.writeWithoutResponse?(Ye.log("writing without response"),await n.writeValueWithoutResponse(i)):(Ye.log("writing with response"),await n.writeValueWithResponse(i)),Ye.log("wrote characteristic"),s.read&&!s.notify&&(Ye.log("reading value after write..."),await n.readValue(),(c||h)&&t(this,_e,"m",Qe).call(this,n))}get canReconnect(){return Boolean(this.server&&!this.server.connected&&this.isInRange)}async reconnect(){await super.reconnect(),Ye.log("attempting to reconnect..."),this.status="connecting";try{await this.server.connect()}catch(e){Ye.error(e),this.isInRange=!1}this.isConnected?(Ye.log("successfully reconnected!"),await t(this,_e,"m",qe).call(this),this.status="connected"):(Ye.log("unable to reconnect"),this.status="notConnected")}}Fe=new WeakMap,Pe=new WeakMap,Ge=new WeakMap,ze=new WeakMap,Je=new WeakMap,_e=new WeakSet,qe=async function(){t(this,_e,"m",He).call(this),Ye.log("getting services...");const e=await this.server.getPrimaryServices();Ye.log("got services",e.length),Ye.log("getting characteristics...");for(const i in e){const n=e[i];Ye.log({service:n});const s=$e(n.uuid);Ye.assertWithError(s,`no name found for service uuid "${n.uuid}"`),Ye.log(`got "${s}" service`),n.name=s,t(this,ze,"f").set(s,n),Ye.log(`getting characteristics for "${s}" service`);const r=await n.getCharacteristics();Ye.log(`got characteristics for "${s}" service`);for(const e in r){const i=r[e];Ye.log({characteristic:i});const n=Ue(i.uuid);Ye.assertWithError(Boolean(n),`no name found for characteristic uuid "${i.uuid}" in "${s}" service`),Ye.log(`got "${n}" characteristic in "${s}" service`),i.name=n,t(this,Je,"f").set(n,i),De(i,t(this,Fe,"f"));const o=i.properties||Ve(n);o.notify&&(Ye.log(`starting notifications for "${n}" characteristic`),await i.startNotifications()),o.read&&(Ye.log(`reading "${n}" characteristic...`),await i.readValue(),(c||h)&&t(this,_e,"m",Qe).call(this,i))}}},He=async function(){this.device&&We(this.device,t(this,Pe,"f"));const e=Array.from(t(this,Je,"f").keys()).map((e=>{const i=t(this,Je,"f").get(e);We(i,t(this,Fe,"f"));if((i.properties||Ve(e)).notify)return Ye.log(`stopping notifications for "${e}" characteristic`),i.stopNotifications()}));return Promise.allSettled(e)},Ke=function(e){Ye.log("oncharacteristicvaluechanged");const i=e.target;t(this,_e,"m",Qe).call(this,i)},Qe=function(e){Ye.log("onCharacteristicValue");const t=e.name;Ye.assertWithError(Boolean(t),`no name found for characteristic with uuid "${e.uuid}"`),Ye.log(`oncharacteristicvaluechanged for "${t}" characteristic`);const i=e.value;Ye.assertWithError(i,`no data found for "${t}" characteristic`),Ye.log(`data for "${t}" characteristic`,Array.from(new Uint8Array(i.buffer)));try{this.onCharacteristicValueChanged(t,i)}catch(e){Ye.error(e)}},Xe=function(){Ye.log("gattserverdisconnected"),this.status="notConnected"};const pt=S("DeviceManager",{log:!0}),wt=["deviceConnected","deviceDisconnected","deviceIsConnected","availableDevices","connectedDevices"];class bt{constructor(){if(et.add(this),tt.set(this,{isConnected:t(this,et,"m",ft).bind(this)}),it.set(this,[]),nt.set(this,!1),st.set(this,{devices:[]}),rt.set(this,void 0),at.set(this,"TS.Device"),lt.set(this,[]),dt.set(this,new I(this,wt)),bt.shared&&this!=bt.shared)throw Error("DeviceManager is a singleton - use DeviceManager.shared");this.CanUseLocalStorage&&(this.UseLocalStorage=!0)}onDevice(e){De(e,t(this,tt,"f"))}OnDeviceConnectionStatusUpdated(e,i){if("notConnected"==i&&!e.canReconnect&&t(this,lt,"f").includes(e)){const i=t(this,lt,"f").indexOf(e);this.AvailableDevices.splice(i,1),t(this,et,"m",gt).call(this)}}get ConnectedDevices(){return t(this,it,"f")}get UseLocalStorage(){return t(this,nt,"f")}set UseLocalStorage(e){t(this,et,"m",ot).call(this),pt.assertTypeWithError(e,"boolean"),i(this,nt,e,"f"),t(this,nt,"f")&&!t(this,rt,"f")&&t(this,et,"m",ht).call(this)}get CanUseLocalStorage(){return s&&window.localStorage}get AvailableDevices(){return t(this,lt,"f")}get CanGetDevices(){return s&&navigator.bluetooth?.getDevices}async GetDevices(){if(!s)return void pt.warn("GetDevices is only available in the browser");if(!navigator.bluetooth)return void pt.warn("bluetooth is not available in this browser");if(c)return void pt.warn("bluefy lists too many devices...");if(!navigator.bluetooth.getDevices)return void pt.warn("bluetooth.getDevices() is not available in this browser");if(!this.CanGetDevices)return void pt.log("CanGetDevices is false");t(this,rt,"f")||t(this,et,"m",ht).call(this);const e=t(this,rt,"f");if(!e.devices||0==e.devices.length)return void pt.log("no devices found in configuration");const i=await navigator.bluetooth.getDevices();return pt.log({bluetoothDevices:i}),i.forEach((i=>{if(!i.gatt)return;if(!e.devices.find((e=>i.id==e.bluetoothId)))return;let n=this.ConnectedDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==i.id));const s=this.AvailableDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==i.id));if(s)return void(n&&n?.bluetoothId==s.bluetoothId&&n!=s&&(this.AvailableDevices[t(this,lt,"f").indexOf(s)]=n));if(n)return void this.AvailableDevices.push(n);const r=new qt,o=new mt;o.device=i,i.name,r.connectionManager=o,this.AvailableDevices.push(r)})),t(this,et,"m",gt).call(this),this.AvailableDevices}get AddEventListener(){return t(this,dt,"f").addEventListener}get RemoveEventListener(){return t(this,dt,"f").removeEventListener}get RemoveEventListeners(){return t(this,dt,"f").removeEventListeners}get RemoveAllEventListeners(){return t(this,dt,"f").removeAllEventListeners}}tt=new WeakMap,it=new WeakMap,nt=new WeakMap,st=new WeakMap,rt=new WeakMap,at=new WeakMap,lt=new WeakMap,dt=new WeakMap,et=new WeakSet,ot=function(){pt.assertWithError(s,"localStorage is only available in the browser"),pt.assertWithError(window.localStorage,"localStorage not found")},ct=function(){t(this,et,"m",ot).call(this),localStorage.setItem(t(this,at,"f"),JSON.stringify(t(this,rt,"f")))},ht=async function(){t(this,et,"m",ot).call(this);let e=localStorage.getItem(t(this,at,"f"));if("string"!=typeof e)return pt.log("no info found in localStorage"),i(this,rt,Object.assign({},t(this,st,"f")),"f"),void t(this,et,"m",ct).call(this);try{const t=JSON.parse(e);pt.log({configuration:t}),i(this,rt,t,"f"),this.CanGetDevices&&await this.GetDevices()}catch(e){pt.error(e)}},ut=function(){return t(this,dt,"f").dispatchEvent},ft=function(e){const{target:i}=e;if(i.isConnected)if(t(this,it,"f").includes(i))pt.log("device already included");else{if(pt.log("adding device",i),t(this,it,"f").push(i),this.UseLocalStorage&&"webBluetooth"==i.connectionType){const e={bluetoothId:i.bluetoothId},n=t(this,rt,"f").devices.findIndex((t=>t.bluetoothId==e.bluetoothId));-1==n?t(this,rt,"f").devices.push(e):t(this,rt,"f").devices[n]=e,t(this,et,"m",ct).call(this)}t(this,et,"a",ut).call(this,"deviceConnected",{device:i}),t(this,et,"a",ut).call(this,"deviceIsConnected",{device:i}),t(this,et,"m",vt).call(this)}else t(this,it,"f").includes(i)?(pt.log("removing device",i),t(this,it,"f").splice(t(this,it,"f").indexOf(i),1),t(this,et,"a",ut).call(this,"deviceDisconnected",{device:i}),t(this,et,"a",ut).call(this,"deviceIsConnected",{device:i}),t(this,et,"m",vt).call(this)):pt.log("device already not included");if(this.CanGetDevices&&this.GetDevices(),i.isConnected&&!this.AvailableDevices.includes(i)){const e=this.AvailableDevices.find((e=>e.bluetoothId==i.bluetoothId));pt.log({existingAvailableDevice:e}),e?this.AvailableDevices[this.AvailableDevices.indexOf(e)]=i:this.AvailableDevices.push(i),t(this,et,"m",gt).call(this)}},gt=function(){pt.log({AvailableDevices:this.AvailableDevices}),t(this,et,"a",ut).call(this,"availableDevices",{availableDevices:this.AvailableDevices})},vt=function(){pt.log({ConnectedDevices:this.ConnectedDevices}),t(this,et,"a",ut).call(this,"connectedDevices",{connectedDevices:this.ConnectedDevices})},bt.shared=new bt;var yt,Et,Mt,Ct,Dt,Wt,Lt,St,Rt,It,xt,kt,Tt,At,$t,Ot,Bt,Ut,Vt,Nt,jt,_t,Ft,Pt,Gt=bt.shared;const zt=S("Device",{log:!0}),Jt=["connectionMessage",...we,...Ee,...ye,...X];class qt{get bluetoothId(){return t(this,Wt,"f")?.bluetoothId}constructor(){yt.add(this),Ct.set(this,new I(this,Jt)),Wt.set(this,void 0),this.sendTxMessages=t(this,yt,"m",Lt).bind(this),St.set(this,!1),kt.set(this,Et.ReconnectOnDisconnection),Tt.set(this,void 0),this.latestConnectionMessage=new Map,Nt.set(this,new Y),jt.set(this,0),Ft.set(this,new ee),Pt.set(this,!1),t(this,Nt,"f").eventDispatcher=t(this,Ct,"f"),t(this,Ft,"f").sendMessage=this.sendTxMessages,Gt.onDevice(this),s&&window.addEventListener("beforeunload",(()=>{this.isConnected})),r&&process.on("exit",(()=>{this.isConnected}))}get addEventListener(){return t(this,Ct,"f").addEventListener}get removeEventListener(){return t(this,Ct,"f").removeEventListener}get waitForEvent(){return t(this,Ct,"f").waitForEvent}get removeEventListeners(){return t(this,Ct,"f").removeEventListeners}get removeAllEventListeners(){return t(this,Ct,"f").removeAllEventListeners}get connectionManager(){return t(this,Wt,"f")}set connectionManager(e){this.connectionManager!=e?(this.connectionManager&&(this.connectionManager.onStatusUpdated=void 0,this.connectionManager.onMessageReceived=void 0,this.connectionManager.onMessagesReceived=void 0),e&&(e.onStatusUpdated=t(this,yt,"m",At).bind(this),e.onMessageReceived=t(this,yt,"m",Ut).bind(this),e.onMessagesReceived=t(this,yt,"m",Vt).bind(this)),i(this,Wt,e,"f"),zt.log("assigned new connectionManager",t(this,Wt,"f"))):zt.log("same connectionManager is already assigned")}async connect(){return this.connectionManager||(this.connectionManager=t(Et,Et,"m",Mt).call(Et)),t(this,yt,"m",Bt).call(this),this.connectionManager.connect()}get isConnected(){return t(this,St,"f")}get canReconnect(){return this.connectionManager?.canReconnect}async reconnect(){return t(this,yt,"m",It).call(this),t(this,yt,"m",Bt).call(this),this.connectionManager?.reconnect()}static async Connect(){const e=new Et;return await e.connect(),e}static get ReconnectOnDisconnection(){return t(this,Et,"f",xt)}static set ReconnectOnDisconnection(e){zt.assertTypeWithError(e,"boolean"),i(this,Et,e,"f",xt)}get reconnectOnDisconnection(){return t(this,kt,"f")}set reconnectOnDisconnection(e){zt.assertTypeWithError(e,"boolean"),i(this,kt,e,"f")}get connectionType(){return this.connectionManager?.type}async disconnect(){return t(this,yt,"m",Rt).call(this),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.addEventListener("isConnected",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this.connectionManager.disconnect()}toggleConnection(){this.isConnected?this.disconnect():this.canReconnect?this.reconnect():this.connect()}get connectionStatus(){switch(t(this,Wt,"f")?.status){case"connected":return this.isConnected?"connected":"connecting";case"notConnected":case"connecting":case"disconnecting":return t(this,Wt,"f").status;default:return"notConnected"}}get isConnectionBusy(){return"connecting"==this.connectionStatus||"disconnecting"==this.connectionStatus}get deviceInformation(){return t(this,Nt,"f").information}get batteryLevel(){return t(this,jt,"f")}async triggerVibration(e){t(this,Ft,"f").triggerVibration(e)}get isServerSide(){return t(this,Pt,"f")}set isServerSide(e){t(this,Pt,"f")!=e?(zt.log({newIsServerSide:e}),i(this,Pt,e,"f")):zt.log("redundant isServerSide assignment")}}var Ht,Kt,Qt;Et=qt,Ct=new WeakMap,Wt=new WeakMap,St=new WeakMap,kt=new WeakMap,Tt=new WeakMap,Nt=new WeakMap,jt=new WeakMap,Ft=new WeakMap,Pt=new WeakMap,yt=new WeakSet,Mt=function(){return new mt},Dt=function(){return t(this,Ct,"f").dispatchEvent},Lt=async function(e,i){await(t(this,Wt,"f")?.sendTxMessages(e,i))},Rt=function(){zt.assertWithError(this.isConnected,"notConnected")},It=function(){zt.assertWithError(this.canReconnect,"cannot reconnect to device")},At=function(e){zt.log({connectionStatus:e}),"notConnected"==e?this.canReconnect&&this.reconnectOnDisconnection&&(zt.log("starting reconnect interval..."),i(this,Tt,setInterval((()=>{zt.log("attempting reconnect..."),this.reconnect()}),1e3),"f")):null!=t(this,Tt,"f")&&(zt.log("clearing reconnect interval"),clearInterval(t(this,Tt,"f")),i(this,Tt,void 0,"f")),t(this,yt,"m",Ot).call(this),"connected"==e&&t(this,St,"f"),Gt.OnDeviceConnectionStatusUpdated(this,e)},$t=function(e=!1){t(this,yt,"a",Dt).call(this,"connectionStatus",{connectionStatus:this.connectionStatus}),t(this,yt,"a",Dt).call(this,this.connectionStatus,{}),e&&t(this,yt,"a",Dt).call(this,"isConnected",{isConnected:this.isConnected})},Ot=function(){switch(i(this,St,Boolean(this.connectionManager?.isConnected),"f"),this.connectionStatus){case"connected":t(this,St,"f")&&t(this,yt,"m",$t).call(this,!0);break;case"notConnected":t(this,yt,"m",$t).call(this,!0);break;default:t(this,yt,"m",$t).call(this,!1)}},Bt=function(){this.latestConnectionMessage.clear(),t(this,Nt,"f").clear()},Ut=function(e,i){if(zt.log({messageType:e,dataView:i}),"batteryLevel"===e){const e=i.getUint8(0);zt.log("received battery level",{batteryLevel:e}),t(this,yt,"m",_t).call(this,e)}this.latestConnectionMessage.set(e,i),t(this,yt,"a",Dt).call(this,"connectionMessage",{messageType:e,dataView:i})},Vt=function(){this.isConnected||t(this,yt,"m",Ot).call(this),t(this,yt,"m",Lt).call(this)},_t=function(e){zt.assertTypeWithError(e,"number"),t(this,jt,"f")!=e?(i(this,jt,e,"f"),zt.log({updatedBatteryLevel:t(this,jt,"f")}),t(this,yt,"a",Dt).call(this,"batteryLevel",{batteryLevel:t(this,jt,"f")})):zt.log(`duplicate batteryLevel assignment ${e}`)},xt={value:!1},S("MathUtils",{log:!0});const Xt={min:1/0,max:-1/0,span:0};Kt=new WeakMap,Ht=new WeakSet,Qt=function(){t(this,Kt,"f").span=t(this,Kt,"f").max-t(this,Kt,"f").min},e.Device=qt,e.DeviceManager=Gt,e.Environment=b,e.MaxNumberOfVibrationSegments=9,e.RangeHelper=class{constructor(){Ht.add(this),Kt.set(this,Object.assign({},Xt))}get min(){return t(this,Kt,"f").min}get max(){return t(this,Kt,"f").max}set min(e){t(this,Kt,"f").min=e,t(this,Kt,"f").max=Math.max(e,t(this,Kt,"f").max),t(this,Ht,"m",Qt).call(this)}set max(e){t(this,Kt,"f").max=e,t(this,Kt,"f").min=Math.min(e,t(this,Kt,"f").min),t(this,Ht,"m",Qt).call(this)}reset(){Object.assign(t(this,Kt,"f"),Xt)}update(e){t(this,Kt,"f").min=Math.min(e,t(this,Kt,"f").min),t(this,Kt,"f").max=Math.max(e,t(this,Kt,"f").max),t(this,Ht,"m",Qt).call(this)}getNormalization(e,i){let n=function(e,t,i,n){return null==n&&(n=i-t),(e-t)/n}(e,t(this,Kt,"f").min,t(this,Kt,"f").max,t(this,Kt,"f").span);return i&&(n*=t(this,Kt,"f").span),n||0}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}},e.setAllConsoleLevelFlags=function(e){L.setAllLevelFlags(e)},e.setConsoleLevelFlagsForType=function(e,t){L.setLevelFlagsForType(e,t)}}));
//# sourceMappingURL=tapstrap.min.js.map
