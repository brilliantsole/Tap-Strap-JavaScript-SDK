/**
 * @copyright Zack Qattan 2024
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TS={})}(this,(function(e){"use strict";function t(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)}function i(e,t,i,s,n){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?n.call(e,i):n?n.value=i:t.set(e,i),i}"function"==typeof SuppressedError&&SuppressedError;const s=!1,n="undefined"!=typeof window&&void 0!==window?.document,r="undefined"!=typeof process&&null!=process?.versions?.node,a=n&&navigator.userAgent||"";let o=!1;n?o=Boolean(navigator.bluetooth):r&&(o=!0);const c=n&&/Bluefy/i.test(a),h=n&&/WebBLE/i.test(a),l=n&&/Android/i.test(a),u=n&&/Safari/i.test(a)&&!/Chrome/i.test(a),d=n&&/iPad|iPhone|iPod/i.test(a),f=n&&/Macintosh/i.test(a),g=!n&&!r&&"undefined"!=typeof global&&"undefined"!=typeof Studio;var v,m,p,w,y=Object.freeze({__proto__:null,isAndroid:l,get isBluetoothSupported(){return o},isIOS:d,isInBluefy:c,isInBrowser:n,isInDev:s,isInLensStudio:g,isInNode:r,isInProduction:!0,isInWebBLE:h,isMac:f,isSafari:u});if(g){const e=function(...e){Studio.log(e.map((e=>new String(e))).join(","))};(w={}).log=e,w.warn=e.bind(w,"WARNING"),w.error=e.bind(w,"ERROR")}else w=console;if(!w.assert){const e=(e,...t)=>{e||w.warn(...t)};w.assert=e}if(!w.table){const e=(...e)=>{w.log(...e)};w.table=e}function b(){}const M=w.log.bind(w),E=w.warn.bind(w),D=w.error.bind(w),S=w.table.bind(w),C=w.assert.bind(w);class x{constructor(e){if(p.set(this,{log:s,warn:s,assert:!0,error:!0,table:!0}),t(v,v,"f",m)[e])throw new Error(`"${e}" console already exists`);t(v,v,"f",m)[e]=this}setLevelFlags(e){Object.assign(t(this,p,"f"),e)}static setLevelFlagsForType(e,i){if(!t(this,v,"f",m)[e])throw new Error(`no console found with type "${e}"`);t(this,v,"f",m)[e].setLevelFlags(i)}static setAllLevelFlags(e){for(const i in t(this,v,"f",m))t(this,v,"f",m)[i].setLevelFlags(e)}static create(e,i){return t(this,v,"f",m)[e]||new v(e)}get log(){return t(this,p,"f").log?M:b}get warn(){return t(this,p,"f").warn?E:b}get error(){return t(this,p,"f").error?D:b}get assert(){return t(this,p,"f").assert?C:b}get table(){return t(this,p,"f").table?S:b}assertWithError(e,t){if(!Boolean(e))throw new Error(t)}assertTypeWithError(e,t){this.assertWithError(typeof e==t,`value ${e} of type "${typeof e}" not of type "${t}"`)}assertEnumWithError(e,t){this.assertWithError(t.includes(e),`invalid enum "${e}"`)}}function k(e,t){return x.create(e,t)}v=x,p=new WeakMap,m={value:{}};const W=k("EventDispatcher",{log:!1});class A{constructor(e,t){this.target=e,this.validEventTypes=t,this.listeners={},this.addEventListener=this.addEventListener.bind(this),this.removeEventListener=this.removeEventListener.bind(this),this.removeEventListeners=this.removeEventListeners.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.dispatchEvent=this.dispatchEvent.bind(this),this.waitForEvent=this.waitForEvent.bind(this)}isValidEventType(e){return this.validEventTypes.includes(e)}updateEventListeners(e){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((t=>(t.shouldRemove&&W.log(`removing "${e}" eventListener`,t),!t.shouldRemove))))}addEventListener(e,t,i={once:!1}){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]||(this.listeners[e]=[],W.log(`creating "${e}" listeners array`,this.listeners[e]));this.listeners[e].find((e=>e.listener==t&&e.once==i.once))?W.log("already added listener"):(W.log(`adding "${e}" listener`,t,i),this.listeners[e].push({listener:t,once:i.once}),W.log(`currently have ${this.listeners[e].length} "${e}" listeners`))}removeEventListener(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(W.log(`removing "${e}" listener...`,t),this.listeners[e].forEach((i=>{i.listener===t&&(W.log(`flagging "${e}" listener`,t),i.shouldRemove=!0)})),this.updateEventListeners(e))}removeEventListeners(e){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(W.log(`removing "${e}" listeners...`),this.listeners[e]=[])}removeAllEventListeners(){W.log("removing listeners..."),this.listeners={}}dispatchEvent(e,t){if(!this.isValidEventType(e))throw new Error(`Invalid event type: ${e}`);this.listeners[e]&&(this.listeners[e].forEach((i=>{i.shouldRemove||(W.log(`dispatching "${e}" listener`,i),i.listener({type:e,target:this.target,message:t}),i.once&&(W.log(`flagging "${e}" listener`,i),i.shouldRemove=!0))})),this.updateEventListeners(e))}waitForEvent(e){return new Promise((t=>{this.addEventListener(e,(e=>{t(e)}),{once:!0})}))}}var I,R,L;const T=k("Timer",{log:!1});class ${get callback(){return t(this,I,"f")}set callback(e){T.assertTypeWithError(e,"function"),T.log({newCallback:e}),i(this,I,e,"f"),this.isRunning&&this.restart()}get interval(){return t(this,R,"f")}set interval(e){T.assertTypeWithError(e,"number"),T.assertWithError(e>0,"interval must be above 0"),T.log({newInterval:e}),i(this,R,e,"f"),this.isRunning&&this.restart()}constructor(e,t){I.set(this,void 0),R.set(this,void 0),L.set(this,void 0),this.interval=t,this.callback=e}get isRunning(){return null!=t(this,L,"f")}start(e=!1){this.isRunning?T.log("interval already running"):(T.log("starting interval"),i(this,L,setInterval(t(this,I,"f"),t(this,R,"f")),"f"),e&&t(this,I,"f").call(this))}stop(){this.isRunning?(T.log("stopping interval"),clearInterval(t(this,L,"f")),i(this,L,void 0,"f")):T.log("interval already not running")}restart(e=!1){this.stop(),this.start(e)}}var O,U;I=new WeakMap,R=new WeakMap,L=new WeakMap,O="undefined"==typeof TextEncoder?class{encode(e){const t=Array.from(e).map((e=>e.charCodeAt(0)));return Uint8Array.from(t)}}:TextEncoder,U="undefined"==typeof TextDecoder?class{decode(e){return Array.from(new Uint8Array(e)).map((e=>String.fromCharCode(e))).join("")}}:TextDecoder;const G=new O,B=new U;var F,N,z,j,V;const _=k("DeviceInformationManager",{log:!0}),P=["manufacturerName","modelNumber","softwareRevision","hardwareRevision","firmwareRevision","pnpId","serialNumber"],q=[...P,"deviceInformation"];class Q{constructor(){F.add(this),z.set(this,{})}get information(){return t(this,z,"f")}clear(){i(this,z,{},"f")}parseMessage(e,i){switch(_.log({messageType:e}),e){case"manufacturerName":const s=B.decode(i.buffer);_.log({manufacturerName:s}),t(this,F,"m",V).call(this,{manufacturerName:s});break;case"modelNumber":const n=B.decode(i.buffer);_.log({modelNumber:n}),t(this,F,"m",V).call(this,{modelNumber:n});break;case"softwareRevision":const r=B.decode(i.buffer);_.log({softwareRevision:r}),t(this,F,"m",V).call(this,{softwareRevision:r});break;case"hardwareRevision":const a=B.decode(i.buffer);_.log({hardwareRevision:a}),t(this,F,"m",V).call(this,{hardwareRevision:a});break;case"firmwareRevision":const o=B.decode(i.buffer);_.log({firmwareRevision:o}),t(this,F,"m",V).call(this,{firmwareRevision:o});break;case"pnpId":const c={source:1===i.getUint8(0)?"Bluetooth":"USB",productId:i.getUint16(3,!0),productVersion:i.getUint16(5,!0),vendorId:0};"Bluetooth"==c.source&&(c.vendorId=i.getUint16(1,!0)),_.log({pnpId:c}),t(this,F,"m",V).call(this,{pnpId:c});break;case"serialNumber":const h=B.decode(i.buffer);_.log({serialNumber:h});break;default:throw Error(`uncaught messageType ${e}`)}}}z=new WeakMap,F=new WeakSet,N=function(){return this.eventDispatcher.dispatchEvent},j=function(){return P.every((e=>{switch(e){case"modelNumber":case"serialNumber":return!0;default:return e in t(this,z,"f")}}))},V=function(e){_.log({partialDeviceInformation:e});Object.keys(e).forEach((i=>{t(this,F,"a",N).call(this,i,{[i]:e[i]})})),Object.assign(t(this,z,"f"),e),_.log({deviceInformation:t(this,z,"f")}),t(this,F,"a",j)&&(_.log("completed deviceInformation"),t(this,F,"a",N).call(this,"deviceInformation",{deviceInformation:this.information}))};function X(e,{include:t,exclude:i}={}){const s=e=>{const s=t=>"string"==typeof t?e===t:t.test(e);return t?t.some(s):!i||!i.some(s)};for(const[t,i]of(e=>{const t=new Set;do{for(const i of Reflect.ownKeys(e))t.add([e,i])}while((e=Reflect.getPrototypeOf(e))&&e!==Object.prototype);return t})(e.constructor.prototype)){if("constructor"===i||!s(i))continue;const n=Reflect.getOwnPropertyDescriptor(t,i);n&&"function"==typeof n.value&&(e[i]=e[i].bind(e))}return e}const J={oneFingerUp:2,twoFingersUp:3,oneFingerDown:4,twoFingersDown:5,oneFingerLeft:6,twoFingersLeft:7,oneFingerRight:8,twoFingersRight:9,indexToThumbTouch:10,middleToThumbTouch:11,xrAirGestureNone:100,xrAirGestureThumbIndex:101,xrAirGestureThumbMiddle:102},K={};Object.keys(J).forEach((e=>{K[J[e]]=e}));const H={clickIndex:1,clickMiddle:2,dragIndex:3,dragMiddle:4,drop:5,potentialDragOrClickIndex:6,potentialDragOrClickMiddle:7},Y={};var Z,ee,te;Object.keys(H).forEach((e=>{Y[H[e]]=e}));const ie=k("TapDataManager"),se=["tapData"],ne=[...se,"tapAirGesture"],re=["thumb","index","middle","ring","pinky"];class ae{constructor(){Z.add(this),this.isInAirGestureState=!1,X(this)}parseMessage(e,i){if(ie.log({messageType:e}),"tapData"!==e)throw Error(`uncaught messageType ${e}`);t(this,Z,"m",te).call(this,i)}}var oe,ce,he;Z=new WeakSet,ee=function(){return this.eventDispatcher.dispatchEvent},te=function(e){ie.log("parsing tap data",e);const i=e.getUint8(0);if(this.isInAirGestureState){const e=function(e){switch(e){case 2:return"indexToThumbTouch";case 4:return"middleToThumbTouch"}}(i);ie.log({tapAirGesture:e}),e&&t(this,Z,"a",ee).call(this,"tapAirGesture",{tapAirGesture:e})}else{let s;if(e.byteLength>=4){const t=e.getUint8(3);s={shiftState:3&t,switchState:t>>2&3,multitap:Math.min(1+(t>>4&3),3)}}const n={},r=[];ie.log("fingerBits",i.toString(2)),re.forEach(((e,t)=>{n[e]=!!(i&1<<t),n[e]&&r.push(e)})),ie.log("fingers",n),t(this,Z,"a",ee).call(this,"tapData",{fingers:n,keyboardState:s,fingerArray:r})}};const le=k("MouseDataManager"),ue=["mouseData"],de=[...ue];class fe{constructor(){oe.add(this),X(this)}parseMessage(e,i){if(le.log({messageType:e}),"mouseData"!==e)throw Error(`uncaught messageType ${e}`);t(this,oe,"m",he).call(this,i)}}var ge,ve,me,pe,we,ye;oe=new WeakSet,ce=function(){return this.eventDispatcher.dispatchEvent},he=function(e){le.log("parsing mouse data",e);if(0!=e.getUint8(0))return;const i={x:e.getInt16(1,!0),y:-e.getInt16(3,!0)},s=1==e.getUint8(9);t(this,oe,"a",ce).call(this,"mouseData",{velocity:i,isMouse:s})};const be=k("AirGestureManager"),Me=["airGesture"],Ee=[...Me,"isInAirGestureState","xrAirGesture"];class De{constructor(){ge.add(this),me.set(this,!1),we.set(this,void 0),this.xrAirGestureCount=0,this.xrAirGestureMinCount=1,X(this)}get isInState(){return t(this,me,"f")}parseMessage(e,i){if(be.log({messageType:e}),"airGesture"!==e)throw Error(`uncaught messageType ${e}`);t(this,ge,"m",ye).call(this,i)}}me=new WeakMap,we=new WeakMap,ge=new WeakSet,ve=function(){return this.eventDispatcher.dispatchEvent},pe=function(e){i(this,me,e,"f"),be.log("isInAirGestureState",t(this,me,"f")),t(this,ge,"a",ve).call(this,"isInAirGestureState",{isInAirGestureState:t(this,me,"f")})},ye=function(e){be.log("parsing air gesture",e);const s=e.getUint8(0);if(20==s){const i=e.getUint8(1);t(this,ge,"m",pe).call(this,1==i)}else{let e=K[s];if(be.log({airGesture:e}),e)e.startsWith("xrAirGesture")?(e==t(this,we,"f")?this.xrAirGestureCount++:(this.xrAirGestureCount=1,i(this,we,e,"f")),this.xrAirGestureCount>=this.xrAirGestureMinCount&&t(this,ge,"a",ve).call(this,"airGesture",{airGesture:e})):t(this,ge,"a",ve).call(this,"airGesture",{airGesture:e});else{const e=Y[s];be.log({xrAirGesture:e}),e&&t(this,ge,"a",ve).call(this,"xrAirGesture",{xrAirGesture:e})}}};const Se=k("RawSensorUtils"),Ce=["deviceAccelerometer","imuGyroscope","imuAccelerometer"],xe={deviceAccelerometer:[31.25,3.90625,7.8125,15.625,31.25],imuGyroscope:[17.5,4.375,8.75,17.5,35,70],imuAccelerometer:[.122,.061,.122,.244,.488]},ke={deviceAccelerometer:0,imuGyroscope:0,imuAccelerometer:0},We={imu:12,device:30};function Ae(e,t){const i=xe[e][t];Se.assertWithError(null!=i,`invalid RawSensorSensitivity index ${t} for sensor "${e}" (got value ${i})`)}const Ie=["gyroscope","accelerometer"],Re=["thumb","index","middle","ring","pinky"],Le=k("ArrayBufferUtils",{log:!1});function Te(...e){const t=(e=(e=(e=e.filter((e=>null!=e||null!=e))).map((e=>{if("number"==typeof e){const t=e;return Uint8Array.from([Math.floor(t)])}if("boolean"==typeof e){const t=e;return Uint8Array.from([t?1:0])}if("string"==typeof e){return $e(e)}if(e instanceof Array){return Te(...e)}if(e instanceof ArrayBuffer)return e;if("buffer"in e&&e.buffer instanceof ArrayBuffer){return e.buffer}if(e instanceof DataView){return e.buffer}if("object"==typeof e){return function(e){return $e(JSON.stringify(e))}(e)}return e}))).filter((e=>e&&"byteLength"in e))).reduce(((e,t)=>e+t.byteLength),0),i=new Uint8Array(t);let s=0;return e.forEach((e=>{i.set(new Uint8Array(e),s),s+=e.byteLength})),i.buffer}function $e(e){const t=G.encode(e);return Te(t.byteLength,t)}function Oe(e,t,i){let s;return null!=i&&(s=e.byteOffset+t+i),Le.log({dataView:e,begin:t,end:s,length:i}),new DataView(e.buffer.slice(e.byteOffset+t,s))}var Ue,Ge,Be,Fe;function Ne(){return Ge?Ue:(Ge=1,Ue=function(e,t){const i=(t=t||{}).kp||1,s=t.ki||0;let n=1/(1e3/e),r=!0!==t.doInitialisation,a=2*i;const o=2*s;let c=1,h=0,l=0,u=0,d=0,f=0,g=0;function v(e,t,i,s,n,r){return{x:t*r-i*n,y:i*s-e*r,z:e*n-t*s}}function m(e,t,i,s,n,a){const o=function(e,t,i,s,n,r){const a=-Math.atan2(e,Math.sqrt(t*t+i*i)),o=v(e,t,i,1,0,0),c=v(1,0,0,o.x,o.y,o.z),h=Math.atan2(c.y,c.z),l=Math.cos(h),u=Math.sin(a),d=Math.sin(h),f=n*l-r*d,g=s*Math.cos(a)+n*d*u+r*l*u;return{heading:-Math.atan2(f,g),pitch:a,roll:h}}(e,t,i,s,n,a),d=function(e){const t=Math.cos(.5*e.heading),i=Math.sin(.5*e.heading),s=Math.cos(.5*e.pitch),n=Math.sin(.5*e.pitch),r=Math.cos(.5*e.roll),a=Math.sin(.5*e.roll);return{w:r*s*t+a*n*i,x:a*s*t-r*n*i,y:r*n*t+a*s*i,z:r*s*i-a*n*t}}(o),f=(d.w*d.w+d.x*d.x+d.y*d.y+d.z*d.z)**-.5;c=d.w*f,h=d.x*f,l=d.y*f,u=d.z*f,r=!0}return{update:function(e,t,i,s,v,p,w,y,b,M){let E,D,S,C,x,k,W,A,I,R,L,T,$,O,U,G,B,F,N,z,j,V,_,P;if(n=M||n,r||m(s,v,p,w,y,b),void 0===w||void 0===y||void 0===b||0===w&&0===y&&0===b)return void function(e,t,i,s,r,v){let m,p,w,y,b,M,E;0!==s&&0!==r&&0!==v&&(m=(s*s+r*r+v*v)**-.5,p=h*u-c*l,w=c*h+l*u,y=c*c-.5+u*u,b=(r*=m)*y-(v*=m)*w,M=v*p-(s*=m)*y,E=s*w-r*p,o>0?(d+=o*b*n,f+=o*M*n,g+=o*E*n,e+=d,t+=f,i+=g):(d=0,f=0,g=0),e+=a*b,t+=a*M,i+=a*E);const D=c,S=h,C=l;c+=-S*(e*=.5*n)-C*(t*=.5*n)-u*(i*=.5*n),h+=D*e+C*i-u*t,l+=D*t-S*i+u*e,u+=D*i+S*t-C*e,m=(c*c+h*h+l*l+u*u)**-.5,c*=m,h*=m,l*=m,u*=m}(e,t,i,s,v,p);0!==s&&0!==v&&0!==p&&(E=(s*s+v*v+p*p)**-.5,s*=E,v*=E,p*=E,E=(w*w+y*y+b*b)**-.5,D=c*c,S=c*h,C=c*l,x=c*u,k=h*h,W=h*l,A=h*u,I=l*l,R=l*u,L=u*u,T=2*((w*=E)*(.5-I-L)+(y*=E)*(W-x)+(b*=E)*(A+C)),$=2*(w*(W+x)+y*(.5-k-L)+b*(R-S)),O=Math.sqrt(T*T+$*$),U=2*(w*(A-C)+y*(R+S)+b*(.5-k-I)),G=A-C,B=S+R,F=D-.5+L,N=O*(.5-I-L)+U*(A-C),z=O*(W-x)+U*(S+R),j=O*(C+A)+U*(.5-k-I),V=v*F-p*B+(y*j-b*z),_=p*G-s*F+(b*N-w*j),P=s*B-v*G+(w*z-y*N),o>0?(d+=o*V*n,f+=o*_*n,g+=o*P*n,e+=d,t+=f,i+=g):(d=0,f=0,g=0),e+=a*V,t+=a*_,i+=a*P);const q=c,Q=h,X=l;c+=-Q*(e*=.5*n)-X*(t*=.5*n)-u*(i*=.5*n),h+=q*e+X*i-u*t,l+=q*t-Q*i+u*e,u+=q*i+Q*t-X*e,E=(c*c+h*h+l*l+u*u)**-.5,c*=E,h*=E,l*=E,u*=E},init:m,getQuaternion:()=>({w:c,x:h,y:l,z:u})}})}function ze(){return Fe?Be:(Fe=1,Be=function(e,t){const i=1e3/e;let s=(t=t||{}).beta||.4,n=!0!==t.doInitialisation,r=1,a=0,o=0,c=0,h=1/i;function l(e,t,i,s,n,r){return{x:t*r-i*n,y:i*s-e*r,z:e*n-t*s}}function u(e,t,i,s,h,u){const d=function(e,t,i,s,n,r){const a=-Math.atan2(e,Math.sqrt(t*t+i*i)),o=l(e,t,i,1,0,0),c=l(1,0,0,o.x,o.y,o.z),h=Math.atan2(c.y,c.z),u=Math.cos(h),d=Math.sin(a),f=Math.sin(h),g=n*u-r*f,v=s*Math.cos(a)+n*f*d+r*u*d;return{heading:-Math.atan2(g,v),pitch:a,roll:h}}(e,t,i,s,h,u),f=function(e){const t=Math.cos(.5*e.heading),i=Math.sin(.5*e.heading),s=Math.cos(.5*e.pitch),n=Math.sin(.5*e.pitch),r=Math.cos(.5*e.roll),a=Math.sin(.5*e.roll);return{w:r*s*t+a*n*i,x:a*s*t-r*n*i,y:r*n*t+a*s*i,z:r*s*i-a*n*t}}(d),g=(f.w*f.w+f.x*f.x+f.y*f.y+f.z*f.z)**-.5;r=f.w*g,a=f.x*g,o=f.y*g,c=f.z*g,n=!0}return{update:function(e,t,i,l,d,f,g,v,m,p){let w,y,b,M,E,D,S,C,x,k,W,A,I,R,L,T,$,O,U,G,B,F,N,z,j,V,_,P,q,Q,X,J,K,H,Y;h=p||h,n||u(l,d,f,g,v,m),void 0===g||void 0===v||void 0===m||0===g&&0===v&&0===m?function(e,t,i,n,l,u){let d,f,g,v,m,p,w,y,b,M,E,D,S,C,x,k,W,A,I,R,L,T;p=.5*(-a*e-o*t-c*i),w=.5*(r*e+o*i-c*t),y=.5*(r*t-a*i+c*e),b=.5*(r*i+a*t-o*e),0===n&&0===l&&0===u||(d=(n*n+l*l+u*u)**-.5,M=2*r,E=2*a,D=2*o,S=2*c,C=4*r,x=4*a,k=4*o,W=8*a,A=8*o,I=r*r,R=a*a,L=o*o,T=c*c,f=C*L+D*(n*=d)+C*R-E*(l*=d),g=x*T-S*n+4*I*a-M*l-x+W*R+W*L+x*(u*=d),v=4*I*o+M*n+k*T-S*l-k+A*R+A*L+k*u,m=4*R*c-E*n+4*L*c-D*l,d=(f*f+g*g+v*v+m*m)**-.5,f*=d,g*=d,v*=d,m*=d,p-=s*f,w-=s*g,y-=s*v,b-=s*m),r+=p*h,a+=w*h,o+=y*h,c+=b*h,d=(r*r+a*a+o*o+c*c)**-.5,r*=d,a*=d,o*=d,c*=d}(e,t,i,l,d,f):(D=.5*(-a*e-o*t-c*i),S=.5*(r*e+o*i-c*t),C=.5*(r*t-a*i+c*e),x=.5*(r*i+a*t-o*e),0===l&&0===d&&0===f||(w=(l*l+d*d+f*f)**-.5,l*=w,d*=w,f*=w,w=(g*g+v*v+m*m)**-.5,A=2*r*(g*=w),I=2*r*(v*=w),R=2*r*(m*=w),L=2*a*g,G=2*r,B=2*a,F=2*o,N=2*c,z=2*r*o,j=2*o*c,V=r*r,_=r*a,P=r*o,q=r*c,Q=a*a,X=a*o,J=a*c,K=o*o,H=o*c,Y=c*c,k=g*V-I*c+R*o+g*Q+B*v*o+B*m*c-g*K-g*Y,W=A*c+v*V-R*a+L*o-v*Q+v*K+F*m*c-v*Y,T=Math.sqrt(k*k+W*W),$=-A*o+I*a+m*V+L*c-m*Q+F*v*c-m*K+m*Y,O=2*T,U=2*$,y=-F*(2*J-z-l)+B*(2*_+j-d)-$*o*(T*(.5-K-Y)+$*(J-P)-g)+(-T*c+$*a)*(T*(X-q)+$*(_+H)-v)+T*o*(T*(P+J)+$*(.5-Q-K)-m),b=N*(2*J-z-l)+G*(2*_+j-d)-4*a*(1-2*Q-2*K-f)+$*c*(T*(.5-K-Y)+$*(J-P)-g)+(T*o+$*r)*(T*(X-q)+$*(_+H)-v)+(T*c-U*a)*(T*(P+J)+$*(.5-Q-K)-m),M=-G*(2*J-z-l)+N*(2*_+j-d)-4*o*(1-2*Q-2*K-f)+(-O*o-$*r)*(T*(.5-K-Y)+$*(J-P)-g)+(T*a+$*c)*(T*(X-q)+$*(_+H)-v)+(T*r-U*o)*(T*(P+J)+$*(.5-Q-K)-m),E=B*(2*J-z-l)+F*(2*_+j-d)+(-O*c+$*a)*(T*(.5-K-Y)+$*(J-P)-g)+(-T*r+$*o)*(T*(X-q)+$*(_+H)-v)+T*a*(T*(P+J)+$*(.5-Q-K)-m),w=(y*y+b*b+M*M+E*E)**-.5,y*=w,b*=w,M*=w,E*=w,D-=s*y,S-=s*b,C-=s*M,x-=s*E),r+=D*h,a+=S*h,o+=C*h,c+=x*h,w=(r*r+a*a+o*o+c*c)**-.5,r*=w,a*=w,o*=w,c*=w)},init:u,getQuaternion:()=>({w:r,x:a,y:o,z:c})}})}const je=180/Math.PI;function Ve(e){const t=(e=e||{}).sampleInterval||20,i=e.algorithm||"Madgwick";let s;if("Mahony"===i)s=Ne();else{if("Madgwick"!==i)throw new Error(`AHRS(): Algorithm not valid: ${i}`);s=ze()}const n=s(t,e),r=this;Object.keys(n).forEach((e=>r[e]=n[e]))}Ve.prototype.toVector=function(){const e=this.getQuaternion(),t=2*Math.acos(e.w),i=Math.sin(t/2);return{angle:t,x:e.x/i,y:e.y/i,z:e.z/i}},Ve.prototype.getEulerAngles=function(){const e=this.getQuaternion(),t=e.w*e.w,i=e.x*e.x,s=e.y*e.y,n=e.z*e.z;return{heading:Math.atan2(2*(e.x*e.y+e.z*e.w),i-s-n+t),pitch:-Math.asin(2*(e.x*e.z-e.y*e.w)),roll:Math.atan2(2*(e.y*e.z+e.x*e.w),-i-s+n+t)}},Ve.prototype.getEulerAnglesDegrees=function(){const e=this.getEulerAngles();return{heading:e.heading*je,pitch:e.pitch*je,roll:e.roll*je}};var _e,Pe=(_e=Ve)&&_e.__esModule&&Object.prototype.hasOwnProperty.call(_e,"default")?_e.default:_e;const qe=Math.PI/180;function Qe(e){return e*qe}var Xe,Je,Ke,He,Ye,Ze,et;const tt=k("RawSensorManager"),it=["rawSensor"],st=[...it,"imu","device","orientation"];class nt{constructor(){Xe.add(this),Ke.set(this,new Pe({sampleInterval:18,algorithm:"Madgwick"})),He.set(this,0),this.calculateOrientation=!1,X(this)}parseMessage(e,i){if(tt.log({messageType:e}),"rawSensor"!==e)throw Error(`uncaught messageType ${e}`);t(this,Xe,"m",Ye).call(this,i)}clear(){i(this,He,0,"f")}}var rt,at,ot;Ke=new WeakMap,He=new WeakMap,Xe=new WeakSet,Je=function(){return this.eventDispatcher.dispatchEvent},Ye=function(e){tt.log("parsing whole",e);let i=0;for(;i+4<e.byteLength;){const s=e.getUint32(0,!0);i+=4,tt.log({rawValue:s});const n=(2147483648&s)>>31,r=2147483647&s;if(tt.log({firstBit:n,timestamp:r}),0==r)break;const a=0==n?"imu":"device";tt.log({sensorDataType:a});const o=We[a];if(tt.log({sensorDataLength:o}),0==o)break;const c=Oe(e,i,o);c.byteLength==o&&t(this,Xe,"m",Ze).call(this,a,r,c),i+=o}},Ze=function(e,s,n){tt.log(`parsing ${e} ${s}ms`,n);let r="device"==e?"deviceAccelerometer":"imuGyroscope";const a=[];for(let t=0;t<n.byteLength;t+=6){const i=this.sensitivity[r],s=xe[r][i],[o,c,h]=[-n.getInt16(t+0,!0),n.getInt16(t+2,!0),n.getInt16(t+4,!0)].map((e=>e*s*.001));tt.log({x:h,y:c,z:o});const l={x:h,y:c,z:o};tt.log("vector",l),a.push(l),"imu"==e&&(r="imuAccelerometer")}let o=0;switch(e){case"imu":o=2;break;case"device":o=5}if(a.length!=o)return void tt.log(`invalid number of ${e} vectors (expected ${o}, get ${a.length})`);const c={sensorDataType:e,timestamp:s};switch(c.sensorDataType){case"imu":if(c.accelerometer=a[Ie.indexOf("accelerometer")],c.gyroscope=a[Ie.indexOf("gyroscope")],this.calculateOrientation&&t(this,He,"f")!=s){i(this,He,s,"f");const e=0==t(this,He,"f")?55:s-t(this,He,"f");t(this,Xe,"m",et).call(this,c.accelerometer,c.gyroscope,e);const n=t(this,Ke,"f").getQuaternion(),r=t(this,Ke,"f").getEulerAngles();t(this,Xe,"a",Je).call(this,"orientation",{quaternion:n,euler:r,timestamp:s})}break;case"device":c.fingers={},Re.forEach(((e,t)=>{c.fingers[e]=a[t]}))}t(this,Xe,"a",Je).call(this,e,c),t(this,Xe,"a",Je).call(this,"rawSensor",c)},et=function(e,i,s){tt.log("updating ahrs..."),t(this,Ke,"f").update(Qe(i.x),Qe(i.y),Qe(i.z),e.x,e.y,e.z,void 0,void 0,void 0,s/1e3)};const ct=k("TxManager"),ht=["tx",...it],lt=[...st];class ut{get eventDispatcher(){return t(this,at,"f")}set eventDispatcher(e){i(this,at,e,"f"),t(this,ot,"f").eventDispatcher=e}set rawSensorSensitivity(e){t(this,ot,"f").sensitivity=e}constructor(){rt.add(this),at.set(this,void 0),ot.set(this,new nt),X(this)}parseMessage(e,i){if(ct.log({messageType:e}),"tx"!==e)throw Error(`uncaught messageType ${e}`);t(this,ot,"f").parseMessage("rawSensor",i)}get calculateOrientation(){return t(this,ot,"f").calculateOrientation}set calculateOrientation(e){t(this,ot,"f").calculateOrientation=e}clear(){t(this,ot,"f").clear()}}var dt,ft,gt,vt,mt,pt,wt,yt,bt;at=new WeakMap,ot=new WeakMap,rt=new WeakSet;const Mt=k("BaseConnectionManager",{log:!0}),Et=["notConnected","connecting","connected","disconnecting"],Dt=[...Et,"connectionStatus","isConnected"];class St{get baseConstructor(){return this.constructor}static get isSupported(){return!1}get isSupported(){return this.baseConstructor.isSupported}get type(){return this.baseConstructor.type}constructor(){dt.add(this),gt.set(this,"notConnected"),yt.set(this,new $(t(this,dt,"m",bt).bind(this),5e3)),t(this,dt,"m",ft).call(this)}get status(){return t(this,gt,"f")}set status(e){Mt.assertEnumWithError(e,Et),t(this,gt,"f")!=e?(Mt.log(`new connection status "${e}"`),i(this,gt,e,"f"),this.onStatusUpdated(this.status),this.isConnected?t(this,yt,"f").start():t(this,yt,"f").stop()):Mt.log(`tried to assign same connection status "${e}"`)}get isConnected(){return"connected"==this.status}async connect(){t(this,dt,"m",vt).call(this),t(this,dt,"m",mt).call(this),this.status="connecting"}get canReconnect(){return!1}async reconnect(){t(this,dt,"m",vt).call(this),t(this,dt,"m",mt).call(this),Mt.assert(this.canReconnect,"unable to reconnect")}async disconnect(){t(this,dt,"m",pt).call(this),t(this,dt,"m",wt).call(this),this.status="disconnecting",Mt.log("disconnecting from device...")}async sendUICommandsData(e){Mt.log("sendUICommandsData",e)}async sendRxData(e){Mt.log("sendRxData",e)}}gt=new WeakMap,yt=new WeakMap,dt=new WeakSet,ft=function(){Mt.assertWithError(this.isSupported,`${this.constructor.name} is not supported`)},vt=function(){Mt.assertWithError(!this.isConnected,"device is already connected")},mt=function(){Mt.assertWithError("connecting"!=this.status,"device is already connecting")},pt=function(){Mt.assertWithError(this.isConnected,"device is not connected")},wt=function(){Mt.assertWithError("disconnecting"!=this.status,"device is already disconnecting")},bt=function(){this.isConnected||(Mt.log("timer detected disconnection"),this.status="notConnected")};const Ct=k("EventUtils",{log:!1});function xt(e,t){let i=e.addEventListener||e.addListener||e.on||e.AddEventListener;Ct.assertWithError(i,"no add listener function found for target"),i=i.bind(e),Object.entries(t).forEach((([e,t])=>{i(e,t)}))}function kt(e,t){let i=e.removeEventListener||e.removeListener||e.RemoveEventListener;Ct.assertWithError(i,"no remove listener function found for target"),i=i.bind(e),Object.entries(t).forEach((([e,t])=>{i(e,t)}))}const Wt=k("bluetoothUUIDs",{log:!1});if(n)var At=window.BluetoothUUID;function It(e){return Wt.assertTypeWithError(e,"string"),Wt.assertWithError(1==e.length,"value must be 1 character long"),`C3FF000${e}-1D8B-40FD-A56F-C7BD5D0F3370`.toLowerCase()}function Rt(e){return Wt.assertTypeWithError(e,"string"),Wt.assertWithError(1==e.length,"value must be 1 character long"),`6E40000${e}-B5A3-F393-E0A9-E50E24DCCA9E`.toLowerCase()}function Lt(e){return At?.getCharacteristic?.(e)}function Tt(e){return At?.getService?.(e)}const $t=Object.freeze({services:{deviceInformation:{uuid:Tt("device_information"),characteristics:{manufacturerName:{uuid:Lt("manufacturer_name_string")},modelNumber:{uuid:Lt("model_number_string")},hardwareRevision:{uuid:Lt("hardware_revision_string")},firmwareRevision:{uuid:Lt("firmware_revision_string")},softwareRevision:{uuid:Lt("software_revision_string")},pnpId:{uuid:Lt("pnp_id")},serialNumber:{uuid:Lt("serial_number_string")}}},battery:{uuid:Tt("battery_service"),characteristics:{batteryLevel:{uuid:Lt("battery_level")}}},tap:{uuid:It("1"),characteristics:{tapData:{uuid:It("5")},mouseData:{uuid:It("6")},airGesture:{uuid:It("A")},uiCommands:{uuid:It("9")},settings:{uuid:It("2")},unknown3:{uuid:It("3")},unknown7:{uuid:It("7")},unknown8:{uuid:It("8")},unknownB:{uuid:It("B")},unknownC:{uuid:It("C")},unknownD:{uuid:It("D")}}},nus:{uuid:Rt("1"),characteristics:{rx:{uuid:Rt("2")},tx:{uuid:Rt("3")}}}}}),Ot=[$t.services.tap.uuid],Ut=[$t.services.deviceInformation.uuid,$t.services.battery.uuid,$t.services.nus.uuid];function Gt(e){e=e.toString().toLowerCase();return Object.keys($t.services).find((t=>{let i=$t.services[t].uuid.toString();return 4==e.length&&(i=i.slice(4,8)),e.includes("-")||(i=i.replaceAll("-","")),e==i}))}const Bt=[],Ft=[];function Nt(e){var t;return e=e.toString().toLowerCase(),Object.values($t.services).some((i=>{const s=Object.keys(i.characteristics);return t=s.find((t=>{let s=i.characteristics[t].uuid.toString();return 4==e.length&&(s=s.slice(4,8)),e.includes("-")||(s=s.replaceAll("-","")),e==s}))})),t}function zt(e){const t={broadcast:!1,read:!0,writeWithoutResponse:!1,write:!1,notify:!1,indicate:!1,authenticatedSignedWrites:!1,reliableWrite:!1,writableAuxiliaries:!1};switch(e){case"settings":case"tapData":case"mouseData":case"unknown7":case"unknown8":t.read=!1}switch(e){case"batteryLevel":case"tapData":case"mouseData":case"airGesture":case"unknown8":case"unknownB":case"unknownC":case"unknownD":case"tx":t.notify=!0}switch(e){case"airGesture":case"uiCommands":case"unknown7":case"unknownB":t.writeWithoutResponse=!0}switch(e){case"settings":case"unknown3":case"unknown7":case"rx":t.write=!0}return t}Object.values($t.services).forEach((e=>{if(!e.characteristics)return;const t=Object.keys(e.characteristics);t.forEach((i=>{const s=e.characteristics[i];Ot.includes(e.uuid)&&(Bt.push(s.uuid),t.push(i)),Ft.push(s.uuid)}))}),[]),Wt.log({serviceUUIDs:Ot,optionalServiceUUIDs:Ut,characteristicUUIDs:Bt,allCharacteristicUUIDs:Ft});const jt=k("BluetoothConnectionManager",{log:!0});class Vt extends St{constructor(){super(...arguments),this.isInRange=!0}onCharacteristicValueChanged(e,t){switch(e){case"batteryLevel":case"firmwareRevision":case"hardwareRevision":case"manufacturerName":case"modelNumber":case"pnpId":case"serialNumber":case"softwareRevision":case"tapData":case"mouseData":case"airGesture":case"tx":this.onMessageReceived?.(e,t)}}async writeCharacteristic(e,t){jt.log("writeCharacteristic",...arguments)}async sendUICommandsData(e){super.sendUICommandsData(e),await this.writeCharacteristic("uiCommands",e)}async sendRxData(e){super.sendRxData(e),await this.writeCharacteristic("rx",e)}}var _t,Pt,qt,Qt,Xt,Jt,Kt,Ht,Yt,Zt,ei;const ti=k("WebBluetoothConnectionManager",{log:!0});var ii,si,ni;n&&(ii=window.navigator.bluetooth);class ri extends Vt{constructor(){super(...arguments),_t.add(this),Pt.set(this,{characteristicvaluechanged:t(this,_t,"m",Yt).bind(this)}),qt.set(this,{gattserverdisconnected:t(this,_t,"m",ei).bind(this)}),Qt.set(this,void 0),Xt.set(this,new Map),Jt.set(this,new Map)}get bluetoothId(){return this.device?.id||""}get name(){return this.device?.name||""}static get isSupported(){return Boolean(ii)}static get type(){return"webBluetooth"}get device(){return t(this,Qt,"f")}set device(e){t(this,Qt,"f")!=e?(t(this,Qt,"f")&&kt(t(this,Qt,"f"),t(this,qt,"f")),e&&xt(e,t(this,qt,"f")),i(this,Qt,e,"f")):ti.log("tried to assign the same BluetoothDevice")}get server(){return t(this,Qt,"f")?.gatt}get isConnected(){return this.server?.connected||!1}async connect(){await super.connect();try{const e=await ii.requestDevice({filters:[{services:Ot}],optionalServices:n?Ut:[]});ti.log("got BluetoothDevice"),this.device=e,ti.log("connecting to device...");const i=await this.server.connect();ti.log(`connected to device? ${i.connected}`),await t(this,_t,"m",Kt).call(this),ti.log("fully connected"),this.status="connected"}catch(e){ti.error(e),this.status="notConnected",this.server?.disconnect(),t(this,_t,"m",Ht).call(this)}}async disconnect(){await t(this,_t,"m",Ht).call(this),await super.disconnect(),this.server?.disconnect(),this.status="notConnected"}async writeCharacteristic(e,i){super.writeCharacteristic(e,i);const s=t(this,Jt,"f").get(e);ti.assertWithError(s,`${e} characteristic not found`),ti.log("writing characteristic",s,i);const n=s.properties||zt(e);n.writeWithoutResponse?(ti.log("writing without response"),await s.writeValueWithoutResponse(i)):(ti.log("writing with response"),await s.writeValueWithResponse(i)),ti.log("wrote characteristic"),n.read&&!n.notify&&(ti.log("reading value after write..."),await s.readValue(),(c||h)&&t(this,_t,"m",Zt).call(this,s))}get canReconnect(){return Boolean(this.server&&!this.server.connected&&this.isInRange)}async reconnect(){await super.reconnect(),ti.log("attempting to reconnect..."),this.status="connecting";try{await this.server.connect()}catch(e){ti.error(e),this.isInRange=!1}this.isConnected?(ti.log("successfully reconnected!"),await t(this,_t,"m",Kt).call(this),this.status="connected"):(ti.log("unable to reconnect"),this.status="notConnected")}}function ai(e,t=0,i=1){return Math.max(t,Math.min(i,e))}Pt=new WeakMap,qt=new WeakMap,Qt=new WeakMap,Xt=new WeakMap,Jt=new WeakMap,_t=new WeakSet,Kt=async function(){t(this,_t,"m",Ht).call(this),ti.log("getting services...");const e=await this.server.getPrimaryServices();ti.log("got services",e);const i=await this.server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");ti.log("got nus service",i),ti.log("getting characteristics...");for(const i in e){const s=e[i];ti.log({service:s});const n=Gt(s.uuid);ti.assertWithError(n,`no name found for service uuid "${s.uuid}"`),ti.log(`got "${n}" service`),s.name=n,t(this,Xt,"f").set(n,s),ti.log(`getting characteristics for "${n}" service`);const r=await s.getCharacteristics();ti.log(`got characteristics for "${n}" service`);for(const e in r){const i=r[e];ti.log({characteristic:i});const s=Nt(i.uuid);ti.assertWithError(Boolean(s),`no name found for characteristic uuid "${i.uuid}" in "${n}" service`),ti.log(`got "${s}" characteristic in "${n}" service`),i.name=s,t(this,Jt,"f").set(s,i),xt(i,t(this,Pt,"f"));const a=i.properties||zt(s);a.notify&&(ti.log(`starting notifications for "${s}" characteristic`),await i.startNotifications()),a.read&&(ti.log(`reading "${s}" characteristic...`),await i.readValue(),(c||h)&&t(this,_t,"m",Zt).call(this,i))}}},Ht=async function(){this.device&&kt(this.device,t(this,qt,"f"));const e=Array.from(t(this,Jt,"f").keys()).map((e=>{const i=t(this,Jt,"f").get(e);kt(i,t(this,Pt,"f"));if((i.properties||zt(e)).notify)return ti.log(`stopping notifications for "${e}" characteristic`),i.stopNotifications()}));return Promise.allSettled(e)},Yt=function(e){ti.log("oncharacteristicvaluechanged");const i=e.target;t(this,_t,"m",Zt).call(this,i)},Zt=function(e){ti.log("onCharacteristicValue");const t=e.name;ti.assertWithError(Boolean(t),`no name found for characteristic with uuid "${e.uuid}"`),ti.log(`oncharacteristicvaluechanged for "${t}" characteristic`);const i=e.value;ti.assertWithError(i,`no data found for "${t}" characteristic`),ti.log(`data for "${t}" characteristic`,Array.from(new Uint8Array(i.buffer)));try{this.onCharacteristicValueChanged(t,i)}catch(e){ti.error(e)}},ei=function(){ti.log("gattserverdisconnected"),this.status="notConnected"},k("MathUtils",{log:!0});const oi=k("VibrationManager");class ci{constructor(){si.add(this),X(this)}async vibrate(e){oi.log("triggering vibration segments",e);const i=t(this,si,"m",ni).call(this,e);await this.sendUICommandsData(i?.buffer)}}var hi,li,ui,di,fi,gi,vi,mi,pi,wi,yi,bi,Mi,Ei,Di,Si;si=new WeakSet,ni=function(e){const t=new DataView(new ArrayBuffer(20));let i=0;t.setUint8(i++,0),t.setUint8(i++,2);for(let i=0;i<e.length&&i<18;i++){let s=e[i];s/=10,s=ai(s,0,255),oi.log(`vibration segment #${i}: ${s}`),t.setUint8(2+i,s)}return t};const Ci=k("DeviceManager",{log:!0}),xi=["deviceConnected","deviceDisconnected","deviceIsConnected","availableDevices","connectedDevices"];class ki{constructor(){if(hi.add(this),li.set(this,{isConnected:t(this,hi,"m",Ei).bind(this)}),ui.set(this,[]),di.set(this,!1),fi.set(this,{devices:[]}),gi.set(this,void 0),mi.set(this,"TS.Device"),yi.set(this,[]),bi.set(this,new A(this,xi)),ki.shared&&this!=ki.shared)throw Error("DeviceManager is a singleton - use DeviceManager.shared");this.CanUseLocalStorage&&(this.UseLocalStorage=!0)}onDevice(e){xt(e,t(this,li,"f"))}OnDeviceConnectionStatusUpdated(e,i){if("notConnected"==i&&!e.canReconnect&&t(this,yi,"f").includes(e)){const i=t(this,yi,"f").indexOf(e);this.AvailableDevices.splice(i,1),t(this,hi,"m",Di).call(this)}}get ConnectedDevices(){return t(this,ui,"f")}get UseLocalStorage(){return t(this,di,"f")}set UseLocalStorage(e){t(this,hi,"m",vi).call(this),Ci.assertTypeWithError(e,"boolean"),i(this,di,e,"f"),t(this,di,"f")&&!t(this,gi,"f")&&t(this,hi,"m",wi).call(this)}get CanUseLocalStorage(){return n&&window.localStorage}get AvailableDevices(){return t(this,yi,"f")}get CanGetDevices(){return n&&navigator.bluetooth?.getDevices}async GetDevices(){if(!n)return void Ci.warn("GetDevices is only available in the browser");if(!navigator.bluetooth)return void Ci.warn("bluetooth is not available in this browser");if(c)return void Ci.warn("bluefy lists too many devices...");if(!navigator.bluetooth.getDevices)return void Ci.warn("bluetooth.getDevices() is not available in this browser");if(!this.CanGetDevices)return void Ci.log("CanGetDevices is false");t(this,gi,"f")||t(this,hi,"m",wi).call(this);const e=t(this,gi,"f");if(!e.devices||0==e.devices.length)return void Ci.log("no devices found in configuration");const i=await navigator.bluetooth.getDevices();return Ci.log({bluetoothDevices:i}),i.forEach((i=>{if(!i.gatt)return;if(!e.devices.find((e=>i.id==e.bluetoothId)))return;let s=this.ConnectedDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==i.id));const n=this.AvailableDevices.filter((e=>"webBluetooth"==e.connectionType)).find((e=>e.bluetoothId==i.id));if(n)return void(s&&s?.bluetoothId==n.bluetoothId&&s!=n&&(this.AvailableDevices[t(this,yi,"f").indexOf(n)]=s));if(s)return void this.AvailableDevices.push(s);const r=new As,a=new ri;a.device=i,i.name,r.connectionManager=a,this.AvailableDevices.push(r)})),t(this,hi,"m",Di).call(this),this.AvailableDevices}get AddEventListener(){return t(this,bi,"f").addEventListener}get RemoveEventListener(){return t(this,bi,"f").removeEventListener}get RemoveEventListeners(){return t(this,bi,"f").removeEventListeners}get RemoveAllEventListeners(){return t(this,bi,"f").removeAllEventListeners}}li=new WeakMap,ui=new WeakMap,di=new WeakMap,fi=new WeakMap,gi=new WeakMap,mi=new WeakMap,yi=new WeakMap,bi=new WeakMap,hi=new WeakSet,vi=function(){Ci.assertWithError(n,"localStorage is only available in the browser"),Ci.assertWithError(window.localStorage,"localStorage not found")},pi=function(){t(this,hi,"m",vi).call(this),localStorage.setItem(t(this,mi,"f"),JSON.stringify(t(this,gi,"f")))},wi=async function(){t(this,hi,"m",vi).call(this);let e=localStorage.getItem(t(this,mi,"f"));if("string"!=typeof e)return Ci.log("no info found in localStorage"),i(this,gi,Object.assign({},t(this,fi,"f")),"f"),void t(this,hi,"m",pi).call(this);try{const t=JSON.parse(e);Ci.log({configuration:t}),i(this,gi,t,"f"),this.CanGetDevices&&await this.GetDevices()}catch(e){Ci.error(e)}},Mi=function(){return t(this,bi,"f").dispatchEvent},Ei=function(e){const{target:i}=e;if(i.isConnected)if(t(this,ui,"f").includes(i))Ci.log("device already included");else{if(Ci.log("adding device",i),t(this,ui,"f").push(i),this.UseLocalStorage&&"webBluetooth"==i.connectionType){const e={bluetoothId:i.bluetoothId},s=t(this,gi,"f").devices.findIndex((t=>t.bluetoothId==e.bluetoothId));-1==s?t(this,gi,"f").devices.push(e):t(this,gi,"f").devices[s]=e,t(this,hi,"m",pi).call(this)}t(this,hi,"a",Mi).call(this,"deviceConnected",{device:i}),t(this,hi,"a",Mi).call(this,"deviceIsConnected",{device:i}),t(this,hi,"m",Si).call(this)}else t(this,ui,"f").includes(i)?(Ci.log("removing device",i),t(this,ui,"f").splice(t(this,ui,"f").indexOf(i),1),t(this,hi,"a",Mi).call(this,"deviceDisconnected",{device:i}),t(this,hi,"a",Mi).call(this,"deviceIsConnected",{device:i}),t(this,hi,"m",Si).call(this)):Ci.log("device already not included");if(this.CanGetDevices&&this.GetDevices(),i.isConnected&&!this.AvailableDevices.includes(i)){const e=this.AvailableDevices.find((e=>e.bluetoothId==i.bluetoothId));Ci.log({existingAvailableDevice:e}),e?this.AvailableDevices[this.AvailableDevices.indexOf(e)]=i:this.AvailableDevices.push(i),t(this,hi,"m",Di).call(this)}},Di=function(){Ci.log({AvailableDevices:this.AvailableDevices}),t(this,hi,"a",Mi).call(this,"availableDevices",{availableDevices:this.AvailableDevices})},Si=function(){Ci.log({ConnectedDevices:this.ConnectedDevices}),t(this,hi,"a",Mi).call(this,"connectedDevices",{connectedDevices:this.ConnectedDevices})},ki.shared=new ki;var Wi,Ai,Ii,Ri,Li,Ti,$i,Oi=ki.shared;const Ui=k("InputManager"),Gi=["controller","text","rawSensor","controllerWithMouse","controllerWithMouseAndKeyboard"],Bi={controller:1,text:0,rawSensor:10,controllerWithMouse:3,controllerWithMouseAndKeyboard:5};class Fi{constructor(){Wi.add(this),Ai.set(this,Object.assign({},ke)),Ii.set(this,"controller"),Ti.set(this,new $(t(this,Wi,"m",$i).bind(this),1e4)),X(this)}get sensitivity(){return t(this,Ai,"f")}set sensitivity(e){Object.assign(t(this,Ai,"f"),e)}setSensitivityForType(e,i){Ae(e,i),Ui.log(`setting ${e} sensitivity index to ${i}`),t(this,Ai,"f")[e]=i,t(this,Ti,"f").restart(!0)}get mode(){return t(this,Ii,"f")}set mode(e){t(this,Wi,"m",Ri).call(this,e),this.mode!=e?(i(this,Ii,e,"f"),t(this,Ti,"f").isRunning&&t(this,Ti,"f").restart(!0)):Ui.log(`redundant mode assignment "${e}"`)}setMode(e){this.mode=e}start(){t(this,Ti,"f").start(!0)}stop(){t(this,Ti,"f").stop()}}var Ni,zi,ji,Vi,_i,Pi;Ai=new WeakMap,Ii=new WeakMap,Ti=new WeakMap,Wi=new WeakSet,Ri=function(e){Ui.assertEnumWithError(e,Gi)},Li=function(){const e=Bi[this.mode];let t=[];var i;"rawSensor"==this.mode&&(Ui.assertWithError(this.sensitivity,"no sensitivity defined for rawSensor input mode"),i=this.sensitivity,Ce.forEach((e=>{Ae(e,i[e])})),Ce.forEach((e=>{t.push(this.sensitivity[e])})));return Te(3,12,0,e,...t)},$i=function(){Ui.log("sending mode data...");const e=t(this,Wi,"m",Li).call(this);this.sendRxData(e)};const qi=k("XRStateManager"),Qi=["user","airMouse","tapping","dontSend"],Xi={user:3,airMouse:1,tapping:2};class Ji{constructor(){Ni.add(this),zi.set(this,"user"),_i.set(this,new $(t(this,Ni,"m",Pi).bind(this),1e4)),X(this)}get state(){return t(this,zi,"f")}set state(e){t(this,Ni,"m",ji).call(this,e),this.state!=e?(i(this,zi,e,"f"),t(this,_i,"f").isRunning&&t(this,_i,"f").restart(!0)):qi.log(`redundant state assignment "${e}"`)}setState(e){this.state=e}start(){t(this,_i,"f").start(!0)}stop(){t(this,_i,"f").stop()}}var Ki,Hi,Yi,Zi,es,ts,is,ss,ns,rs,as,os,cs,hs,ls,us,ds,fs,gs,vs,ms,ps,ws,ys,bs,Ms,Es,Ds,Ss,Cs,xs;zi=new WeakMap,_i=new WeakMap,Ni=new WeakSet,ji=function(e){qi.assertEnumWithError(e,Qi)},Vi=function(){const e=Xi[this.state];qi.assert(null!=e,`no stateByte found for state "${this.state}"`);return Te(3,13,0,e)},Pi=function(){if("dontSend"==this.state)return;qi.log("sending state data...");const e=t(this,Ni,"m",Vi).call(this);this.sendRxData(e)};const ks=k("Device",{log:!0}),Ws=["connectionMessage",...Dt,"batteryLevel",...q,...ne,...de,...Ee,...lt];class As{get bluetoothId(){return t(this,ts,"f")?.bluetoothId}get name(){return t(this,ts,"f")?.name}constructor(){Ki.add(this),Zi.set(this,new A(this,Ws)),ts.set(this,void 0),this.sendUICommandsData=t(this,Ki,"m",is).bind(this),this.sendRxData=t(this,Ki,"m",ss).bind(this),ns.set(this,!1),cs.set(this,Hi.ReconnectOnDisconnection),hs.set(this,void 0),this.latestConnectionMessage=new Map,ms.set(this,new Q),ps.set(this,0),ys.set(this,new Fi),bs.set(this,new Ji),Ms.set(this,new ae),Es.set(this,new fe),Ds.set(this,new De),Ss.set(this,new ut),Cs.set(this,new ci),xs.set(this,!1),t(this,ms,"f").eventDispatcher=t(this,Zi,"f"),t(this,ys,"f").sendRxData=this.sendRxData,t(this,bs,"f").sendRxData=this.sendRxData,t(this,Ms,"f").eventDispatcher=t(this,Zi,"f"),t(this,Es,"f").eventDispatcher=t(this,Zi,"f"),t(this,Ds,"f").eventDispatcher=t(this,Zi,"f"),t(this,Ss,"f").eventDispatcher=t(this,Zi,"f"),t(this,Cs,"f").sendUICommandsData=this.sendUICommandsData,t(this,Ss,"f").rawSensorSensitivity=t(this,ys,"f").sensitivity,this.addEventListener("hardwareRevision",(()=>{})),this.addEventListener("isInAirGestureState",(e=>{t(this,Ms,"f").isInAirGestureState=e.message.isInAirGestureState})),this.addEventListener("isConnected",(()=>{this.isConnected?(setTimeout((()=>{t(this,ys,"f").start()}),0),setTimeout((()=>{}),20)):(t(this,ys,"f").stop(),t(this,bs,"f").stop())})),Oi.onDevice(this),n&&window.addEventListener("beforeunload",(()=>{this.isConnected})),r&&process.on("exit",(()=>{this.isConnected}))}get addEventListener(){return t(this,Zi,"f").addEventListener}get removeEventListener(){return t(this,Zi,"f").removeEventListener}get waitForEvent(){return t(this,Zi,"f").waitForEvent}get removeEventListeners(){return t(this,Zi,"f").removeEventListeners}get removeAllEventListeners(){return t(this,Zi,"f").removeAllEventListeners}get connectionManager(){return t(this,ts,"f")}set connectionManager(e){this.connectionManager!=e?(this.connectionManager&&(this.connectionManager.onStatusUpdated=void 0,this.connectionManager.onMessageReceived=void 0,this.connectionManager.onMessagesReceived=void 0),e&&(e.onStatusUpdated=t(this,Ki,"m",ls).bind(this),e.onMessageReceived=t(this,Ki,"m",gs).bind(this),e.onMessagesReceived=t(this,Ki,"m",vs).bind(this)),i(this,ts,e,"f"),ks.log("assigned new connectionManager",t(this,ts,"f"))):ks.log("same connectionManager is already assigned")}async connect(){return this.connectionManager||(this.connectionManager=t(Hi,Hi,"m",Yi).call(Hi)),t(this,Ki,"m",fs).call(this),this.connectionManager.connect()}get isConnected(){return t(this,ns,"f")}get canReconnect(){return this.connectionManager?.canReconnect}async reconnect(){return t(this,Ki,"m",as).call(this),t(this,Ki,"m",fs).call(this),this.connectionManager?.reconnect()}static async Connect(){const e=new Hi;return await e.connect(),e}static get ReconnectOnDisconnection(){return t(this,Hi,"f",os)}static set ReconnectOnDisconnection(e){ks.assertTypeWithError(e,"boolean"),i(this,Hi,e,"f",os)}get reconnectOnDisconnection(){return t(this,cs,"f")}set reconnectOnDisconnection(e){ks.assertTypeWithError(e,"boolean"),i(this,cs,e,"f")}get connectionType(){return this.connectionManager?.type}async disconnect(){return t(this,Ki,"m",rs).call(this),this.reconnectOnDisconnection&&(this.reconnectOnDisconnection=!1,this.addEventListener("isConnected",(()=>{this.reconnectOnDisconnection=!0}),{once:!0})),this.connectionManager.disconnect()}toggleConnection(){this.isConnected?this.disconnect():this.canReconnect?this.reconnect():this.connect()}get connectionStatus(){switch(t(this,ts,"f")?.status){case"connected":return this.isConnected?"connected":"connecting";case"notConnected":case"connecting":case"disconnecting":return t(this,ts,"f").status;default:return"notConnected"}}get isConnectionBusy(){return"connecting"==this.connectionStatus||"disconnecting"==this.connectionStatus}get deviceInformation(){return t(this,ms,"f").information}get batteryLevel(){return t(this,ps,"f")}get inputMode(){return t(this,ys,"f").mode}set inputMode(e){this.setInputMode(e)}get setInputMode(){return t(this,ys,"f").setMode}get setSensitivityForType(){return t(this,ys,"f").setSensitivityForType}get xrState(){return t(this,bs,"f").state}set xrState(e){this.setXRState(e)}get setXRState(){return t(this,bs,"f").setState}get xrAirGestureMinCount(){return t(this,Ds,"f").xrAirGestureMinCount}set xrAirGestureMinCount(e){t(this,Ds,"f").xrAirGestureMinCount=e}get calculateOrientation(){return t(this,Ss,"f").calculateOrientation}set calculateOrientation(e){t(this,Ss,"f").calculateOrientation=e}get vibrate(){return t(this,Cs,"f").vibrate}get isServerSide(){return t(this,xs,"f")}set isServerSide(e){t(this,xs,"f")!=e?(ks.log({newIsServerSide:e}),i(this,xs,e,"f")):ks.log("redundant isServerSide assignment")}}var Is,Rs,Ls;Hi=As,Zi=new WeakMap,ts=new WeakMap,ns=new WeakMap,cs=new WeakMap,hs=new WeakMap,ms=new WeakMap,ps=new WeakMap,ys=new WeakMap,bs=new WeakMap,Ms=new WeakMap,Es=new WeakMap,Ds=new WeakMap,Ss=new WeakMap,Cs=new WeakMap,xs=new WeakMap,Ki=new WeakSet,Yi=function(){return new ri},es=function(){return t(this,Zi,"f").dispatchEvent},is=async function(e){await(t(this,ts,"f")?.sendUICommandsData(e))},ss=async function(e){await(t(this,ts,"f")?.sendRxData(e))},rs=function(){ks.assertWithError(this.isConnected,"notConnected")},as=function(){ks.assertWithError(this.canReconnect,"cannot reconnect to device")},ls=function(e){ks.log({connectionStatus:e}),"notConnected"==e?this.canReconnect&&this.reconnectOnDisconnection&&(ks.log("starting reconnect interval..."),i(this,hs,setInterval((()=>{ks.log("attempting reconnect..."),this.reconnect()}),1e3),"f")):null!=t(this,hs,"f")&&(ks.log("clearing reconnect interval"),clearInterval(t(this,hs,"f")),i(this,hs,void 0,"f")),t(this,Ki,"m",ds).call(this),"connected"==e&&t(this,ns,"f"),Oi.OnDeviceConnectionStatusUpdated(this,e)},us=function(e=!1){t(this,Ki,"a",es).call(this,"connectionStatus",{connectionStatus:this.connectionStatus}),t(this,Ki,"a",es).call(this,this.connectionStatus,{}),e&&t(this,Ki,"a",es).call(this,"isConnected",{isConnected:this.isConnected})},ds=function(){switch(i(this,ns,Boolean(this.connectionManager?.isConnected),"f"),this.connectionStatus){case"connected":t(this,ns,"f")&&t(this,Ki,"m",us).call(this,!0);break;case"notConnected":t(this,Ki,"m",us).call(this,!0);break;default:t(this,Ki,"m",us).call(this,!1)}},fs=function(){this.latestConnectionMessage.clear(),t(this,ms,"f").clear(),t(this,Ss,"f").clear()},gs=function(e,i){if(ks.log({messageType:e,dataView:i}),"batteryLevel"===e){const e=i.getUint8(0);ks.log("received battery level",{batteryLevel:e}),t(this,Ki,"m",ws).call(this,e)}else if(P.includes(e))t(this,ms,"f").parseMessage(e,i);else if(se.includes(e))t(this,Ms,"f").parseMessage(e,i);else if(ue.includes(e))t(this,Es,"f").parseMessage(e,i);else if(Me.includes(e))t(this,Ds,"f").parseMessage(e,i);else{if(!ht.includes(e))throw Error(`uncaught messageType "${e}"`);t(this,Ss,"f").parseMessage(e,i)}this.latestConnectionMessage.set(e,i),t(this,Ki,"a",es).call(this,"connectionMessage",{messageType:e,dataView:i})},vs=function(){this.isConnected||t(this,Ki,"m",ds).call(this)},ws=function(e){ks.assertTypeWithError(e,"number"),t(this,ps,"f")!=e?(i(this,ps,e,"f"),ks.log({updatedBatteryLevel:t(this,ps,"f")}),t(this,Ki,"a",es).call(this,"batteryLevel",{batteryLevel:t(this,ps,"f")})):ks.log(`duplicate batteryLevel assignment ${e}`)},os={value:!1};const Ts={min:1/0,max:-1/0,span:0};Rs=new WeakMap,Is=new WeakSet,Ls=function(){t(this,Rs,"f").span=t(this,Rs,"f").max-t(this,Rs,"f").min},e.Device=As,e.DeviceManager=Oi,e.Environment=y,e.InputModes=Gi,e.MaxNumberOfVibrationSegments=18,e.MaxNumberOfVibrations=9,e.RangeHelper=class{constructor(){Is.add(this),Rs.set(this,Object.assign({},Ts))}get min(){return t(this,Rs,"f").min}get max(){return t(this,Rs,"f").max}set min(e){t(this,Rs,"f").min=e,t(this,Rs,"f").max=Math.max(e,t(this,Rs,"f").max),t(this,Is,"m",Ls).call(this)}set max(e){t(this,Rs,"f").max=e,t(this,Rs,"f").min=Math.min(e,t(this,Rs,"f").min),t(this,Is,"m",Ls).call(this)}reset(){Object.assign(t(this,Rs,"f"),Ts)}update(e){t(this,Rs,"f").min=Math.min(e,t(this,Rs,"f").min),t(this,Rs,"f").max=Math.max(e,t(this,Rs,"f").max),t(this,Is,"m",Ls).call(this)}getNormalization(e,i){let s=function(e,t,i,s){return null==s&&(s=i-t),(e-t)/s}(e,t(this,Rs,"f").min,t(this,Rs,"f").max,t(this,Rs,"f").span);return i&&(s*=t(this,Rs,"f").span),s||0}updateAndGetNormalization(e,t){return this.update(e),this.getNormalization(e,t)}},e.RawSensorSensitivityFactors=xe,e.RawSensorTypes=Ce,e.XRStates=Qi,e.setAllConsoleLevelFlags=function(e){x.setAllLevelFlags(e)},e.setConsoleLevelFlagsForType=function(e,t){x.setLevelFlagsForType(e,t)}}));
//# sourceMappingURL=tapstrap.min.js.map
